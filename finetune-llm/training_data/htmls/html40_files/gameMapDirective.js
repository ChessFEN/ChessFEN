"use strict";angular.module("chessStories").directive("appGameMap",["graphService",function(e){return{restrict:"EA",scope:!1,template:'\n  <div class="game-map-cont">\n    <div class="clk fold-btn"\n         ng-click="toggle_foldable(\'game_map\');ga(\'game-map\',\'toggle\',\'\')">\n      {{i18n.game_graph}}\n    </div>\n    <div id="graph" class="graph" ng-dblclick="game_map.stabilize()"></div>\n    <div class="game-map-working throbber-rotate" ng-show="currTab.game_map.working_on_mv"></div>\n  </div>\n    ',controllerAs:"game_map",controller:["$rootScope","$scope","$timeout","scoresService",function(a,r,n,o){var c=a.$on("score-game-done",function(e,a){var n=r.currTab,o=n.game_map;n.game.key===a.game.key&&o&&(o.condRender(),o.working_on_mv=null)}),m=a.$on("score-mv-done",function(a,r){var n=r.mv;n.y=e.score2y(n.disp_score)}),t=a.$on("score-working",function(e,a){var n=r.find_game_tab(a.game);if(n){var o=n.game_map;o&&(o.working_on_mv=a.mv,n===r.currTab&&o.condRender())}});r.$watch("foldable_sections_shown.game_map",function(e){o.suspend(!e)}),this.redraw=function(){r.currTab.game_map.is_complete=!1,_.each(r.currTab.game.body,function(e){e.depth=null,e.score=null});var e=_.map(r.tabs,function(e){return e.game});o.set_games(e,r.currTab.game)},this.stabilize=function(){o.stabilize_game(r.currTab.game)},e.initGraph(function(e){r.selectMove(r.currTab,e),r.key_focus="game"}),r.$watchGroup(["currTab.game.moves.length","currTab.game.moves","currTab.game.key","currTab.jobs","currTab.n_job_events","foldable_sections_shown.game_map","currTab.tutor.enabled"],function(){if(r.currTab){var e=r.currTab,a=e.game_map;if(a){var n=e.game,o=n.key,c=n.moves||[],m=n.get_start_fen();a.get_openings(o,m,c),a.condRender()}}}),r.$on("key-moments-upd",function(e,a){var n=r.currTab;if(n&&n.game.key===a.game.key){var o=n.game_map;o&&o.condRender()}}),r.$watch("currentUser.prefs.darkmode",function(){if(r.currTab){var e=r.currTab.game_map;e&&e.condRender()}}),r.$watch("mobile",function(){if(r.currTab){var e=r.currTab.game_map;e&&e.condRender()}}),r.$on("size-changed",function(){e.reflow()}),r.$on("$destroy",function(){c(),m(),t()})}]}}]);
