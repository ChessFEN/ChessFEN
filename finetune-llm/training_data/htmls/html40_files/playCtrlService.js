chessStories.service("playCtrlService",["$rootScope","$state","$timeout","engPool","i18nService","playService","gameService",function(e,s,t,n,o,r,i){var a=5,u=o.phrases,c=null,l=function(s,t){n.init(),this.tab=t,this.mode="assisted",this.user_color="*",this.turn="w",this.state="loading",this.paused=!1,this.paused_at_move=null,this.promoting=!1,this.msg=u.white_turn,this.end_popup_msg="",this.end_popup_msg_t0=0,this.options_shown=!1,this.opts_initial=!0,this.draw_acceptable=!1,this.level=a,this.single_click_moves="off"!=e.currentUser.prefs.automove,this.resign_countdown=0,this.resign_score=700,this.resign_move=null,this.pending_moves=[],this.last_click_sq=null,this.p_chess=new Chess,this.game=s,this.start_t=0,this.duration=-1};function m(e,s){var t=e.p_chess;if(t.fen()==s)return!0;var n=e.game;if(s!=n.curr_move.fen){if(fen_essence(s)!=fen_essence(n.curr_move.fen))return!1;s=n.curr_move.fen}var o=n.path_until_fen(s);return null!==o&&!!function(e,s,t){if(!e.load(s))return!1;var n=!0;return _.each(t,function(s){e.move(s)||(n=!1)}),n}(t,n.get_start_fen(),o)}l.prototype.reset=function(){this.pending_moves=[],this.promoting=!1},l.prototype.switch_mode=function(s,t,n){var o,r,i=this;if("free"==s)return i.mode=s,!0;if("play"!=s&&(n="*"),!(new Chess).load(t))return!1;if(m(i,t)||i.p_chess.load(t),i.msg=u.loading_msg,i.state="loading",i.pending_moves=[],i.mode=s,"play"!=s&&(i.paused=!1,i.resume_at_move=null),i.user_color=n,i.turn=i.p_chess.turn(),"play"==s&&(i.tab.is_pristine&&i.tab.set_name((o=i,r=[e.currentUser.login_name||"guest","play"==o.mode?"computer":"game"],"play"==o.mode&&"b"==o.user_color&&r.reverse(),r.push((new Date).toISOString().slice(0,10).replace(/-/g,".")),r.join(" "))),i.tab.is_pristine=!1,i.start_t=Math.floor(Date.now()/1e3),i.resign_countdown=5,i.resign_move=null,i.resign_score=700),0==i.game.moves.length){var a=i.game;a.initFromFen(t),a.set_origin("play"==s?Game.OR_PLAY:Game.OR_REPLAY),i.tab.setjp("p",t,"",-1,i.tab.jparam.name,"")}return c||(c=new ChessEngine),"play"==s&&(p(i),i.p_chess.turn()==i.user_color&&(i.msg=i.tab.name)),!0},l.prototype.pause=function(e){this.paused||(this.paused_at_move=e,this.paused=!0)};l.prototype.endGame=function(t){var n=this,o="*";t?(o=function(e,s){return"computer-resign"==s?e.user_color.startsWith("w")?"1-0":"0-1":"user-resign"==s?e.user_color.startsWith("w")?"0-1":"1-0":e.p_chess.in_checkmate()?"w"==e.p_chess.turn()?"0-1":"1-0":"1/2-1/2"}(n,t),n.game.headers.Result=o,n.state="game-over",n.msg=function(e,s){return"computer-resign"==s?"w"==e.user_color?u.black_resigns_msg:u.white_resigns_msg:"user-resign"==s?"w"==e.user_color?u.white_resigns_msg:u.black_resigns_msg:e.p_chess.in_checkmate()?"w"==e.p_chess.turn()?u.black_wins_msg:u.white_wins_msg:e.p_chess.in_stalemate()?u.stalemate_msg:u.draw_msg}(n,t),n.end_popup_msg=function(e,s){if("computer-resign"==s)return u.you_win_msg;if("user-resign"==s)return u.computer_wins_msg;var t=e.p_chess;return t.in_checkmate()?"w"==t.turn()^"w"==e.user_color?u.you_win_msg:u.computer_wins_msg:u.draw_msg}(n,t),n.end_popup_msg_t0=Date.now()):(n.state="loading",n.msg="",n.end_popup_msg=""),n.mode="assisted",n.paused=!1,n.resume_at_move=null,n.options_shown=!1,n.resign_move=null,c&&c.terminate(),c=null,function(s,t){if(s.headers.Event||(s.headers.Event=""),s.headers.Site||(s.headers.Site=""),s.headers.Date||(s.headers.Date=(new Date).toISOString().slice(0,10).replace(/-/g,".")),s.headers.Round||(s.headers.Round=""),t){var n=[e.currentUser.login_name||"Guest","play"==t.mode?"computer":""];"play"==t.mode&&"b"==t.user_color&&n.reverse(),s.headers.White||(s.headers.White=n[0]),s.headers.Black||(s.headers.Black=n[1])}s.headers.Result||(s.headers.Result="*"),s.headers.Annotator="DecodeChess",s.headers.PlyCount=""+s.moves.length,t.msg&&s.append_comment(t.msg)}(n.game,n),n.duration=Math.floor(Date.now()/1e3)-n.start_t,e.$broadcast("game-ended",{pm:n}),s.go("index")};var p=function(e){e.p_chess.game_over()?e.endGame("game-over"):e.paused||"play"!=e.mode||e.p_chess.turn()==e.user_color?e.state="waiting":h(e)};var h=function(s){if(s.p_chess.game_over())s.endGame("game-over");else{s.state="thinking";var t=s.p_chess.fen(),n=function(e){var s=[];if(e.length){var t=e[0],n=2*t.move_number-("w"==t.color[0]?2:1);s.push(n),e.forEach(function(e){s.push(e.name,e.score)})}return s}(s.game.moves);r.choose_move(s.p_chess,n.join(","),s.level,function(n){n?d(s,n)||e.$emit("computer-move-played",{pm:s,move:n}):function(e,s){var t=null;c.analyze(e,{depth:4},function(e,n){"result"==e?t=n.moves[0]:"done"==e&&(console.log("L "+t.san),t.fen=t.fen_after,s(t))})}(t,function(t){d(s,t)||e.$emit("computer-move-played",{pm:s,move:t})})})}};function d(e,s){if("free"==e.mode)return!1;if(e.resign_countdown>0&&e.resign_countdown<9999&&e.resign_countdown--,e.draw_acceptable=null!==s.score&&null!=s.score&&Math.abs(s.score)<.6,!s.score)return!1;var t=e.user_color.startsWith("w")?s.score:-s.score;return e.resign_countdown<=0&&t>e.resign_score&&(e.resign_move=s,!0)}function g(e){e.options_shown=!1}return l.prototype.play_move=function(s,t,n,o){var r=this;r.pending_moves=[],r.resign_move=null;var i=r.game,a=(i.moves,null);if(r.game.curr_move&&r.game.curr_move.fen==t){var _=t;if(m(r,t),r.p_chess.move(s),!(a=i.add_move_2(s)))return!1;a.fen_before=_}else r.p_chess.load(s.fen);return r.turn=r.p_chess.turn(),a?n.set("p",a.fen,"",a.index_number,s.san,"",i.key,i.name,i.share_key):n.set("p",s.fen,"",null,s.san,"",i.key,i.name,i.share_key),e.$emit("move-played",{attempted_move:s,added_move:a,skip_anim:o}),r.p_chess.game_over()?r.endGame("game-over"):"play"==r.mode&&(r.paused||r.p_chess.turn()==r.user_color?r.state="waiting":h(r)),!0},l.prototype.undo_user_move=function(){var s=this.game,t=s.moves;this.p_chess.turn()===this.user_color&&s.select_move(t[t.length-2]),s.clear_to_end_of_variant(),this.state="waiting",e.$emit("move-undo",{game:s})},l.prototype.setOptions=function(e){var t=this,n="close"!=e&&!t.options_shown;if("ingame"==e)return t.opts_initial=!1,t.options_shown=!0,void s.go("index.play.options");"init"==e&&"w"!=t.user_color&&"b"!=t.user_color&&(t.user_color="w"),t.options_shown=n,t.opts_initial="init"==e,n||("play"==t.mode?s.go("index.play"):(t.last_clicked_sq=null,s.go("index")))},l.prototype.setLevel=function(e){this.level=e,a=e},l.prototype.setColor=function(e){"play"!=this.mode&&(this.user_color=e)},l.prototype.startPlaying=function(t){var n=this;return!("play"!=n.mode&&("r"==n.user_color&&(n.user_color="bw"[(new Date).getMilliseconds()%2]),function(e,s){var t=e.game.headers,n=s?s.fullname||s.login_name:"Guest",o="DecodeChess Stockfish 12 NNUE level "+e.level;"b"==e.user_color?(t.White=o,t.Black=n):(t.White=n,t.Black=o),t.Result="*",t.Orientation=e.user_color}(n,e.currentUser),n.tab.board_orientation="w"!=n.user_color[0]?"black":"white",!n.switch_mode("play",t,n.user_color)))&&(g(n),s.go("index.play",{c:n.user_color,l:n.level,sd:1}),!0)},l.prototype.syncOnMainline=function(e){var s=this;m(s,e),"play"!==s.mode||s.paused||s.p_chess.turn()===s.user_color||h(s)},l.prototype.resign_accept=function(){("play"==this.mode?this.resign_move:null)&&this.endGame("computer-resign")},l.prototype.resign_decline=function(){var e=this,s="play"==e.mode?e.resign_move:null;if(s){var n=e.tab;e.resign_move=null,e.resign_countdown=7,e.resign_score*=12/7,t(function(){n.add_move(s)},600)}},{PlayCtrl:l,sync_p_chess:m,hide_options:g,resume_game:function(e){if("play"==e.mode&&e.paused){var s=e.game,t=s.moves,n=s.iter_items(function(s){return s===e.paused_at_move});e.paused=!1;var o=n?e.paused_at_move:t[t.length-1];return e.paused_at_move=null,o}}}}]);
