"use strict";chessStories.directive("appBubble",[function(){return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/bubble/bubbleView.html",controllerAs:"bubble",controller:["$scope","$timeout",function(t,e){var s=this;s.shown=!1,s.shown_since=null;var i=$("#app-bubble .bubble-cont"),l=d3.select("#app-bubble .bubble-cont"),n={w:200,h:90,bubble_ref:"",dx:0,dy:0,options:{},tip1_sel:null,tip1_ref:"",dx1:0,dy1:0,tip2_sel:null,tip2_ref:"",dx2:0,dy2:0},o=null,a=null,d=null;function c(t,e,s,i){var l=t.outerWidth(),n=t.outerHeight(),o=t.offset(),a={x:0,y:0};return e.includes("left")?a.x=o.left:e.includes("right")?a.x=o.left+l:a.x=o.left+l/2,null!==s&&(a.x+=s),e.includes("top")?a.y=o.top:e.includes("bottom")?a.y=o.top+n:a.y=o.top+n/2,null!==i&&(a.y+=i),a}function p(){if(s.is_shown()){var t=n;s.show(t.text,t.w,t.h,t.bubble_ref,t.dx,t.dy,t.options,t.tip1_sel,t.tip1_ref,t.dx1,t.dy1,t.tip2_sel,t.tip2_ref,t.dx2,t.dy2)}}s.is_shown=function(){return i.hasClass("popup-shown")&&"block"==i.css("display")},s.show=function(t,p,x,r,u,b,h,f,_,y,m,w,g,v,C){if(h||(h={}),x||(x=.5*p),f=$(f),n={text:t,w:p,h:x,bubble_ref:r,dx:u,dy:b,options:h,tip1_sel:f,tip1_ref:_,dx1:y,dy1:m,tip2_sel:w,tip2_ref:g,dx2:v,dy2:C},f&&f.length){var k,M,z=c(f,_,y,m),O=w?c($(w),g,v,C):{x:null,y:null};k=r.indexOf("left")>-1?0:r.indexOf("right")>-1?-p:-p/2,M=r.indexOf("top")>-1?0:r.indexOf("bottom")>-1?-x:-x/2,k+=(h.absolute?0:z.x)+u,M+=(h.absolute?0:z.y)+b;var A=function(t,e){t?i.addClass(e):i.removeClass(e)};if(h.css_class!=d&&(d&&(i.removeClass(d),d=null),h.css_class&&(i.addClass(h.css_class),d=h.css_class)),A(h.next_btn,"with-next"),A(h.modal,"csmodal"),A(h.steps,"with-steps"),A(1==h.lightbox,"lightbox-1"),A(2==h.lightbox,"lightbox-2"),A(2==h.close_btn,"weak-close-btn"),o=h.hide_cb,a=h.on_click,2==h.modal){f.addClass("semi-modal-excluded"),f.css("position")&&"static"!=f.css("position")||f.css("position","relative");var D=f.outerWidth()+20,E=f.outerHeight()+20,H=f.offset(),L=H.left-10,P=H.top-10;$(".semi-modal-excluded-bg",i).css("left",L+"px").css("top",P+"px").css("width",D+"px").css("height",E+"px").removeClass("ng-hide")}else $(".semi-modal-excluded-bg",i).addClass("ng-hide");h.raised&&$(h.raised).addClass("semi-modal-excluded"),h.next_btn&&$(".next-btn",i).text(h.next_btn);var T=$(".step-dots",i);if(T.empty(),h.steps)for(var W=1;W<=h.steps;W++)T.append($("<div></div>").addClass("dot"+(W==h.step?" curr-step":"")).attr("data-n",W));T.on("click",".dot:not(.curr-step)",function(t){t.stopPropagation();var e=$(this),i=parseInt(e.attr("data-n"));s.hide(i)}),s.shown_since=(new Date).getTime(),function(t){var n=t.x,o=t.y,a=t.w,d=t.h,c=t.tip1_x,p=t.tip1_y,x=t.tip2_x,r=t.tip2_y,u=30;t.wide&&(u=(u+2*Math.min(a,d)-5)/3);var b=function(t,e,s){var i={x:n+a/2,y:o+d/2};if(t<i.x-20?i.x=n+a/4:t>i.x+20&&(i.x=n+3*a/4),null!==t){t||e||(t=i.x+5,e=i.y);var c=t-i.x,p=e-i.y;if(Math.abs(c)<Math.abs(p))var x={x:i.x+u/2,y:i.y},r={x:i.x-u/2,y:i.y};else var x={x:i.x,y:i.y+u/2},r={x:i.x,y:i.y-u/2};var b=[[x.x,x.y],[r.x,r.y],[t,e]],h=["M",b[0],"L",b[1],"L",b[2]].join(" ");l.select(s).attr({d:h+" z"})}else l.select(s).attr({d:"M 0,0 z"})};b(c,p,".bubble-pointer.ptr1 path"),b(x,r,".bubble-pointer.ptr2 path");var h=3;t.css_class&&t.css_class.split(" ").includes("thin")&&(h=2);$(".bubble-frame",i).css({left:n+"px",top:o+"px",width:a+"px",height:d+"px"}),$(".bubble-bg",i).css({left:n+h+"px",top:o+h+"px",width:a-2*h+"px",height:d-2*h+"px"}),null===t.text||("string"==typeof t.text?$(".bubble-inner",i).text(t.text):$(".bubble-inner",i).html(t.text));s.shown=!0,e(function(){},10)}({text:t,x:k,y:M,w:p,h:x,tip1_x:z.x,tip1_y:z.y,tip2_x:O.x,tip2_y:O.y,wide:!1,css_class:h.css_class})}},s.age=function(){return(new Date).getTime()-s.shown_since},s.hide=function(t){s.shown=!1;$(".semi-modal-excluded-bg",i).addClass("ng-hide"),$(".semi-modal-excluded").removeClass("semi-modal-excluded"),o&&o(t),o=null},s.on_click=function(t){t.stopPropagation(),a&&a(t)},t.$on("Esc",function(t,e){s.hide("close")}),$(window).resize(function(){p()}),t.$on("size-changed",function(){p()})}]}}]);
