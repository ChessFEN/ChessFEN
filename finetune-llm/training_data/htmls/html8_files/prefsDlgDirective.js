"use strict";angular.module("chessStories").directive("appPrefsDlg",[function(){return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/prefsDlg/prefsDlgView.html",controllerAs:"prefs",controller:["$scope","$timeout","Fens","Kbd","fenService","acctService",function(e,n,o,s,r,a){var t=this;function d(e){"s"==e&&(e=t.sysdark),"y"==e?$("BODY").addClass("darkmode"):$("BODY").removeClass("darkmode")}function c(n){var o=e.game_panel_pos;e.game_panel_pos=n,e.$broadcast("game-panel-pos-changed",{newval:n,oldval:o})}t.show=function(){var n=e.currentUser?e.currentUser.prefs:{};t.pieces=n.pieces,t.board=n.board,t.darkmode=void 0===n.darkmode?"s":n.darkmode,t.sound=void 0===n.sound?"click":n.sound,t.automove=void 0===n.automove?"":n.automove,t.gamepanel=void 0===n.pgnpos?0:n.pgnpos,t.maxtabs=void 0===n.maxtabs?e.Tab.defaultmaxtabs:n.maxtabs,t.n_key_moments=void 0===n.nmisp?0:n.nmisp,e.prefs_shown=!0},t.onClose=function(n){e.prefs_shown=!1},t.selectPiece=function(e){t.sel_piece=e},t.onKey=function(e){e==s.RIGHT||e==s.LEFT||e==s.UP||s.DOWN},t.onPieceSet=function(e,n){t.pieces=n,a.setUserPrefs({pieces:n})},t.onBoardStyle=function(e,n){t.board=n,a.setUserPrefs({board:n})},t.onDark=function(e,n){t.darkmode=n,a.setUserPrefs({darkmode:n}),d(n)},t.onSound=function(e,n){t.sound=n,a.setUserPrefs({sound:n})},t.onAutomove=function(e,n){"off"!=n&&(n=""),t.automove=n,a.setUserPrefs({automove:n})},t.onGamePanelPos=function(e,n){var o=["left","center","right","farleft"].indexOf(n);o>=0&&(t.gamepanel=o,a.setUserPrefs({pgnpos:t.gamepanel}),c(t.gamepanel))},t.onNKeyMoments=function(e,n){t.n_key_moments=n,0===t.n_key_moments?a.setUserPrefs({nmisp:null}):a.setUserPrefs({nmisp:t.n_key_moments})},e.$watch("currentUser.prefs.pieces",function(e){t.pieces=e}),e.$watch("currentUser.prefs.board",function(e){t.board=e}),e.$watch("currentUser.prefs.darkmode",function(e){t.darkmode=e,d(t.darkmode)}),e.$watch("currentUser.prefs.sound",function(e){t.sound=e}),e.$watch("currentUser.prefs.automove",function(e){t.automove=e}),e.$watch("currentUser.prefs.pgnpos",function(e){t.gamepanel=e,c(t.gamepanel)}),e.$watch("currentUser.prefs.nmisp",function(n){_.isUndefined(n)||(t.n_key_moments=n,e.$broadcast("key-moments-clr"))}),e.$on("mainmenu-darkmode",function(){"y"===t.darkmode?t.darkmode="n":"n"===t.darkmode?t.darkmode="y":t.darkmode="y"===t.sysdark?"n":"y",a.setUserPrefs({darkmode:t.darkmode}),d(t.darkmode)}),e.$on("dismiss-popups",function(n,o){e.prefs_shown=!1}),function(){if(window.matchMedia){t.sysdark=window.matchMedia("(prefers-color-scheme: dark)").matches?"y":"n";try{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(e){t.sysdark=e.matches?"y":"n"})}catch(e){}}}(),d(t.darkmode)}],link:function(e,n,o){$(".prefs-dlg",n).draggable({appendTo:"body",containment:"window",cancel:".prefs-dlg .dlg-body",opacity:.85,scroll:!1,zIndex:99})}}}]);
