"use strict";angular.module("chessStories").controller("homeController",["$scope","$rootScope","$filter","$timeout","$window","$location","$stateParams","$state","engPool","shareService","scoresService","arrowsService","authService","jobService","gameService","websiteService","Config","Fens","Kbd","localStorageService","jobstatesService","fenService","i18nService","automationService","acctService","playCtrlService","tutorService","keyMomentsService","graphService","$compile","$ocLazyLoad",function(e,t,o,a,n,r,s,i,c,u,l,m,d,f,p,h,g,b,v,y,w,T,k,j,x,J,S,M,U,P,C){var I=k.phrases;e.do_persist=0,e.restoreDone=!1;const D=5;function E(){var t=e.mobile;e.mobile="none"==$("#mobile-canary").css("display"),e.mobile_p="none"==$("#mobile-canary-p").css("display"),e.mobile_l="none"==$("#mobile-canary-l").css("display"),e.mediumscr="none"==$("#mediumscr-canary").css("display"),e.narrowscr="none"==$("#narrowscr-canary").css("display"),e.mediumheight="none"==$("#mediumheight-canary").css("display"),e.smallheight="none"==$("#smallheight-canary").css("display"),e.mobile&&!t&&e.$broadcast("enter-mobile-mode")}n.decodeChess={},t.$watch("serverVersion",(t,o)=>{t!==o&&e.popupMsg.showText(e.i18n.new_version,!1,9e3,$(".header-bottom"))}),t.guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+"-"+e()+"-"+e()+e()+e()},e.guid=t.guid,e.getGameName=function(e){return Game.make_game_name(e.headers)};var G,O=t.$on("user-set",function(o,a){if(a.username){var n;_.each(e.tabs,function(o){o.clear_failed_jobs(),(n=o.game).origin===Game.OR_PLAY&&(n.headers.White&&n.headers.White.length?n.headers.Black&&n.headers.Black.length||(n.headers.Black=t.currentUser.fullname):n.headers.White=t.currentUser.fullname),e.save_now(o)}),e.do_persist++;var r=e.interrupted_decode;if(r){var{event:s,decode_type:i,game_key:c,cb:u}=r;e.onDecode(s,i,c,u),e.interrupted_decode=null}}});function B(e){this.n_job_events=0,this.n_selected_move_events=0,e?this.from_simple_obj(e):this.clear(),this.save_timer=null}function L(e,t,o){t.hasOwnProperty(o)&&(e[o]=t[o])}function R(){a(function(){$(".titles-inner-cont").width()>$(".titles-cont").width()?e.hideTabScrollers=!1:e.hideTabScrollers=!0},10)}function K(){a(function(){var t=$(".titles-cont"),o=$(".titles-inner-cont").outerWidth()-t.outerWidth(),a=t.scrollLeft();e.tabRightEnabled=a<o,e.tabLeftEnabled=a>0},10)}e.is_guest=function(){return!t.currentUser||"guest"==t.currentUser.level},e.is_guest_kl_demo=function(){return e.is_guest()&&e.currTab&&e.currTab.currJob&&e.currTab.currJob.fen==e.mainMenu.KL_FEN&&"complete"==e.currTab.currJob.state},e.scrollIntoView=function(e,t,o,n){a(function(){!function(e,t,o,a){if(!t)return;if(!(t=$(t).first()).length)return;if(e)e=$(e);else if(!(e=t.closest(".cs-scrollable")).length)return;if(e.hasClass("scroll-disabled"))return;if(o)var n=e.scrollLeft(),r=t.offset().left,s=t.outerWidth(),i=e.offset().left,c=e.outerWidth(),_=600,u="x";else var n=e.scrollTop(),r=t.offset().top,s=t.outerHeight(),i=e.offset().top,c=e.outerHeight(),_=250,u="y";var l=Math.max(0,Math.min((c-s)/2,20)),m=n-(i-r),d=(r-=Math.min(m,l))+(s+=2*l),f=i+c,p=r-i+n,h=d-f+n,g=n;s>c?d<i?g=p:r>f?g=p:d<f?g=h:r>i&&(g=p):n>p&&p>=0?g=p:n<h&&h>=0&&(g=h);Math.abs(g-n)<100&&(_=_*(Math.abs(g-n)+15)/85);e.stop().scrollTo(g,_,{onAfter:a,axis:u})}(e,t,o,n)},2)},t.getUserStorage=function(){var e=t.currentUser&&t.currentUser.login_name;return e&&y.isSupported?y.get(e):null},e.getGameById=function(t){var o=e.tabs.filter(function(e){return e.game.game_id==t});return o.length?o[0].game:null},e.setFen=function(t,o){t&&("string"==typeof o&&""!=o&&(o={type:"move",variant:(o=o.split(","))[0],piece:o[1],source:o[2],destination:o[3]}),e.board.setFen(t,o))},e.set_curr_move=function(t){$(t).hasClass("curr")?G=$(t):(G&&(G.removeClass("curr"),G=null),(G=$(t)).addClass("curr"));var o=G.attr("data-fena");if(o){"move"==o.split(" ")[0]&&(o=o.split(" ").slice(1).join(" "));var a=G.attr("data-anim");e.setFen(o,a)}},B.prototype.to_share=function(){var e=this;return{name:e.name,game:e.game?e.game.to_simple_obj():null,fen:e.fen,bo:e.board_orientation,decode_type:e.currJob?e.currJob.jparam.type:"",decoded_fen:e.currJob?e.currJob.jparam.fen:"",decoded_mv:e.currJob?e.currJob.jparam.next_move_uci:"",v:{topic:e.currJob?e.currJob.topic:"",threats_status_now:e.threats_status_now}}},B.prototype.to_simple_obj=function(){var e=this;return{game:e.game?e.game.to_simple_obj():null,name:e.name,share_key:e.share_key,dgame_ex_shown:e.dgame_ex_shown,threats_status_now:e.threats_status_now,jobs:_.map(e.jobs,function(e){return e.to_simple_obj()}),currJobIdx:_.indexOf(e.jobs,e.currJob),board_orientation:e.board_orientation,jparam:e.jparam,fen:e.fen}},B.prototype.from_simple_obj=function(e){var t=this;if(t.clear(),L(t,e,"share_key"),e.game){var o=new Game(e.game);t.set_game(o),t.play_mode=new J.PlayCtrl(o,t)}if(L(t,e,"threats_status_now"),e.hasOwnProperty("jobs")&&e.jobs.length>0){_.each(e.jobs,function(e){e&&e.jparam&&z(t,new JobParams(e.jparam))});var a=e.hasOwnProperty("currJobIdx")?e.currJobIdx:-1;t.currJob=a>=0&&a<t.jobs.length?t.jobs[a]:null,!t.currJob&&t.game&&t.game.curr_move&&t.game.curr_move.job&&(t.currJob=t.game.curr_move.job)}e.hasOwnProperty("fen")?t.fen=e.fen:t.game?t.fen=t.game.get_thumbnail_fen():t.fen=b.START,L(t,e,"board_orientation"),t.jparam=new JobParams(e.jparam)},B.prototype.set_name=function(t){this.name=t;var o=this.game;o&&(o.headers.CSGameName=t,N(this)),e.do_persist++},B.prototype.enter_name_edit_mode=function(){this.show_input||(this.show_input=!0,this.orig_name=this.name)},B.prototype.exit_name_edit_mode=function(e){if(this.show_input){var o=e?this.name:this.orig_name;return t.$broadcast("game-name-change",{key:this.game.key,name:o}),this.set_name(o),this.show_input=!1,this.name!=this.orig_name}return!1},B.prototype.setProgressJob=function(){var e=this.game;this.progressJob=null;var t=this.currJob;t||(t=e.curr_move?e.curr_move.job:null),!t||"position"!=t.jparam.type||"working"!=t.state&&"new"!=t.state?(t=this.decode_game_job)&&(this.progressJob=t):this.progressJob=t},e.$watchGroup(["currTab.decode_game_job.state","currTab.currJob.state","currTab.game.curr_move.job.state"],function(){var t=e.currTab;t&&t.setProgressJob&&t.setProgressJob()}),B.prototype.clear=function(){var e=this;e.jobs&&_.each(e.jobs,function(e){e.stopPolling()});var t=new Game;t.set_origin(Game.OR_NONE),e.game=t,e.id=t.headers?t.headers.CSId:t.CSId,e.name=t.get_name(),e.fen=t.get_thumbnail_fen(),e.share_key=null,e.key_moments=[],e.key_moment_idx=0,e.moments_start=!1,e.moments_end=!1,e.show_new_game_panel=!0,e.show_input=!1,e.currJob=null,e.progressJob=null,e.decode_game_job=null,e.topic_arrows=[],e.last_move_arrow=null,e.dgame_ex_shown=!1,e.threats_status_now=!0,e.jobs=[],e.board_orientation="white",e.jparam=new JobParams({type:"position",fen:e.fen,next_move_uci:"",idx:null,name:"SetUp",game_key:"",game_name:I.Game,share_key:e.share_key,san:"",next_san:I.job_name_setup}),e.play_mode=new J.PlayCtrl(t,e),e.tutor=new S.Tutor,e.game_map=new U.Graph(e,e.id),e.engine_el=$("<div></div>"),e.engine_best={fen:"",move:null},e.save_timer=null,e.is_pristine=!0},B.prototype.clear_failed_jobs=function(){this.jobs&&_.each(this.jobs,function(e){e.clear_failed_result()})},B.defaultmaxtabs=15,e.Tab=B;function F(){var e=$(".below-board-row"),t=e.height(),o=0;0===t?(e.css("height","auto"),o=e.css("height"),e.css("height","")):e.css("height",t),e.animate({height:o},{duration:600,done:function(){e.css("height","")}})}function N(e){e.save_timer||(e.save_timer=a(function(){e.save_timer=null,e.game.reset_dirty(),p.save(e.game,"changed",null)},2800))}function A(t,o){var a=e.currTab,n=a.game,r=o?n.delete_variant:n.clear_to_end_of_variant;r=r.bind(n),e.hideMoveMenu(),r(t)&&(n.curr_move&&e.selectMove(a,n.curr_move),N(a))}e.tabs_wheel=function(t,o,a,n){t.preventDefault();var r=$(t.originalEvent.currentTarget).children(":first");o<0&&e.tabRight(r,.4),o>0&&e.tabLeft(r,.4)},e.tabRight=function(e,t){t=t||1,(e=e||$(".titles-cont")).finish();var o=e.outerWidth(),a=e.children(":first").outerWidth()-o;if(e.scrollLeft()<a){var n=Math.min(540*t,o/2),r=225*(1+t)/2;e.scrollTo(Math.min(e.scrollLeft()+n,a),r,K)}},e.tabLeft=function(e,t){if(t=t||1,(e=e||$(".titles-cont")).finish(),e.scrollLeft()>0){var o=e.outerWidth(),a=Math.min(540*t,o/2);e.scrollTo(Math.max(e.scrollLeft()-a,0),225*t,K)}},e.resizeTabsCont=function(){if(!e.mobile){var t=$(".left-side").width();$(".titles-cont").css("max-width",t-75-50),R()}},e.addTab=function(){e.intro&&e.intro.step(-1);var t=new B;if(e.tabs.push(t),e.selectTab(e.tabs.length-1),e.do_persist++,$("BODY > .mobile").length>0){for(;e.tabs.length>1;)e.closeTab(0);return t}var o=B.defaultmaxtabs;return e.currentUser&&e.currentUser.prefs&&e.currentUser.prefs.maxtabs&&(o=e.currentUser.prefs.maxtabs),e.tabs.length>o?a(()=>e.closeTab(0)):e.tabs.length===o&&y.isSupported&&1!==y.get("tabwarn_shown")&&(e.bubble.show($("<div>"+I.tabs_autoclose_message+"</div>"),220,86,"left",20,35,{close_btn:2,css_class:"tabwarn"},"#add-tab-btn","right",12,4),y.set("tabwarn_shown",1)),R(),t},e.startTabNameEdit=function(t,o){t.stopPropagation();var a=e.tabs[o];e.editedTabIdx=o,a.enter_name_edit_mode()},e.endTabNameEdit=function(t){if(null!==e.editedTabIdx){var o=e.editedTabIdx;e.editedTabIdx=null;var a=e.tabs[o];if(a.show_input)a.exit_name_edit_mode(!t)&&(e.do_persist++,N(a))}},e.$on("game-name-change",function(t,o){e.tabs.forEach(function(e){e.game.key==o.key&&o.name!=e.name&&e.set_name(o.name)})}),e.$watch("curr_fen",function(t){e.currTab&&e.currTab.currJob&&e.currTab.currJob.display_state&&(e.currTab.currJob.display_state.fen=t)}),e.selectTab=function(t){if(("object"!=typeof t||-1!=(t=_.indexOf(e.tabs,t)))&&(a(function(){e.scrollIntoView($(".titles-cont"),$(".tab-"+t),!0,K)},10),t!==e.currTabIdx)){var o=e.tabs[t];if(e.setUp&&e.setUp.shown&&e.exitSetUpMode&&e.exitSetUpMode(),e.save_job_display_state(),e.currTab)e.currTab.fen=e.curr_fen;e.currTabIdx=t,e.currTab=o,e.selectJob(o,o.currJob),null===o.key_moments&&M.mark_key_moments(o.game),e.board&&e.board.setFen(o.fen),e.do_persist++}},e.closeTab=function(t){if(e.tabs.length<2)return reset_games_count(),e.tabs[0].clear(),e.currTabIdx=9999,e.currTab=null,e.selectTab(0),e.tabs[0].is_pristine=!0,void e.do_persist++;e.tabs[t].jobs&&_.each(e.tabs[t].jobs,function(e){e.stopPolling()}),e.currTabIdx>t?e.currTabIdx--:e.currTabIdx==t&&(t==e.tabs.length-1?e.selectTab(t-1):(e.selectTab(t+1),e.currTabIdx--)),e.tabs.splice(t,1),R(),e.do_persist++},e.persistTabs=function(){if(y.isSupported&&e.currentUser&&e.currentUser.login_name&&e.restoreDone){var t=e.currentUser.login_name,o=_.map(e.tabs,function(e){return e.to_simple_obj()});y.set(t+".tabs",o),y.set(t+".currTabIdx",e.currTabIdx),y.set(t+".lastDate",Date.now()),y.set(t+".currTabPlayMode",e.currTab.play_mode.mode)}},e.onMoreSectionBtn=function(t){var o=e.moreBtnsSectionShown;t&&t.stopPropagation(),o&&e.dismiss_popups("soft"),e.moreBtnsSectionShown=!o},e.restoreTabs=function(){if(y.isSupported&&e.currentUser&&e.currentUser.login_name){var t=e.currentUser.login_name;!function(e){var t=y.keys();if(!((t=t.filter(function(e){return e.indexOf("lastDate")>=0})).filter(function(t){return t.split(".")[0]===e}).length>0||t.length<D)){var o="",a=Date.now();if(t.map(function(e){var t=y.get(e);t&&+t>0&&+t<a&&(a=+t,o=e)}),o.length>0){var n=o.split(".")[0];y.keys().filter(function(e){return e.indexOf(n)>=0}).map(function(e){y.remove(e)})}}}(t);var o=y.get(t+".tabs")||[];if(!o||0===o.length)return e.restoreDone=!0,void e.addTab();reset_games_count(),e.tabs=_.map(o,function(e){return new B(e)});var a=y.get(t+".currTabIdx")||0,n=y.get(t+".currTabPlayMode")||0;e.tabs.length&&(e.selectTab(a),e.currTab.game.moves&&e.currTab.game.moves.length>0&&"play"===n&&e.mainMenu.onPlay(function(){e.currTab.play_mode.pause(e.currTab.game.moves[e.currTab.game.moves.length-1])})),e.restoreDone=!0}},B.prototype.create_missing_jobs=function(){var e=this,t=e.game;if(_.each(t.positions,function(o){var a;t.get_start_fen()==o.fen?a=-1:(a=_.findIndex(t.moves,function(e){return e.fen==o.fen}))<0&&(a=null);var n=null;if("a"==o.type&&(n="position"),"g"==o.type&&(n="game"),n){var r=new JobParams({type:n,fen:o.fen,next_move_uci:o.next_move_uci,idx:a,name:o.name.replace(/ {}$/,""),um_name:o.um_name,exp_color:o.exp_color,game_key:t.key,game_name:t.name,share_key:t.share_key});z(e,r,"complete")}}),e.decode_game_job){var o=new JobParams({type:"game",game_key:t.key,share_key:t.share_key,game_name:t.name,name:"Game"});X(e,o,{fetch:!0,re_run:!1})}var a=_.filter(t.moves,function(o){if(!o.state||!o.fen)return!1;var a=t.mv2uci(t.moves[o.index_number+1]),n=new JobParams({type:"position",fen:o.fen,next_move_uci:a,share_key:t.share_key,idx:o.index_number,name:o.san});z(e,n);return!0});w.get_states(t.key,a,function(e,t){t&&_.each(t.jobs,function(e){var t=e.f,o=e.s;if("notfound"!=o){var n=_.find(a,function(e){return e.fen==t});n&&("sent"!=o&&"complete"!=o||(n.state=o,n.job.state=o))}})})},B.prototype.set_game=function(t,o){var n=this;n.initial_view=o;var r="",s=null;(s=o&&o.active_move?o.active_move:t.curr_move?t.curr_move:t.choose_rep_move())?r=s.fen:(r=t.get_thumbnail_fen(),(new Chess).validate_fen(r).valid||(r="")),function(e,t){e.is_pristine=!1,e.id=t.CSId,e.name=t.get_name(),e.game=t,e.game_map=new U.Graph(e,t.key),e.show_new_game_panel=!1,e.create_missing_jobs(),e.play_mode.game=t}(n,t),e.board.setFen(r,"no-anim",n),e.hideMoveMenu(),e.light_attrs=[];var i=n.decode_game_job;i&&(n.set_key_moments(),i.readResult(function(e){Q(i),n.n_job_events++})),s?(e.selectMove(n,s),a(e.scrollGameToSelectedMove,100)):n.jobs.length&&e.selectJob(n,n.jobs[0]),e.key_focus="game",n.show_decode_card=!n.jobs.length&&!e.mobile,e.ga("open-game",e.open?e.open.nav_state:"",n.name),p.save(t,"changed",null)},e.ensure_unique_tab_name=function(t){return _.find(e.tabs,function(e){return e.name===t})?(o=t,a=_.max(_.map(e.tabs,function(e){return parseInt(e.name.replace(o,"0").replace(" ",""))})),o+" "+(a?++a:"2")):null;var o,a},e.$on("game-ended",function(t,o){var a=o.pm.tab;a.show_decode_card=!a.jobs.length&&!e.mobile}),e.find_game_tab=function(t){return t&&_.find(e.tabs,function(e){return e.game&&e.game.key===t.key})||null},B.prototype.hide_cards=function(t){_.isUndefined(t)?(this.show_decode_card=!1,this.show_dgame_card=!1,this.show_reviewed_card=!1):"dgame"===t?(this.show_dgame_card=!1,e.viewing_dgame_card=!1):"decode"===t?this.show_decode_card=!1:"reviewed"===t&&(this.show_reviewed_card=!1)},e.onDecodeNotification=function(t){t&&t.stopPropagation();var o=e.currTab;e.dismiss_popups("hard"),e.toggle_foldable("all","closed"),"play"===o.play_mode.mode&&o.play_mode.endGame(),e.setUp&&e.setUp.hide(),o.show_dgame_card=!0,e.controls_folded=!0,F(),o.decode_notification=null},e.onGrowControls=function(t){t&&t.stopPropagation(),e.controls_folded=!1,F()},e.save_now=function(e){e.save_timer&&a.cancel(e.save_timer),e.save_timer=null,e.game.reset_dirty(),p.save(e.game,"changed",null)},B.prototype.setjp=function(e,t,o,a,n,r){r&&_.isObject(r)&&(r=r.san);var s=this.game;this.jparam.set(e,t,o,a,n,r,s.key,s.name,this.share_key)},B.prototype.set_key_moments=function(){this.key_moments=M.get_key_moments(this.game,this.decode_game_job),this.set_key_moment_idx()},B.prototype.set_key_moment_idx=function(){this.key_moments.length&&(this.key_moment_idx=this.key_moments.indexOf(this.game.curr_move)+1,this.moments_start=M.end_of_misplays(this.game,this.decode_game_job,-1),this.moments_start?this.key_moment_idx&&1===this.key_moments.length?this.moments_end=!0:this.moments_end=!1:this.moments_end=M.end_of_misplays(this.game,this.decode_game_job))},e.$on("key-moments-upd",function(t,o){var a=e.currTab;a.game.key!==o.game.key&&(a=e.find_game_tab(o.game)),a&&a.decode_game_job&&(a.set_key_moments(),a.set_key_moment_idx())}),e.$on("key-moments-clr",function(t){e.tabs.forEach(e=>e.key_moments=null);var o=e.currTab;o&&(o.game&&M.mark_key_moments(e.currTab.game))}),B.prototype.start_game_review=function(){e.explanation.onGotoFirstKeyMoment(),this.key_moments.length>1&&(this.game_review=!0)},B.prototype.end_game_review=function(e){this.game_review=!1,e&&(this.show_reviewed_card=!0)},B.prototype.check_game_review=function(){this.key_moment_idx||this.end_game_review(!1)},B.prototype.add_move=function(t,o){if(!this.play_mode.play_move(t,e.curr_fen,this.jparam,o))return!1;var a=this.decode_game_job;return!a||"complete"!=a.state&&"partial"!=a.state||(a.state=this.game.has_all_answers()?"complete":"partial"),N(this),!0},e.onDelFromHere=function(t){t&&t.stopPropagation();var o=e.currTab.play_mode;A(e.move_menu.item,!1),"play"===o.mode&&o.syncOnMainline(e.curr_fen)},e.onDelVariant=function(t){t&&t.stopPropagation(),A(e.move_menu.item,!0)},e.onPromoteVariant=function(t){var o=e.currTab,a=o.game;t&&t.stopPropagation(),e.hideMoveMenu();var n=e.move_menu.item||a.curr_move;if(null!==n){var r=a.find_item_parent(n);r&&r.variant!==a.body&&a.promote_variant(r.variant)&&N(o)}},e.onSaveGame=function(t){var o=e.currTab.game;t&&t.stopPropagation(),e.hideMoveMenu(),function(e,t,o){o||(o="text/plain");var n=new Blob([e],{type:o}),r=window.URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=t,document.body.appendChild(s),a(function(){s.click(),document.body.removeChild(s)},20)}((o=e.currTab.game).as_pgn(),o.get_name().replace("/","_")+".pgn","text/pgn")};t.$on("move-undo",function(t,o){var a=e.currTab,n=o.game.curr_move;o.game.moves.length?e.selectMove(a,n):e.setFen(n.fen),a.play_mode.syncOnMainline(n.fen)});function H(e,t){var o="game"==t.type;return _.findIndex(e.jobs,function(e){return o&&"game"==e.jparam.type||!o&&e.jparam.fen==t.fen&&e.jparam.next_move_uci==t.next_move_uci})}function W(e,t){var o=H(e,t);return-1==o?null:e.jobs[o]}function z(e,t,o,a){var n="game"==t.type,r=W(e,t),s=e.game;return r||(t.share_key=e.share_key||"",r=new f.Job(s,t,a),o&&(r.state=o),n?(e.jobs.unshift(r),e.decode_game_job=r):e.jobs.push(r)),!n&&s&&V(r,s),r}function V(e,t){var o=e.jparam,a=[],n=[];t.iter_move_pairs(function(e,t){var r=t?Game.mv2uci(t):"";e.fen===o.fen&&(o.next_move_uci&&r===o.next_move_uci?a.push(e):n.push(e))}),a.length?a.forEach(t=>t.job=e):n.forEach(t=>t.job=e)}e.save_job_display_state=function(){e.currTab&&e.currTab.currJob&&(e.currTab.currJob.display_state.scroll=$(".results-cont").scrollTop())},e.eachJob=function(t){_.each(e.tabs,function(e){_.each(e.jobs,function(o){if(!1===t(o,e))return!1})})},e.selectJob=function(t,o,a){var n=t===e.currTab;if(n&&e.hideMoveMenu(),o&&t.decode_game_job&&o!==t.decode_game_job&&"wouldwork"===o.state&&(o=null),o&&!o.result&&!o.working){var r=o.state;o.jparam.share_key=t.share_key,o.readResult(function(e){o.partial_arrows&&"working"!=o.state&&(o.partial_arrows=[]),"game"==o.jparam.type&&Q(o),"complete"!=r&&"complete"==e&&t.game&&p.save(t.game,"changed",o.fen),t.n_job_events++})}if(o&&["new","working","complete"].includes(o.state)||t.decode_game_job&&(o=t.decode_game_job),t.currJob=o,t.dgame_ex_shown=o&&"game"==o.jparam.type,o&&(o.topic="summary"),o&&o.jparam){if(!a){var s=o.display_state.fen?o.display_state.fen:o.fen;n&&e.setFen(s);var i=t.game.find_fen_and_mv(o.jparam.fen,o.jparam.next_move_uci);i&&e.selectMove(t,i,!0)}n&&(e.uprefs.hide_arrows=!1),o.result&&(o.result.state=o.state)}},e.basePosition=function(){var t=e.currTab,o=null;return t.currJob&&"position"==t.currJob.jparam.type?o="threats_after"==t.currJob.topic?t.currJob.fenAfterAnalyzedMove:t.currJob.fen:t.game&&t.game.curr_move&&(o=t.game.curr_move.fen),o},e.isInBasePosition=function(){return!!e.currTab&&e.curr_fen==e.basePosition()},e.onReset=function(){e.resetToBasePosition(),t.$broadcast("pos-reset")},e.resetToBasePosition=function(){if(e.currTab){var t=e.currTab,o=e.basePosition();m.select_arrows_by_eids([]),e.board.setFen(o),t.currJob&&"position"==t.currJob.jparam.type?"threats_after"==t.currJob.topic?(o=t.currJob.fenAfterAnalyzedMove,t.setjp("p",o,"",null,I.job_name_setup,"")):(o=t.currJob.fen,t.jparam=new JobParams(t.currJob.jparam)):t.game.curr_move&&(o=t.game.curr_move.fen,t.setjp("p",o,"",null,I.job_name_setup,""))}},e.in_main_line=function(){return e.currTab.game.in_main_line()},e.onKeyMomentNav=function(t,o){t&&t.stopPropagation();var a=e.currTab,n=a.decode_game_job,r=a.game;if(r&&n){var s=M.next_key_moment(r,n,o);s&&(e.selectMove(a,s),-1!==o&&a.game_review&&a.moments_end&&a.end_game_review(!0))}},e.hideMoveMenu=function(){e.move_menu&&e.move_menu.hide()},e.onDigDeeper=function(t){var o=e.currTab.game;o&&o.key&&o.curr_move&&o.curr_move.fen&&(e.setFen(o.curr_move.fen),e.onDecode(t,"position",o.key))},e.onDecode=function(t,o,n,r){t&&t.stopPropagation();var s=e.currTab;if(n&&!(s=_.find(e.tabs,function(e){return e.game.key==n})))return"no_game";var i=s.game;if(s.is_pristine||!i)return"no_game";if("guest"===e.currentUser.level)return e.mainMenu.clickSignUp("guest-decode"),e.interrupted_decode={ev:t,decode_type:o,game_key:n,cb:r},"no_user";if("*intro*KL"==i.key)return e.popupMsg.showText(I.no_decode_in_intro_msg,!1,4100),"no_game";if(!i.key)return"no_game";var c=function(t){return e.currentUser&&"admin"==e.currentUser.level&&t&&t.ctrlKey}(t);if(!function(e,t){return!((!e||!e.currentTarget)&&e&&$(e.currentTarget).hasClass("dim")&&!t)}(t,c))return"disabled";var u=function(t){if(!e.currentUser||"admin"!=e.currentUser.level)return null;if(!t||!t.shiftKey||t.ctrlKey)return null;t.preventDefault();var o=e.contact_dlg.model.subject;return o?o=(o="0000000"+o.trim(" ").replace(/algver *= */i,"")).slice(o.length-6):null}(t);e.intro.curr_step||e.is_guest();if(e.hideMoveMenu(),e.show_guide=!1,e.exitSetUpMode(s),"game"==o){var l=function(t,o){var n=new JobParams({type:"game",game_key:i.key,share_key:s.share_key,game_name:i.name,name:"Game",exp_color:t}),_={re_run:c,algver:u};o&&s.tutor.stand_by(),X(s,n,_,function(t){s.decode_game_job=t,s.set_key_moments(),s.show_decode_card=!1,e.setup_pre_dgame(s),i.add_position(n),i.cond_recalc_opening();var o=t.pct;if(r){var c="working"==t.state?"progress":"ok";r(c,o,null)}a(function(){p.save(i,"changed",d)},25)})};return i.moves.length?e.dgameDlg.show(l):l("a",!1),null}var m=new JobParams(s.jparam),d=T.fix_fen(s.fen),f=function(e){if(!e)return"There is nothing to decode here";var t=new Chess(e);try{if(t.insufficient_material())return"This is a draw - not enough material for either side to win";if(t.game_over())return"There is nothing to decode here - the game has ended";if(t.moves()==[])return"There is nothing to decode here - there are no legal moves"}catch(e){return"This position is illegal - cannot decode it"}return null}(d);return f?(e.popupMsg.showText(f,!1,4100),"bad_position"):(X(s,m,{re_run:c,algver:u},function(t){t&&(e.selectJob(s,t),i.add_position(m),a(function(){p.save(i,"changed",d)},25))}),s.hide_cards(),null)};var Y=0;function q(e){var t=e.game.moves,o=e.game.body[0];e.jparam.exp_color;t.forEach(e=>e.show_exp=!0),o.show_exp=!0}function Q(t){var o=t.game;if(t.response&&t.response.result){var a=function(e,t){var o={},a=t.moves;return _.each(e,function(e,n){var r="dg"+ ++Y;0<=n&&n<a.length+1?(0==n?t.body[0].ex_id=r:a[n-1].ex_id=r,o[r]=e):console.log("*** Ignoring an explanation for move #"+n+" (the game has "+a.length+" moves)")}),o}(t.response.result,o);t.response=null,e.dgame_add_ex_elements(a,t),M.mark_key_moments(o),q(t)}}function X(t,o,n,r,s){if(o.game_key=t.game.key,!o.game_key)return _.isFinite(s)||(s=10),s<=0?null:void a(function(){o.game_key=t.game.key,X(t,o,n,r,s-1)},1e3);var i=n.re_run,c=n.algver,u="game"==o.type,l=o.fen;if(u||T.is_valid_pos(l)){var m=t.game,d=e.is_guest(),f=0,h=W(t,o);if(h&&c&&(h.algver=c,h.clearResult()),h?i?h.jparam.next_move_uci=o.next_move_uci:V(h,m):(h=z(t,o,null,c),t.n_job_events++),h&&"move"==o.type&&(h.fen=l),h&&(h.jparam.share_key=t.share_key),t.currJob=h,n.fetch){var g=h.state,b=function(t){"disconnected"===t&&(!e.have_comm_err()&&f++<3?a(function(){h.readResult(b)},100):f>=3&&("game"!=h.jparam.type||m.has_all_answers()||(h.state="partial"))),h.partial_arrows&&"working"!=h.state&&(h.partial_arrows=[]),m.clear_errors(),"game"==h.jparam.type&&(Q(h),m.has_all_answers()||"working"!==h.state||(h.state="partial")),"complete"==t&&"answered"!=g&&p.save(m,"changed",l)};h.readResult(b)}else{h.partial_arrows=[];var v={r:i,d:"admin"==e.currentUser.level&&e.contact_dlg.model.subject?e.contact_dlg.model.subject:null},y=function(o){!function(t){!0!==t.on_free_plan&&!1!==t.on_free_plan||(e.on_free_plan=t.on_free_plan),t.prev_state,t.state,t.prev_state=t.state,t.progress=t.pct,e.currTab.currJob}(h),"disconnected"===o&&(!e.have_comm_err()&&f++<3?(v.r=!1,a(function(){h.start(v,y)},100)):f>=3&&("game"!=h.jparam.type||m.has_all_answers()||(h.state="partial"))),"position"==h.jparam.type&&(h.partial_arrows&&"working"!=h.state&&(h.partial_arrows=[]),"changed"!=o&&(t.n_job_events++,p.save(m,"changed",l))),d&&"failed"==o&&"wouldcost"==h.state&&e.mainMenu.clickSignUp("guest-3rd-decode"),"game"==h.jparam.type&&(Q(h),"timeout"==o&&m.set_err(),Z(t,h),e.mobile||t.tutor.cond_enable(),"complete"===o&&e.currTab===t&&(e.mobile_p?m.curr_move===m.moves[m.moves.length-1]?e.onDecodeNotification():(t.decode_notification="popping",a(function(){t.decode_notification&&(t.decode_notification="shrunk")},2400)):t.show_dgame_card=!!m.moves.length)),e.mobile&&"complete"==o&&e.toggle_foldable("all","closed")};h.start(v,y),function(e,t){function o(){return(new Date).getTime()}var n=o(),r={t0:n,partial_t:null,step:1,change_t:n};t.chatter=r,a(function e(){if("working"!=t.state&&"new"!=t.state)return void(t.chatter=null);n=o();!r.partial_t&&t.result&&t.result.b&&t.result.g&&t.result.t&&t.result.a&&(r.partial_t=n);1==r.step&&n-r.change_t>5700&&n-r.partial_t>4900?(r.step=2,r.change_t=n):2==r.step&&n-r.change_t>5700&&n-r.t0>42e3?(r.step=3,r.change_t=n):n-r.change_t>8e3&&n-r.t0>42e3&&(t.chatter=null);t.chatter&&a(e,808)},100)}(0,h)}r&&r(h)}else e.popupMsg.showText(I.pos_not_valid,!1,4500)}function Z(t,o){if("game"==o.jparam.type){var a=t.game,n=a.curr_move;n&&n!==a.moves[a.moves.length-1]&&n.ex_id&&n.show_exp&&e.curr_fen==n.fen&&(!n.job||"game"==n.job.jparam.type)&&e.show_decode_game_explanation(n)}}function ee(){var t=e.currTab&&e.currTab.currJob;return t&&("complete"===t.state||t.parts&&t.parts.indexOf("f")>=0)}function te(e){a(oe,2)}function oe(){if(e.currTab){var t,o=e.currTab,n=$(".right-side").outerHeight(),r=($(".app-game-map").outerHeight(!0),$(".game-decodes").outerHeight(!0),o.game&&o.game.moves&&o.game.moves.length>0?"hasmoves":"nomoves");if((!e.intro||!e.intro.curr_step)&&e.foldable_sections_shown.decodes){$(".decodes-cont").removeClass("folded"),$(".right-side").addClass("decodes-shown").removeClass("hasmoves nomoves").addClass(r),t=function(e){var t=e.css("height");e.css("max-height","");var o=e.outerHeight();return e.css("max-height",t),e.outerHeight(),o}($(".decodes-cont"));var s=Math.max(n-void 0-0,0);t=Math.min(t,s)}else $(".decodes-cont").addClass("folded"),$(".right-side").removeClass("decodes-shown").removeClass("hasmoves nomoves"),t=0,"dcands"==e.key_focus&&(e.key_focus="game");$(".decodes-cont").css("max-height",t?t+"px":""),a(function(){$(".output-cont").toggleClass("css3bugworkaround")},310)}}e.show_curr_move_dgame_exp=function(){var t=e.currTab;if(t){var o=t.game.curr_move,a=t.decode_game_job;o&&a&&(o.show_exp=!0,e.show_decode_game_explanation(o),e.force_arrows_change++)}},e.show_all_dgame_exp=function(){var t=e.currTab;if(t){var o=t.decode_game_job;o&&(o.jparam.exp_color="a",q(o),e.show_decode_game_explanation(o.game.curr_move),e.force_arrows_change++)}},e.$watch("currentUser.lang",function(t){_.each(e.tabs,function(e){_.each(e.jobs,function(t){!function(e,t){e.game,t.forget_results(),t.readResult(function(o){t.partial_arrows&&"working"!=t.state&&(t.partial_arrows=[]),"game"==t.jparam.type&&(Q(t),Z(e,t))})}(e,t)})}),$("BODY").attr("data-lang",t)}),t.$watch("currentUser.prefs.pieces",function(e){$("BODY").attr("data-pieces",e)}),t.$watch("currentUser.prefs.board",function(e){$("BODY").attr("data-board",e)}),t.$on("needs_premium",function(t,o){if(!e.app){e.go_premium_kind=o.kind,e.go_premium_shown=!0;var a=o.job,n=e.currTab;n&&n.jobs&&n.jobs.length>0&&"game"==n.jobs[0].jparam.type&&n.game.iter_items(function(e){(Game.is_move(e)||Game.is_sentinel(e))&&e.job===a&&(e.job=null)})}}),e.toggle_foldable=function(t,o){var a=e.foldable_sections_shown,n=a[t];"all"!==t?("closed"!==o&&(e.limit_open_foldables(!!t&&t.length&&!n),a=e.foldable_sections_shown),a[t]="open"===o||"closed"!==o&&!n,a[t],e.moreBtnsSectionShown=!1):e.foldable_sections_shown=_.mapObject(a,(e,t)=>"closed"!==o)},e.limit_open_foldables=function(t){var o=e.foldable_sections_shown;if(e.mobile){var a=Object.keys(o).filter(e=>o[e]),n=ee()?1:2;for(t&&n--;a.length>n;)a.shift();e.foldable_sections_shown=_.mapObject(o,(e,t)=>!1),a.forEach(t=>e.foldable_sections_shown[t]=!0)}},e.onShareBtn=function(t){var o=e.currTab;o.is_pristine||i.go("index.share",{tab:o})},e.play_best_move=function(t){t.preventDefault();var o=e.currTab,a=e.curr_fen,n=(o.game,o.engine_best.move);a&&n&&o.engine_best.fen==a&&(n.fen=n.fen_after,o.play_mode.play_move(n,a,o.jparam))},e.getPristineTab=function(){if(e.currTab&&e.currTab.is_pristine)return e.currTab;var t=_.find(e.tabs,function(e){return e.is_pristine});return t?e.selectTab(t):t=e.addTab(),t},E(),e.is_touch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,e.app="mobile"===g.platform,e.is_touch&&$("BODY").addClass("touch"),e.tabs=[],e.currTabIdx=null,e.currTab=null,e.force_arrows_change=0,e.key_focus=null,e.editedTabIdx=null,e.hideTabScrollers=!0,e.tabRightEnabled=!0,e.tabLeftEnabled=!0,e.moreBtnsSectionShown=!1,t.serverVersion={},t.localVersion=g.ui_version.replace(/^@GIT_TAG@$/,"local").replace(/^0*/,""),e.foldable_sections_shown={pgn_area:!!e.mobile,game_map:!e.mobile,game_stats:!1,move_info:!1,game_info:!1,local_engine:!1,decodes:!1,openings_explorer:!1},e.show_open_dlg=!1,e.show_contact_us_dlg=!1,e.show_history=!1,e.history2_callback=null,e.history2_openDlg=function(t){e.show_history=!0,e.mainMenu&&e.mainMenu.showSkeleDlg("history",null,()=>e.show_history=!1),e.history2_callback=t},e.onCloseHistoryDialog=function(){e.show_history=!1,e.history2_callback&&e.history2_callback()},e.uprefs=!1,e.uprefs||(e.uprefs={hide_arrows:!1,arrow_opacity:.34},e.uprefs),e.auto_pop_signup=!0,e.mobile&&a(function(){window.scrollTo(0,1)},10),e.$watch("do_persist",e.persistTabs),e.$watch("show_website_frame",function(t,o){!1===t&&o&&(e.interrupted_decode=null)}),e.$watch("currentUser.prefs.game_map",function(t){void 0!==t&&e.toggle_foldable("game_map","off"===t?"closed":"open")}),e.$watch("foldable_sections_shown.game_map",function(t){e.currentUser&&e.currentUser.prefs&&x.setUserPrefs({game_map:t?"":"off"})}),e.$watch("currentUser.prefs.job_decodes",function(t){ee()&&(void 0===t?e.toggle_foldable("decodes","closed"):e.toggle_foldable("decodes","on"===t?"open":"closed"))}),e.$watch("currentUser.prefs.nojob_decodes",function(t){ee()||(void 0===t?e.toggle_foldable("decodes","closed"):e.toggle_foldable("decodes","on"===t?"open":"closed"))}),e.$watch("foldable_sections_shown.decodes",function(t){if(e.currentUser&&e.currentUser.prefs){var o=t?"on":"";ee()?x.setUserPrefs({job_decodes_shown:o}):x.setUserPrefs({nojob_decodes_shown:o})}}),e.$watchGroup(["currTab.currJob","currTab.jobs","currTab.jobs.length","show_open_dlg","intro.curr_step","foldable_sections_shown.game_map","foldable_sections_shown.decodes","right_pct"],function(){e.limit_open_foldables(),a(te,1)}),$(window).resize(function(){E(),te(),e.tabs&&e.tabs.length>0&&(R(),K())}),e.$watch("tabs.length",function(e){e&&(R(),K())}),e.$watch("currTab",function(e,t){e&&t&&(t.play_mode&&e.play_mode.mode==t.play_mode.mode||(e.play_mode&&"play"==e.play_mode.mode?i.go("index.play",{resume:1}):t.play_mode&&"play"==t.play_mode.mode&&i.go("index")))}),e.dismiss_popups=function(e,o){t.$broadcast("dismiss-popups",{why:e,ev:o})},t.onTopLevelClick=function(t){e.dismiss_popups("soft",t)},$(document).unbind("keydown"),$(document).keydown(function(o){if(o.keyCode!=v.ESC||o.shiftKey||o.ctrlKey||o.altKey||(t.$broadcast("Esc"),t.$broadcast("dismiss-popups",{why:"Esc",ev:o})),o.ctrlKey){if(o.keyCode==v.RIGHT)return void(e.currTabIdx<e.tabs.length-1&&(o.preventDefault(),e.selectTab(e.currTabIdx+1),e.$apply()));if(o.keyCode==v.LEFT)return void(e.currTabIdx>0&&(o.preventDefault(),e.selectTab(e.currTabIdx-1),e.$apply()))}if(null===e.editedTabIdx){var a=$(":focus");if(o.keyCode==v.ENTER&&(a.hasClass("btn")||a.hasClass("clk")))a.click();else if(e.show_open_dlg)e.open.onKey(o);else if(e.prefs_shown);else if(e.show_history);else if(e.setUp&&e.setUp.shown)e.setUp.onKey(o.keyCode);else if(e.show_website_frame);else if(o.keyCode==v.TAB){o.preventDefault();for(var n=["game","dcands","jobs","output","engine"],r=n.findIndex(function(t){return t==e.key_focus});!(r=(r+1)%n.length,e.key_focus=n[r],"game"==e.key_focus||"dcands"==e.key_focus&&e.foldable_sections_shown.decodes&&e.decode_candidates.length||"jobs"==e.key_focus&&e.foldable_sections_shown.decodes&&e.currTab.jobs.length||"output"==e.key_focus||"engine"==e.key_focus&&e.foldable_sections_shown.local_engine););}else if(e.show_contact_us_dlg)e.contact_dlg.keyAction(o.keyCode);else if(o.keyCode==v.SPACE)e.play_best_move(o);else if(e.key_focus&&o.keyCode==v.LETTER_F&&o.shiftKey&&!o.ctrlKey&&!o.altKey)e.board.flip();else if("output"==e.key_focus){if(!e.output_area_on_key(o))return}else"game"==e.key_focus?(e.pgn_on_key(o.keyCode),o.preventDefault()):"engine"==e.key_focus?e.engine_area_on_key(o):"dcands"==e.key_focus?e.dcands_on_key(o):"jobs"==e.key_focus&&e.jobs_on_key(o);e.$apply()}else o.keyCode==v.ENTER?(e.endTabNameEdit(),e.$apply()):o.keyCode==v.ESC&&(e.endTabNameEdit(!0),e.$apply())});var ae=$("<iframe></iframe>").addClass("ifr-preload"),ne="index"==i.current.name;e.$watchGroup(["currTab.game.moves.length","currTab.game.moves","currTab.game.key","currTab.jobs","currTab.n_job_events","foldable_sections_shown.game_map","currTab.n_selected_move_events"],function(){if(!e.mobile&&e.currTab){var t=_.map(e.tabs,function(e){return e.game});l.set_games(t,e.currTab.game),e.do_persist++}}),e.have_comm_err=function(){return window.dc_comm_err},t.fully_loaded=t.fully_loaded,d.isLoggedInAsync(function(o){if(o)e.auto_pop_signup=!1,a(function(){e.restoreTabs()},120);else{var n=function(){e.intro&&e.output_area_initialized?(e.mobile&&e.getPristineTab(),e.intro.step(1)):a(n,240)};e.have_comm_err()?e.addTab():ne&&n(),a(function(){ae.attr("src")||(ae.attr("src",h.get_url_for("free_signup_iframe")),$("BODY").append(ae))},1110)}a(function(){t.fully_loaded||C.load(g.lazyLoadAssets).then(function(){C.inject("chessStories"),$(".oc-lazy-load").each((t,o)=>P(o)(e)),t.fully_loaded=!0})},150)}),e.$on("dismiss-popups",function(t,o){null!==e.editedTabIdx&&e.endTabNameEdit(o&&"Esc"==o.why),e.moreBtnsSectionShown=!1}),e.$on("destroy",function(){O()}),j.init(e)}]);
