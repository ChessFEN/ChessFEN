"use strict";Math.hypot||(Math.hypot=function(e,n){return Math.sqrt(e*e+n*n)}),"".endsWith||("".prototype.endsWith=function(e){return this.substr(this.length-e.length)==e}),"".startsWith||("".prototype.startsWith=function(e){return this.substr(0,e.length)==e}),chessStories.service("httpWrapperService",["Config","$http",function(e,n){return"mobile"===e.platform&&window.CapacitorWebFetch("https://app.decodechess.com/robots.txt"),{get:"web"===e.platform?n.get:(e,n)=>{var r=n.withCredentials?{credentials:"include"}:{};return window.Capacitor.Plugins.CapacitorHttp.get({url:e,headers:n.headers,params:n.params,webFetchExtra:r})},post:"web"===e.platform?n.post:(e,n,r)=>{var t=r.withCredentials?{credentials:"include"}:{},p=r.headers||{"Content-Type":"application/json"};return window.Capacitor.Plugins.CapacitorHttp.post({url:e,headers:p,data:n,webFetchExtra:t})}}}]),chessStories.service("apiService",["Config","$rootScope","$timeout","httpWrapperService","$location","authService",function(e,n,r,t,p,s){var o=["play","decode","decode_game"];return{call:function(i,a,P,c,l,u,f){r(function(){!function(r,i,a,P,c,l,u){var f=function(e){if(n.$emit("comm_ok",{}),e.data&&"nologin"==e.data.status)return $(window).unbind(),s.clear_login(),p.path("/login");var r=e.data;return r.vera&&(n.serverVersion.vera=r.vera),r.verg&&(n.serverVersion.verg=r.verg.replace(/^@GIT_TAG@$/,"local")),window.dc_comm_err=!1,c(r)},d=function(e){window.dc_comm_err=!0,l&&l("Failed to contact the server. Try again later.",e)};if(o.includes(r)){var b=function(n,r){r=_.mapObject(r,function(e){return null==e?"":e});var t=new URLSearchParams(r),p=e.API.wsHost+"/api/v1.1/"+n+"?"+t.toString();return new WebSocket(p)}(r,i);if(b)return b.addEventListener("error",d),b.addEventListener("message",function(e){f({data:JSON.parse(e.data)})}),void(u&&b.addEventListener("close",u))}var m=e.API.host+"/api/v1.1/"+r;if(null===a)return v={withCredentials:!0,params:i},t.get(m,v).then(f,d);if("form"==P){var v={withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(e){var n=[];for(var r in e)n.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return n.join("&")}};return t.post(m,a,v).then(f,d)}v={withCredentials:!0,params:i,headers:{"Content-Type":"application/json"}},t.post(m,a,v).then(f,d)}(i,a,P,c,l,u,f)},1)}}}]),chessStories.service("acctService",["apiService","$rootScope",function(e,n){function r(r,t){r.lang;if(n.currentUser.login_name){var p={r:JSON.stringify(r)};return e.call("user_change",p,null,null,function(e){if(e.status,t){var n="ok"==e.status?null:e.msg;t(n)}},function(e){t&&t(e)})}t&&t(null)}return{setUserPrefs:function(e,t){if(n.currentUser&&n.currentUser.prefs){var p=n.currentUser.prefs,s={},o=0;_.each(e,function(e,n){p[n]!=e&&(p[n]=e,s[n]=e,o++)}),o>0?r(s,t):t&&t(null)}else t&&t(null)},uploadPrefs:r}}]),chessStories.service("decodeService",["$rootScope","apiService",function(e,n){return{decode:function(r,t,p,s,o,i,a,P,c,l,u,f){var d={f:p,n:s,g:r,m:t,s:i,t:a,l:e.currentUser.lang,p:o,a:P?0:1,r:c?1:0};return l&&(d.v=l),"admin"==e.currentUser.level&&f&&(d.d=f),s&&(d.n=s),n.call("decode",d,null,null,function(e){return u(null,e)},function(e){return u("Failed to contact the server. Try again later.",null)},function(){return u(null,{disconnected:!0})})},decode_game:function(r,t,p,s,o,i,a,P){var c,l,u,f,d={g:r,m:t,h:(c=s,l=[],u=0,f=16,_.each(c,function(e){f>>=1,e&&(u|=f),1==f&&(l.push(Number(u).toString(16)),f=16,u=0)}),f<16&&l.push(Number(u).toString(16)),l.join("")),s:p,a:o?0:1,r:i?1:0,p:0,l:e.currentUser.lang};return a&&(d.v=a),n.call("decode_game",d,null,null,function(e){return P(null,e)},function(e){return console.log("*** comm error. error=",e),P("Failed to contact the server. Try again later.",null)},function(){return P(null,{disconnected:!0})})}}}]),chessStories.service("jobstatesService",["apiService",function(e){return{get_states:function(n,r,t){if(r&&0!=r.length){var p={g:n,jobs:_.map(r,function(e){return{f:e.fen}})};return e.call("jobstates",null,p,null,function(e){if(_.each(e.jobs,function(e){_.each(r,function(n){n.fen==e.f&&(n.state=e.s,n.state)})}),t)return t(null,e)},function(e){if(t)return t("Failed to contact the server. Try again later.",null)})}t&&setTimeout(function(){t(null,{jobs:[]})},10)}}}]),chessStories.service("recommendService",["$timeout","apiService",function(e,n){return{opnames:function(e,r,t,p){var s=new Game,o=(new Chess(r),{g:e,f:r,m:_.map(t,s.mv2uci).join(",")});n.call("opnames",o,null,null,function(e){return"error"==e.status?p(null,e):p("Error",e)},function(e){p("Failed to contact the server. Try again later.",null)})},recommend:function(e,n,r,t,p,s){return void s("Error",null)}}}]),chessStories.service("playService",["$timeout","apiService",function(e,n){return{choose_move:function(r,t,p,s){var o=r.fen(),i=!1,a=function(e){return!i&&(i=!0,s(e),!0)},P={"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1":["e4","d4"],"rnbqkb1r/pppppppp/5n2/8/3P4/8/PPP1PPPP/RNBQKBNR w KQkq - 1 2":["c4"],"rnbqkb1r/pppp1ppp/4pn2/8/2PP4/8/PP2PPPP/RNBQKBNR w KQkq - 0 3":["Nf3"],"rnbqkb1r/pppppp1p/5np1/8/2PP4/8/PP2PPPP/RNBQKBNR w KQkq - 0 3":["Nf3"],"rnbqkb1r/pp1ppp1p/5np1/2p5/2PP4/5N2/PP2PPPP/RNBQKB1R w KQkq c6 0 4":["Nc3","d5"],"rnbqkb1r/ppp2ppp/4pn2/3p4/2PP4/5N2/PP2PPPP/RNBQKB1R w KQkq d6 0 4":["Nc3"],"rnbqkb1r/pp1p1ppp/4pn2/2p5/2PP4/5N2/PP2PPPP/RNBQKB1R w KQkq c6 0 4":["d5"],"rnbqkbnr/pp1ppppp/8/2p5/4P3/8/PPPP1PPP/RNBQKBNR w KQkq c6 0 2":["Nf3"],"rnbqkbnr/pp2pppp/3p4/2p5/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 0 3":["d4","Bb5+"],"rnbqkbnr/pp2pppp/3p4/8/3pP3/5N2/PPP2PPP/RNBQKB1R w KQkq - 0 4":["Nxd4"],"rnbqkb1r/pp2pppp/3p1n2/8/3NP3/8/PPP2PPP/RNBQKB1R w KQkq - 1 5":["Nc3"],"rnbqkb1r/1p2pppp/p2p1n2/8/3NP3/2N5/PPP2PPP/R1BQKB1R w KQkq - 0 6":["Be2","Be3","f3"],"rnbqkb1r/1p3ppp/p2p1n2/4p3/3NP3/2N2P2/PPP3PP/R1BQKB1R w KQkq e6 0 7":["Nb3"],"r1bqkb1r/pp2pppp/2np1n2/8/3NP3/2N5/PPP2PPP/R1BQKB1R w KQkq - 3 6":["Bg5","Bc4"],"rnbqkb1r/pp3ppp/3ppn2/8/3NP3/2N5/PPP2PPP/R1BQKB1R w KQkq - 0 6":["g4","Be2","Be3","f4"],"rnbqkb1r/pp2pp1p/3p1np1/8/3NP3/2N5/PPP2PPP/R1BQKB1R w KQkq - 0 6":["Be3","Be2","f4"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/8/PPPP1PPP/RNBQKBNR w KQkq e6 0 2":["Nf3"],"r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3":["Bb5","Bc4","c3"],"r1bqkbnr/1ppp1ppp/p1n5/1B2p3/4P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 0 4":["Ba4"],"r1bqkb1r/1ppp1ppp/p1n2n2/4p3/B3P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 2 5":["O-O"],"r1bqkb1r/2pp1ppp/p1n2n2/1p2p3/B3P3/5N2/PPPP1PPP/RNBQ1RK1 w kq b6 0 6":["Bb3"],"r1bqkb1r/2p2ppp/p1np1n2/1p2p3/4P3/1B3N2/PPPP1PPP/RNBQ1RK1 w kq - 0 7":["c3"],"r1bqkb1r/pppp1ppp/2n2n2/4p3/4P3/2P2N2/PP1P1PPP/RNBQKB1R w KQkq - 1 4":["d4"],"r1bqkb1r/pppp1ppp/2n5/4p3/3Pn3/2P2N2/PP3PPP/RNBQKB1R w KQkq - 0 5":["d5"],"rnbqkb1r/pppp1ppp/5n2/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3":["Nxe5"],"rnbqkb1r/pppp1ppp/8/4N3/4n3/8/PPPP1PPP/RNBQKB1R w KQkq - 0 4":["Qe2"],"rnbqkb1r/ppp2ppp/3p1n2/4N3/4P3/8/PPPP1PPP/RNBQKB1R w KQkq - 0 4":["Nf3"],"rnbqkb1r/ppp2ppp/3p4/8/4n3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 0 5":["Nc3"],"rnbqkb1r/ppp2ppp/3p4/8/8/2n2N2/PPPP1PPP/R1BQKB1R w KQkq - 0 6":["dxc3"],"rnbqkbnr/ppp2ppp/3p4/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 0 3":["d4"],"r1bqkbnr/pppn1ppp/3p4/4p3/3PP3/5N2/PPP2PPP/RNBQKB1R w KQkq - 1 4":["Bc4"],"rnbqkbnr/pppp1ppp/4p3/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2":["d4"],"rnbqkbnr/ppp2ppp/4p3/3p4/3PP3/8/PPP2PPP/RNBQKBNR w KQkq d6 0 3":["Nc3","Nd2","e5"],"rnbqkbnr/pp1ppppp/2p5/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2":["d4"],"rnbqkbnr/pp2pppp/2p5/3p4/3PP3/8/PPP2PPP/RNBQKBNR w KQkq d6 0 3":["Nc3","e5"],"rnbqkbnr/pp2pppp/2p5/8/3Pp3/2N5/PPP2PPP/R1BQKBNR w KQkq - 0 4":["Nxe4"],"rn1qkbnr/pp2pppp/2p5/5b2/3PN3/8/PPP2PPP/R1BQKBNR w KQkq - 1 5":["Ng3","Qf3"],"rnbqkbnr/ppp1pppp/3p4/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2":["d4"],"rnbqkb1r/ppp1pppp/3p1n2/8/3PP3/8/PPP2PPP/RNBQKBNR w KQkq - 1 3":["Nc3"],"rnbqkb1r/ppp1pp1p/3p1np1/8/3PP3/2N5/PPP2PPP/R1BQKBNR w KQkq - 0 4":["f4","Nf3"],"rnbqk2r/ppp1ppbp/3p1np1/8/3PP3/2N2N2/PPP2PPP/R1BQKB1R w KQkq - 2 5":["Be2"],"rnbqkbnr/ppp1pppp/8/3p4/4P3/8/PPPP1PPP/RNBQKBNR w KQkq d6 0 2":["exd5"],"rnbqkb1r/ppp1pppp/8/3n4/3P4/8/PPP2PPP/RNBQKBNR w KQkq - 0 4":["Nf3"],"rnbqkb1r/pppppppp/5n2/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 1 2":["e5"],"rnbqkb1r/pppppppp/8/3nP3/8/8/PPPP1PPP/RNBQKBNR w KQkq - 1 3":["d4"],"rnbqkb1r/ppp1pppp/3p4/3nP3/3P4/8/PPP2PPP/RNBQKBNR w KQkq - 0 4":["Nf3"],"rnbqkb1r/pppppppp/1n6/4P3/3P4/8/PPP2PPP/RNBQKBNR w KQkq - 1 4":["a4"],"r1bqkbnr/pppppppp/2n5/8/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 1 2":["d4"],"r1bqkbnr/pppp1ppp/2n5/4p3/3PP3/8/PPP2PPP/RNBQKBNR w KQkq e6 0 3":["d5"],"r1bqkbnr/ppp1pppp/2n5/3p4/3PP3/8/PPP2PPP/RNBQKBNR w KQkq d6 0 3":["Nc3"],"r1bqkbnr/ppp1pppp/2n5/8/3Pp3/2N5/PPP2PPP/R1BQKBNR w KQkq - 0 4":["d5"],"rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR b KQkq d3 0 1":["Nf6","d5"],"rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR b KQkq c3 0 2":["g6"],"rnbqkb1r/pppppp1p/5np1/8/2PP4/2N5/PP2PPPP/R1BQKBNR b KQkq - 1 3":["Bg7","d5"],"rnbqk2r/ppppppbp/5np1/8/2PPP3/2N5/PP3PPP/R1BQKBNR b KQkq e3 0 4":["d6"],"rnbqkb1r/pppppp1p/5np1/8/2PP4/5N2/PP2PPPP/RNBQKB1R b KQkq - 1 3":["Bg7"],"rnbqk2r/ppp1ppbp/5np1/3P4/3P4/2N2N2/PP2PPPP/R1BQKB1R b KQkq - 0 5":["Nxd5"],"rnbqk2r/ppp1ppbp/6p1/3n4/3PP3/2N2N2/PP3PPP/R1BQKB1R b KQkq e3 0 6":["Nxc3"],"rnbqkb1r/ppp1pp1p/6p1/3n4/3P4/2N5/PP1BPPPP/R2QKBNR b KQkq - 1 5":["Bg7"],"rnbqkb1r/ppp1pp1p/5np1/3p4/2PP4/2N2N2/PP2PPPP/R1BQKB1R b KQkq - 1 4":["Bg7"],"rnbqkb1r/pppppp1p/5np1/8/2PP4/6P1/PP2PP1P/RNBQKBNR b KQkq - 0 3":["Bg7"],"rnbqkb1r/pppppppp/5n2/8/3P4/5N2/PPP1PPPP/RNBQKB1R b KQkq - 2 2":["g6"],"rnbqkb1r/pppppp1p/5np1/8/3P4/5NP1/PPP1PP1P/RNBQKB1R b KQkq - 0 3":["Bg7"],"rnbqkb1r/pppppppp/5n2/8/3P4/6P1/PPP1PP1P/RNBQKBNR b KQkq - 0 2":["g6"],"rnbqkbnr/ppp1pppp/8/3p4/2PP4/8/PP2PPPP/RNBQKBNR b KQkq c3 0 2":["c6"],"rnbqkbnr/pp2pppp/2p5/3p4/2PP4/5N2/PP2PPPP/RNBQKB1R b KQkq - 1 3":["Nf6"],"rnbqkb1r/pppppppp/5n2/8/2P5/5N2/PP1PPPPP/RNBQKB1R b KQkq c3 0 2":["g6"],"rnbqkbnr/pp2pppp/2p5/3p4/2PP4/2N5/PP2PPPP/R1BQKBNR b KQkq - 1 3":["Nf6"],"rnbqkbnr/pp2pppp/2p5/3p4/2PP4/4P3/PP3PPP/RNBQKBNR b KQkq - 0 3":["Nf6"],"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1":["e5","c5"],"rnbqkbnr/pppp1ppp/8/4p3/4PP2/8/PPPP2PP/RNBQKBNR b KQkq f3 0 2":["exf4"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R b KQkq - 1 2":["Nc6"],"r1bqkbnr/pppp1ppp/2n5/4p3/3PP3/5N2/PPP2PPP/RNBQKB1R b KQkq d3 0 3":["exd4"],"r1bqkbnr/pppp1ppp/2n5/4p3/2B1P3/5N2/PPPP1PPP/RNBQK2R b KQkq - 3 3":["Nf6"],"r1bqkbnr/pppp1ppp/2n5/1B2p3/4P3/5N2/PPPP1PPP/RNBQK2R b KQkq - 3 3":["a6","g6","Bc5"],"r1bqkbnr/1ppp1ppp/p1n5/4p3/B3P3/5N2/PPPP1PPP/RNBQK2R b KQkq - 1 4":["Nf6","d6"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/2N5/PPPP1PPP/R1BQKBNR b KQkq - 1 2":["Nf6"],"rnbqkbnr/pp1ppppp/8/2p5/4P3/5N2/PPPP1PPP/RNBQKB1R b KQkq - 1 2":["d6"],"rnbqkbnr/pp2pppp/3p4/2p5/3PP3/5N2/PPP2PPP/RNBQKB1R b KQkq d3 0 3":["cxd4"],"rnbqkbnr/pp2pppp/3p4/8/3NP3/8/PPP2PPP/RNBQKB1R b KQkq - 0 4":["Nf6"],"rnbqkb1r/pp2pppp/3p1n2/8/3NP3/2N5/PPP2PPP/R1BQKB1R b KQkq - 2 5":["a6","e6","Nc6","g6"],"rnbqkbnr/pp1ppppp/8/2p5/4P3/2N5/PPPP1PPP/R1BQKBNR b KQkq - 1 2":["Nc6"],"rnbqkbnr/pp1ppppp/8/2p5/4P3/2N5/PPPP1PPP/R1BQKBNR b KQkq - 1 2":["Nc6"],"rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR b KQkq c3 0 1":["Nf6"],"rnbqkb1r/pppppppp/5n2/8/2P5/2N5/PP1PPPPP/R1BQKBNR b KQkq - 2 2":["g6","e6"],"rnbqkb1r/pppppppp/5n2/8/2P5/5N2/PP1PPPPP/RNBQKB1R b KQkq - 2 2":["g6","e6","c5"],"rnbqkbnr/pppppppp/8/8/8/5N2/PPPPPPPP/RNBQKB1R b KQkq - 1 1":["Nf6"],"rnbqkb1r/pppppppp/5n2/8/8/5NP1/PPPPPP1P/RNBQKB1R b KQkq - 0 2":["g6"]}[o];if(P){var c=P[Math.floor(120*Math.random())%P.length],l=r.move(c);if(l){var u=r.fen();r.undo(),Game.enrich_move(l,o,u)}e(function(){a(l)},900)}else{e(function(){a(null)&&console.log("give up: timeout 3600.")},3600);var f={f:o,p:t,l:p};n.call("play",f,null,null,function(r){"answered"==r.status?a(r.move):"working"==r.status?e(function(){n.call("play",f,null,null,function(e){"answered"==e.status?a(e.move):a(null)},function(e){a(null)})},2e3):a(null)},function(e){a(null)})}}}}]),chessStories.service("contactUsService",["apiService",function(e){return{send:function(n,r,t,p){var s={s:n,t:r,g:t};return e.call("contact_us",{},s,"form",function(e){var n=null;try{var r={};return r.status=e.status,"ok"!=r.status&&(n="An error occurred. Please try again later."),p(n,r)}catch(n){return p(n,null)}},function(e){return p("Failed to contact the server. Try again later.",null)})}}}]),chessStories.service("websiteService",["Config","$location","$filter","$window",function(e,n,r,t){var p=function(r){var t=e.webSiteUrls[r];if(!t)return console.log("*** trying to go to unknown website",r,"page."),null;var p=n.host();return p.startsWith("app.")?p=p.replace("app.",""):p.startsWith("app-")?p=p.replace("app-",""):p.includes("-app.")&&(p=p.replace("-app.",".")),n.protocol()+"://"+p+t};return{get_url_for:p,get_video_page_name_for_lang:function(e){var n=r("langcode")(e).toLowerCase();return["en","de","es"].includes(n)||(n="en"),"video_"+n},go:function(e,n){var r=p(e);r&&(n?t.open(r,"_blank").focus():t.location.href=r)},get_base_url:function(){return n.protocol()+"://"+n.host().replace("app.","")}}}]),chessStories.service("themeService",["Config","$rootScope",function(e,n){return{url_of_piece:function(e){var r="00";return n.currentUser&&n.currentUser.prefs&&n.currentUser.prefs.pieces&&(r=n.currentUser.prefs.pieces),"/static001767/assets/img/chesspieces/"+r+"/"+e+".svg"}}}]),chessStories.service("pgnSplitterService",[function(){var e=function(e){if("["!=(e=e.trim())[0]||"]"!=e[e.length-1])return null;var n=(e=e.slice(1,e.length-1).trim()).match(/^[A-Za-z_][A-Za-z0-9_]*/);if(!n)return null;n=n[0];var r=e.slice(n.length),t=r.match(/^\s*(:\s*|=\s*|)/);if(!t||!t[0].length)return null;t=t[0];var p=r.slice(t.length);if(!t.trim()||"'\"".indexOf(p.slice(0,1))>=0){if(p.length<2)return null;var s=p[0];if('"'!=s&&"'"!=s)return null;if(p[p.length-1]!=s)return null;if((p=p.slice(1,p.length-1).trim()).indexOf(s)>=0)return null}else if(p.indexOf("]")>=0)return null;return"Result"==n&&(p=p.replace(/\u2013/g,"-").replace(/\00bd/g,"1/2")),[n,p]},n=function(n){try{n=n.trim().split("\n");var r={};return n.forEach(function(n){var t=e(n);if(!t)return!1;r[t[0]]=t[1]}),r}catch(e){return null}},r=function(n){var r=n.trim().split("\n");return!!r&&!!e(r[0])};return{splitMultiGamePgn:function(e,t){var p=function(e){for(var n=e.split("\n\n"),t=0;t<n.length;t++)if(t%2==0)for(;t<n.length-1&&r(n[t+1]);)n[t]=(n[t]+"\n"+n[t+1]).replace(/\n\s*\n/g,"\n"),n.splice(t+1,1);else for(;t<n.length-1&&!r(n[t+1]);)n[t]=(n[t]+"\n"+n[t+1]).replace(/\n\s*\n/g,"\n"),n.splice(t+1,1);if(1==n.length&&!r(n[0])){var p=n[0],s=p.substr(-7).replace(/\u00bd/g,"1/2").replace(/\u2013/g,"-");s.endsWith("*")||s.endsWith("1/2-1/2")||s.endsWith("1-0")||p.endsWith("0-1")||(p+=" *"),n=['[X ""]',p]}return n}(e=e.replace(/[ \t]*\r\n?[ \t]*/g,"\n")),s=p.filter(function(e,n){return n%2==0}),o=!s.length,i=s.map(function(e,r){return(e=n(e))?(e.name=Game.make_game_name(e),e.index=r):o=!0,e});return t(o,p,i)},parseHeaders:n}}]),chessStories.service("shareService",["$rootScope","$filter","apiService",function(e,n,r){return{create:function(e,n){r.call("create_share",{},e,null,function(e){n&&n(e)},function(e){})},get:function(e,n){r.call("get_share",{k:e},null,null,function(e){n(e)},function(e){n({err:e})})}}}]),chessStories.service("keyMomentsService",["$rootScope",function(e){var n=[7,15,99],r=n[0];function t(e){return e&&"a"!==e?n=>Game.is_move(n)&&n.color===e&&n.interesting:e=>Game.is_move(e)&&e.interesting}function p(e){return e.jparam.exp_color}function s(e,n,r){if(e&&n){var s=e.main_line_move(),o=e.body.indexOf(s)+1,i=t(p(n)),a=Game.find_next_move(e.body,o,r,e=>i(e)&&e.misplay_against!==s);return a?a.misplay_against:null}}return{mark_key_moments:function(t){if(!(t.body.length<=1)){var p=_.partition(t.moves,e=>"w"===e.color),s=n[e.currentUser.prefs.nmisp]||r,o=_.chain(p[0]).sortBy("interest_r").last(s).reject(e=>!e.interest_r),i=_.chain(p[1]).sortBy("interest_r").last(s).reject(e=>!e.interest_r),a=e=>{"g"!==e.exp_qual&&Game.mv2uci(e)!==e.exp_best&&(e.interesting=!0,0===e.index_number?e.misplay_against=t.body[0]:e.index_number&&(e.misplay_against=t.moves[e.index_number-1]))};t.moves.forEach(e=>e.interesting=!1),o.forEach(a),i.forEach(a),e.$broadcast("key-moments-upd",{game:t})}},get_key_moments:function(e,n){if(e&&n)return _.chain(e.moves).filter(t(p(n))).pluck("misplay_against").value()},next_key_moment:s,end_of_misplays:function(e,n,r){return!s(e,n,r)},first_key_moment:function(e,n){var r=Game.find_next_move(e.body,0,1,t(p(n)));return r?r.misplay_against:null}}}]),chessStories.service("scoresService",["$rootScope","$timeout","$filter","Fens","apiService","engPool",function(e,n,r,t,p,s){var o=null,i=!1,a={},P=1e3,c={1:{depth:9,movetime:800},2:{depth:21,movetime:3310},3:{depth:99,movetime:3310}},l=c[1].depth,u=c[2].depth;function f(e){return(e>0?"+":"")+e/100}function d(e){return!m(e)}function b(e){return _.isFinite(e)&&e<99e3&&e>-99e3}function m(n){if(!n)return null;var r=n.moves,t=n.body.length?n.body[0]:null,p=1,s=_.findLastIndex(r,function(e){return!_.isFinite(e.score)});if(-1===s){if(t&&!_.isFinite(t.score))return{mvIdx:-1,mv:t,next_mv:r.length>0?r[0]:null,pass_number:p,game:n};if(p=2,-1===(s=_.findLastIndex(r,function(e){return e.depth<=l}))&&t&&t.depth<=l)return{mvIdx:-1,mv:t,next_mv:r.length>0?r[0]:null,pass_number:p,game:n};if(-1===s){var o=n.get_main_line_sig();return n.has_scores_for!=o&&(n.has_scores_for=o,e.$broadcast("score-game-done",{game:n})),null}}return{mvIdx:s,mv:r[s],next_mv:s>=r.length-1?null:r[s+1],pass_number:p,game:n}}function v(r,t){null===t&&(t=P);var p=r.key;0===t?(a[p]&&(n.cancel(a[p]),delete a[p]),d(r)&&(e.$broadcast("score-game-done",{game:r}),w(r))):a[p]||(a[p]=n(function(){d(r)&&(e.$broadcast("score-game-done",{game:r}),w(r)),delete a[p]},t))}function g(n,r,t){var p=r.score_cp,s=r.score;1==(r.depth>l?2:1)&&b(p)&&(s=f(p)),n.depth&&(r.depth,n.depth),n.depth=r.depth,n.score=p,n.score_str=s,k(n,null),e.$broadcast("score-mv-done",{mv:n,game:t})}function h(e,n){var r=e.moves;if(0===r.length)n.is_best=!1,n.loss=0,n.bestplay=r,n.score=e.score_cp,n.score_str=f(n.score);else{var t=r[0];t.score=e.score_cp;n.depth&&n.depth;n.san==t.san?(n.is_best=!0,n.bestplay=null,(n.depth&&n.depth<e.depth||!n.depth)&&(n.depth=e.depth,n.score=e.score_cp,n.score_str=f(n.score))):(n.is_best=!1,n.loss=Math.abs(t.score-n.score),n.bestplay=r)}R(n,null)}function k(e,n){if(e){if(null===n)return e.loss=null,void(e.qual=null);_.isFinite(e.disp_score)&&_.isFinite(n)&&!e.is_best&&!e.opname?(e.loss=("w"==e.color?1:-1)*(n-e.disp_score),e.loss=Math.max(e.loss,0),e.loss=function(e,n){var r=Math.max(e.loss||0,0);return r>5e4&&(r=500),r}(e)):e.loss=0;var t=r("qual_ch")(e);e.qual={"??":"blunder","?":"mistake","?!":"inaccuracy","":""}[t]}}function N(e,n,r){if(e!=t.START){var p=null;o.analyze(e,n,function(e,t){"result"===e?n.depth>u?r(t):p=t:"done"===e&&r(p)})||r(null)}else{var s=n.depth||21;r({depth:s,score:"+0.21",score_cp:21,time:5,moves:[{color:"w",from:"e2",to:"e4",piece:"p",flags:"b",san:"e4",uci:"e2e4",ply:0,fen_after:"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1"}]})}}function B(e,n,r){var t,p=e.moves,s=null;if(n>=0?(t=p[n],s=n>=e.moves.length-1?null:e.moves[n+1]):(t=e.body[0],s=p[0]),!t.depth||r.depth>t.depth){if(n>=0)k(t,(n?p[n-1]:e.body[0]).disp_score);g(t,r,e),s?h(r,s):t.eng_info=r,q(e,n),v(e,null)}}function q(n,r){for(var t,p,s=n.moves;r<s.length-1&&s[r+1].is_best;)r++;for((t=s[r]).disp_score=t.score,t.disp_depth=t.depth,p=t;p.is_best&&r>=0;r--)t=s[r],p=r>0?s[r-1]:n.body[0],o(t,p);function o(r,p){p.disp_score=Math.round(.8*r.disp_score+.2*p.score),p.disp_depth=Math.round(.8*r.disp_depth+.2*p.depth),p.score_str=f(t.disp_score),e.$broadcast("score-mv-done",{mv:p,game:n})}Game.is_sentinel(p)||k(p,(r>0?s[r-1]:n.body[0]).disp_score)}function R(e,n){k(e,n&&null!==n.disp_score?n.disp_score:e.bestplay&&e.bestplay.length?e.bestplay[0].score:e.is_best?e.disp_score:null)}var Q=[];function K(){if(!i){i=!0;var r=function(){for(var e=0;e<Q.length;++e){var n=m(Q[e]);if(n)return n}return null}();if(!r)return i=!1,!1;r.game.has_scores_for=null,o||(o=s.get_engine());var t=r.mv,p=r.mvIdx,a=r.next_mv,P=r.pass_number,l=r.game,u=l.moves;if(p>=0&&function(e,n,r){return n>=0&&n<e.moves.length&&e.moves[n]===r}(l,p,t)){var f=0==p?l.body[0]:u[p-1];f.eng_info&&(h(f.eng_info,u[p]),f.eng_info=null)}e.$broadcast("score-working",{mv:t,game:l}),N(t.fen,c[P],function(r){if(!r)return i=!1,void e.$broadcast("score-mv-done",{mv:t,game:l});a?(h(r,u[p+1]),R(a,t)):t.eng_info=r,g(t,r,l),(!t.disp_depth||t.depth>t.disp_depth)&&(t.disp_score=t.score,t.disp_depth=t.depth),i=!1,m(l)?w(l):e.$broadcast("score-game-done",{game:l}),n(K,60)})}}var y=4;function w(n){if(n&&n.moves&&n.moves.length>0){var r=_.every(n.moves,function(e){return _.isFinite(e.score)});e.$broadcast("scores-game-changed",{game:n,immediately:r})}}return{set_games:function(e,r){var t,p,s=(Q=e).indexOf(r);s>0&&(p=s,Q=(t=Q).slice(p).concat(t.slice(0,p)),r.iter_items(function(e){(Game.is_move(e)||Game.is_sentinel(e))&&_.isFinite(e.score)&&!_.isFinite(e.disp_score)&&(e.disp_score=e.score,e.disp_depth=e.depth)})),n(K,5)},suspend:function(e){e},add_score:function(n,r,t,p,s){var o=n.moves,i=o[r];if(!i.depth||p>=i.depth){i.score=t,i.score_str=f(i.score),i.depth=p;var a=s();i.is_best=!a||Game.mv2uci(a)==Game.mv2uci(i),(!i.disp_depth||p>i.disp_depth)&&(i.disp_score=i.score,i.disp_depth=p),r+1<o.length&&k(o[r+1],i.disp_score),i.is_best?(i.bestplay=null,q(n,r)):i.bestplay=[a],e.$broadcast("score-mv-done",{mv:i,game:n}),d(n)&&e.$broadcast("score-game-done",{game:n})}k(i,(r?o[r-1]:n.body[0]).disp_score)},add_score_local:B,is_complete:d,schedule_game_done:v,set_mv_cp_loss:k,is_nonmate_score:b,stabilize_game:function n(r){if(!i){o||(o=s.get_engine());var t=function(e){var n=e.body,r=_.findLastIndex(n,function(e){return Game.is_move(e)&&!e.s_stable});if(-1===r)return null;var t=n[r];return r>=n.length-1||n[r+1],{mvIdx:r,mv:t,pass_number:3,game:e}}(r);if(t){var p=t.mv,a=p.depth||1,P=[],l=!1;i=!0,e.$broadcast("score-working",{mv:p,game:r}),N(p.fen,c[3],function(e){if(e&&e.score){if(e.time<500)return P=[],void(l=!0);if(e.time>=1e4)B(r,p.index_number,e),p.s_stable=!0;else if(e.depth>a){if(a=e.depth,P.push(100*e.score),P.length>=y)P.shift();else if(P.length<y)return void B(r,p.index_number,e);if(_.max(P)-_.min(P)>=15)return;B(r,p.index_number,e),p.s_stable=!0}}else l||(p.s_stable=!0);p.s_stable&&(o.stop(),i=!1,n(r))})}else v(r,0)}}}}]),chessStories.service("gameService",["$rootScope","apiService","scoresService","keyMomentsService","Fens",function(e,n,r,t,p){var s=null;function o(e,n){if(null!==s){var r,t,p,o,i,a,P,c=s.find(function(e){return e.key===n});c?s=s.filter(function(e){return e.key!==n}):c={key:n},c={...c,fen:e.fen,name:e.name,origin:e.origin,pgn:e.pgn,upd:(r=60*(new Date).getTimezoneOffset()*1e3,t=Date.now()+r,p=new Date(t),o=(p.getMonth()+1).toString(),i=p.getDate().toString(),a=p.getHours().toString(),P=p.getMinutes().toString(),p.getFullYear()+"-"+(o.length>1?o:"0"+o)+"-"+(i.length>1?i:"0"+i)+" "+(a.length>1?a:"0"+a)+":"+(P.length>1?P:"0"+P))},s.unshift(c)}}function i(e){if(e.resave_params_q.length>0){var n=e.resave_params_q.shift();a(e,n[0],n[1],n[2])}}function a(e,p,s,a){if("*intro*KL"!=e.key)if(e.saving)!function(e,n,r,t){e.resave_params_q.push([n,r,t])}(e,p,s,a);else{e.saving=!0;var P=_.map(e.moves,function(e){return _.map((e.bestplay||[]).slice(0,4),function(e){return e?Game.mv2uci(e):""})}),c={key:e.key,pgn:e.as_pgn(),name:Game.make_game_name(e.headers),origin:e.origin,positions:_.map(e.positions,function(e){return e.to_simple_obj()}),reason:p,fen:s,ss:e.body[0].score||null,ssd:e.body[0].depth||null,moves:_.map(e.moves,function(e){return Game.mv2uci(e)}),scores:_.map(e.moves,function(e){return e.score}),depths:_.map(e.moves,function(e){return e.depth}),levels:e.levels,aces:e.aces,bests:P,share_key:e.share_key||""};n.call("game",{},c,null,function(n){if(e.saving=!1,e.save_time=Date.now(),n&&n.key){e.key=n.key,e.headers.URL=n.url,function(e,n,t,p){for(var s=e.moves,o=e.get_start_fen(),i=0;i<s.length;++i){if(i>=n.length||i>=t.length||i>=p.length)return;t[i]&&r.add_score(e,i,n[i],t[i],function(){var e=p[i][0];if(!e)return null;var r=Game.ucis2moves(o,[e]);return!r||r.length<1?null:(r[0].score=n[i],r[0])}),o=s[i].fen}}(e,n.scores,n.depths,n.bests),e.levels=n.levels;for(var p=0;p<e.levels.length;p++)e.moves[p].interest_r=e.levels[p];t.mark_key_moments(e),o(c,n.key),a&&a(null)}else a&&a("server_error");i(e)},function(n){e.saving=!1,console.log("save: an error occurred",n),a&&a(n),i(e)})}else a&&a("no_game")}function P(e){e.time_since_last_save()>13e3&&a(e,"changed",null)}e.$on("scores-game-changed",function(e,n){var r=n.game;n.immediately?a(r,"changed",null):P(r)});return{getQuickTourGame:function(e){n.call("game_for_quick_tour",{},null,null,function(n){var t=n.game,p=new Game(t.pgn);p.positions=t.positions,p.set_origin(t.origin);for(var s=21,o=p.moves.length,i=0;i<o;i++){var a=p.moves[i];a.score=t.scores[i],a.depth=t.depths[i],r.set_mv_cp_loss(a,s),s=a.score,a.accurate=!0,a.interest_r=t.levels[i],a.ace=t.aces[i],a.bestplay=t.bests?t.bests[i]:[]}p.key=t.key,p.fen=t.headers.CSThumbnail||p.headers.FEN,e(p,null)},function(n){e(null,n)})},getGame:function(e,p){n.call("game",{k:e},null,null,function(e){var n=e.game,s=new Game(n.pgn);s.share_key=n.share_key,s.set_origin(n.origin),s.set_positions(n.positions),s.body[0].score=n.ss,s.body[0].depth=n.ssd;for(var o=_.isFinite(n.ss)?n.ss:21,i=s.body[0].fen,a=(new Chess,s.moves.length),P=0;P<a;P++){var c=s.moves[P];c.score=P<n.scores.length?n.scores[P]:null,c.depth=P<n.depths.length?n.depths[P]:null,r.set_mv_cp_loss(c,o),c.accurate=!0,c.interest_r=P<n.levels.length?n.levels[P]:null,c.ace=P<n.aces.length?n.aces[P]:null;var l=P<n.bests.length?n.bests[P]:null;l&&l.length>0&&!l[0]?(c.bestplay=null,c.score=null,c.loss=null,c.qual=null):c.bestplay=s.ucis2moves(i,l),i=c.fen,o=c.score}s.key=n.key,s.fen=s.headers.CSThumbnail||s.headers.FEN,t.mark_key_moments(s),s.save_time=Date.now(),p(s,null)},function(e){p(null,e)})},getExamples:function(e,r,t,p){n.call("games/examples",{k:e,d:r},null,null,function(e){e.games=e.games.map(function(e){return new Game(e)}),t(e)},function(e){p&&p(e)})},getHistory:function(e,r,t){null===s||t?function(e,r){n.call("games/history",{},null,null,function(n){e(n.game_infos,n.status)},function(e){r&&r(e)})}(function(n,r){s=n||null,e&&e(s,r)},r):e&&e(s)},touch_game:function(e){o(e,e.key)},save:a,condSave:P,update:function(e,r,t,p,o){var i,a={g:e};!0!==r&&!1!==r||(a.d=r?"1":"0",r&&(i=a,null!==s&&(s=s.filter(function(e){return e.key!==i.g})))),_.isString(t)&&(a.n=t),_.isString(p)&&(a.t=p),n.call("game_update",{},a,null,function(e){e&&o&&o(e.status,e.msg)},function(e){console.log("game_update: an error occurred",e),o&&o("error",e)})}}}]),chessStories.service("importGameService",["pgnSplitterService",function(e){const n=30;function r(e,n,r,t){const p=function(e,n,r){return"https://api.chess.com/pub/player/"+e+"/games/"+n+"/"+(r<10?"0":"")+r}(e,n,r);var s=new XMLHttpRequest;s.addEventListener("error",function(e){t(null)}),s.addEventListener("abort",function(e){t(null)}),s.onreadystatechange=function(){console.log("onreadystatechange:",s.readyState,s.status),4==s.readyState&&(200==s.status?function(e){var n=null;try{n=JSON.parse(e)}catch(e){console.log("*** GET "+p+" JSON.parse error:",e)}t(n.games)}(s.responseText):t(null))},s.open("GET",p,!0),s.send(null)}function t(e){var n=null;/^.*:\/\//.test(e)||(e="https://"+e);try{n=new URL(e)}catch(e){}return n&&"lichess.org"===n.host?n:null}function p(n,r){e.splitMultiGamePgn(n,function(e,n,t){if(e)console.log("*** Import from Lichess:",e),r([]);else{var p=_.map(t,function(e){var r=e.index,t=n[2*r]+"\n\n"+n[2*r+1];return new Game(t)});r(p)}})}function s(e,r){const t=function(e){return"https://lichess.org/api/games/user/"+e+"?max="+n+"&perfType=ultraBullet,bullet,blitz,rapid,classical,correspondence"}(e);var s=new XMLHttpRequest;s.addEventListener("load",function(e){console.log("load done; ev:",e)}),s.addEventListener("error",function(e){console.log("load error; ev:",e)}),s.addEventListener("abort",function(e){console.log("load aborted; ev:",e)}),s.onreadystatechange=function(){console.log("onreadystatechange:",s.readyState,s.status),4==s.readyState&&(200==s.status?p(s.responseText,r):r(null))},s.open("GET",t,!0),s.send(null)}return{getChesscomRecentGames:function(e,t){var p=new Date,s=p.getUTCFullYear(),o=p.getUTCMonth()+1,i=[],a=0;function P(e){if(a>=n||"chess"!=e.rules)return null;try{var r=new Game(e.pgn);return++a,r}catch(e){return null}}!function p(s,o,a){r(e,s,o,function(e){if(e){e.sort(function(e,n){return n.end_time-e.end_time});var r=_.filter(_.map(e,P),function(e){return null!==e});i=i.concat(r),a>=3||i.length>=n?t(i):(--o<1&&(--s,o=12),p(s,o,a+1))}else t(i)})}(s,o,0)},getLichessRecentGames:s,importFromLichess:function(e,n){var r=function(e){var n=t(e);if(!n)return null;var r=n.pathname.split("/");if(r.length<2)return null;var p=r[1];return p.length&&"@"!==p?r[1]:null}(e);r?function(e,n){const r=function(e){return"https://lichess.org/game/export/"+e}(e);var t=new XMLHttpRequest;t.onreadystatechange=function(){console.log("onreadystatechange:",t.readyState,t.status),4==t.readyState&&(200==t.status?p(t.responseText,n):n(null))},t.open("GET",r,!0),t.send(null)}(r,n):s(e,n)},parseLichessURL:t}}]);
