"use strict";angular.module("chessStories").directive("appBoard",["$timeout","nudgeService","fenService","i18nService","themeService","arrowsService","playCtrlService",function(e,r,o,n,t,a,i){var s=n.phrases,c=0;return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/board/boardView.html",link:function(r,o){var n=!1,t=null;o.on("touchstart",".game-nav-btn",o=>{o&&o.stopPropagation(),n=!0,t||(t=e(()=>{n&&(o.target.className.match(/back/)?r.onGameStart():r.onGameEnd()),t=null},680))}),o.on("touchend",".game-nav-btn",e=>{e&&e.stopPropagation(),n=!1}),$(".board").attr("app-board","").replaceAll($(".board-placeholder")),r.$broadcast("size-changed"),$("#chessboard-cont").css("opacity","1")},controller:["$scope","$rootScope","$state","acctService","gameService","playService","Fens","engPool",function(n,d,u,l,p,f,m,h){var b=this;this.source=!1,this.target=!1,n.boardArrowsDlgShown=!1,n.moreBtnsMenuShown=!1;var v=function(){var e=document.createElement("style");document.head.appendChild(e);var r=e.sheet,o=g(.5,null,!1);r.insertRule(o,0);var o=g(.5,null,!0);return r.insertRule(o,1),r}();function g(e,r,o){var n=Math.round(Math.min(Math.max(255*e,0),255)).toString(16);n.length<2&&(n="0"+n);var t="#ff0000"+n;return(o?"BODY.darkmode ":"")+".square-55d63.threatened"+(r?'[data-c="'+r+'"]':"")+" IMG.piece-417db"+"{"+("filter: "+(o?"invert(0.9) hue-rotate(180deg) grayscale(1) ":"")+"drop-shadow(1px 1px 0px "+t+") drop-shadow(-1px 1px 0px "+t+") drop-shadow(1px -1px 0px "+t+") drop-shadow(-1px -1px 0px "+t+") ;\n")+"}"}function w(){var[e,r,o]=a.get_arrows_opacity_for_display();function n(e,r){!function(e,r){var o,n=v;if(o=g(e,r,!1),n.insertRule(o,n.cssRules.length),o=g(e,r,!0),n.insertRule(o,n.cssRules.length),!r)for(;n.cssRules.length>2;)n.deleteRule(0)}(e,r)}e<.2?d3.selectAll("#board1 SVG.arrow").style("pointer-events","none"):d3.selectAll("#board1 SVG.arrow").style("pointer-events","auto"),r>0&&o>0?($(".arrow").css("opacity",r),n(r),$(a.select_arrows_by_eids()).each((e,r)=>{$('.arrow[data-c~="'+r+'"]').css("opacity",o),n(o,r)})):($(".arrow").css("opacity",e),n(e)),e<.05&&null===a.arrows_opac_override?$(".arrow").css("display","none"):$(".arrow").css("display","")}function y(){var r=n.curr_fen.split(" ");n.is_clear="8/8/8/8/8/8/8/8"==r[0],n.is_clear&&(r=m.CLEAR.split(" ")),n.whose_turn=r[1];var o=r.join(" ");o!=n.curr_fen&&(n.currTab.fen=o,n.curr_fen=o,e(function(){n.$apply()},2)),n.board.highlight_check(o)}function k(e,r,o){_.isArray(e)||(e=[e]);var t=n.board.cboard,a=function(e,n){if(!r||!r()){var i=e[n];t.animate(i.source,i.destination,i.piece,i.variant,function(){++n<e.length?a(e,n):o&&o()})}};a(e,0)}n.url_of_piece=function(e){return t.url_of_piece(e)},b.arrow_defs=[],n.set_arrows_opacity_now=function(){w()},n.arrows_service=a,n.$watchGroup(["arrows_service.arrow_curr_opacity","arrows_service.arrows_opac_override","arrows_service.arrows_hide"],w),d.$on("arrows_selected",w),n.$watchCollection("light_attrs",function(e){n.board.clearLight(),e.forEach(function(e){n.board.boardLight(e)})}),n.$watchGroup(["curr_fen","currTab.currJob.fen","currTab.topic_arrows","role_arrows","currTab.move_arrows_fen","currTab.move_arrows","currTab.last_move_arrow","currTab.currJob.partial_arrows"],function(e){if(n.currTab){var r=n.currTab,o=r.currJob,t=n.curr_fen,a=o?o.baseFen():"",i=t==a?r.topic_arrows:[],s=t==a?n.role_arrows:[],c=r.move_arrows_fen==t?r.move_arrows:[],d=r.last_move_arrow||"",u=function(e,r,o,n,t){var a=[],i=function(e){_.each(e.split(";"),function(e){e.split(",").length<4||a.push(e)})};return _.each(e,i),_.each(r,i),_.each(o,i),_.each(n,i),i(t),a}(i,s,c,r.currJob&&t==a?r.currJob.partial_arrows:[],d);u.join("@")!=b.arrow_defs.join("@")&&(b.arrow_defs=u,C())}}),n.onArrowsHide=function(){if(!n.isInBasePosition())return n.onReset(),a.hide_all(!1),void a.set_pref("arrow_opacity",Math.max(.35,a.get_arrows_opacity_for_display()[0]));a.hide_all(!a.hide_all())},n.setEmphasizedArrow=function(){w()},n.board={},n.curr_fen=m.START,n.board.highlight_check=function(e){var r=n.curr_fen.split(" ")[1];$("#board1 .in-check").removeClass("in-check"),new Chess(e).in_check()&&$('#board1 .square-55d63 [data-piece="'+r+'K"]').parent().addClass("in-check")},n.$watch("curr_fen",y),y(),n.board.startGhostAnims=function(e){var r=n.board.cboard.fen();n.board.cboard;k(e,function(){return r!=n.board.cboard.fen()})},n.board.setFen=function(e,r,o=null){var t=o||n.currTab;if(r&&"no-anim"!=r){var a=n.board.cboard.fen();n.board.cboard;k(r,function(){return a!=n.board.cboard.fen()},function(){a==n.board.cboard.fen()&&n.board.setFen(e,"no-anim")})}else{e&&"start"!=e||(e=m.START);var i=e.split(" ");n.board.cboard.position(i[0],"no-anim"!=r,r),e!=t.fen&&(t.last_move_arrow=null),t.fen=e,n.curr_fen=e,n.rebuildCapturedPieces()}},n.light_attrs=[],a.select_arrows_by_eids([]);var T=function(e){return"abcdefgh".split("").indexOf(e)};function C(o){n.board.deleteAllArrows(),n.board.clearLight();var t,a,i,s=(t=b.arrow_defs,a=new r.Nudger,i=_.map(t,function(e){for(var o=e.split(",")[2].split(" "),n=[],t=0;t<o.length-1;t++){var i=new r.Segment(o[t],o[t+1]);n.push(i),a.add(i)}return{arrow_def:e,segs:n}}),a.assign_nudges(),_.map(i,function(e){var r=_.map(e.segs,function(e){return e.nudge?e.nudge:[0,0]});return{arrow_def:e.arrow_def,nudges:r}})),d=n.board.cboard.fen();c++,e(function(){--c||n.board.cboard.fen()==d&&(s.forEach(function(e){!function(e,r){var o=e.split(","),t=o[0],a=parseInt(o[1]),i=o[2].split(" "),s=o[3].split(" "),c="";o.length>4&&(c=o[4]);!function(e,r,o,t,a,i){var s=t.join(" ").trim();if(1==r.length){var c=r[0];return void $("#board1 .square-"+c).addClass("threatened").attr("data-c",s)}if(2==r.length&&-1!=e.split(" ").indexOf("lastmove"))return $("#board1 .square-55d63.lastmove").removeClass("lastmove"),$("#board1 .square-"+r[0]).addClass("lastmove"),void $("#board1 .square-"+r[1]).addClass("lastmove");var d=function(r,o){$(".square-"+r[0]);var t=A.sq_origin(r[0]),a=$("#board1 .square-a1").width();n.board.cboard.orientation();x=.32*a,P=.44*a;var i=_.last(r);q=$("#board1 .square-"+i).children("IMG").length?.37*a:.27*a,x=.39*a,q=.4*a,2==r.length&&(-1!=e.split(" ").indexOf("lastmove")?x=.18*a:A.vlen(A.vsub(A.sq_center(r[0]),A.sq_center(r[1])))<1.5*a&&(x=.33*a,q=.3*a));for(var s=[],c=0;c<r.length;c++)s.push(A.vsub(A.sq_center(r[c]),t));if(!o||!o.length){o=[];for(var c=0;c<r.length;c++)o.push([0,0])}return A.make_curve_str(s,o)};function u(e){return e*(Math.PI/180)}var s="";t&&t.length>0&&(s=' data-c="'+t.join(" ")+'"');s=t.join(" ");var l=$("#board1").find(".square-a1").width(),p=o,f=e.split(" "),m=-1!=f.indexOf("mseg-xray"),h=-1!=f.indexOf("o-atk-lcl")||-1!=f.indexOf("o-thr-lcl");o=1.3*(o=(o=.35*o+15)*l*.002);var b,v,g,w,y,k=n.board.cboard.orientation(),C="#board1 .square-"+r[0],M={width:16,height:16,class:e+" arrow arrow-"+r.join("-"),weight:p};s.length&&(M["data-c"]=s);""!=a&&(M["data-aa"]=a);var S=d3.select(C).append("svg").attr(M),j=(d3.svg.line().x(function(e){return e[0]}).y(function(e){return e[1]}).interpolate("linear"),d3.svg.line().x(function(e){return e[0]}).y(function(e){return e[1]}).interpolate("none"));S.append("path").attr({d:d(r,i),class:"arrow-blip","stroke-width":0,"stroke-linecap":"round","stroke-linejoin":"round",fill:"none",opacity:1}),S.append("path").attr({d:d(r,i),"stroke-width":o+2.6,stroke:"#fff","stroke-linecap":"round","stroke-linejoin":"round",fill:"none",opacity:.7}),w=S.append("path").attr({d:d(r,i),"stroke-width":o,"stroke-linecap":"round","stroke-linejoin":"round",fill:"none"}),m?w.attr("stroke-dasharray","0,"+1.6*o):h&&w.attr("stroke-dasharray","9,4,5,4,2600");var R=r[r.length-2],U=r[r.length-1];if("black"==k)var E=-Number(U[1])+Number(R[1]),B=-T(U[0])+T(R[0]);else var E=Number(U[1])-Number(R[1]),B=T(U[0])-T(R[0]);b=180*Math.atan2(-E,B)/Math.PI;var F=w.node(),G=F?F.getTotalLength():1;v=F?F.getPointAtLength(G).x:0,g=F?F.getPointAtLength(G).y:0,y=0;var N=1.4*o,L=[[y,(N*=.8)/2],[y-1*N,1.23*N+N/2],[y+2.11*N,N/2],[y-1*N,-1.23*N+N/2],[y,N/2]];S.append("path").attr({d:j(L),transform:"translate("+(v+N/2*Math.sin(u(b)).toFixed(2))+", "+(g-N/2*Math.cos(u(b)).toFixed(2))+") rotate("+b+",0,0)","stroke-width":2.6,stroke:"#fff",fill:"#fff"}),S.append("path").attr({d:j(L),class:"arr-con",transform:"translate("+(v+N/2*Math.sin(u(b)).toFixed(2))+", "+(g-N/2*Math.cos(u(b)).toFixed(2))+") rotate("+b+",0,0)"})}(t,i,a,s,c,r)}(e.arrow_def,e.nudges)}),n.board.addArrowEvents(),w(),n.light_attrs.forEach(function(e){n.board.boardLight(e)}))},o?5:210)}n.board.clearLight=function(){$("#board1 .light").removeClass("light")},n.board.boardLight=function(e){if(e)for(var r=(e=e.split(" "))[0],o=e[e.length-1],n=T(r[0]),t=T(o[0]),a=t>n?1:t==n?0:-1,i=+r[1],s=+o[1],c=s>i?1:s==i?0:-1,d=n,u=i;;d+=a,u+=c){if($("#board1 .square-55d63[data-square="+("abcdefgh"[d]+u)+"]").addClass("light"),d==t&&u==s)break}},n.board.bottom_color="w",n.board.flip=function(){"white"==n.currTab.board_orientation?n.currTab.board_orientation="black":n.currTab.board_orientation="white"},n.board.rotate=function(r,o){"w"==r?r="white":"b"==r&&(r="black");var t=n.board.cboard.orientation();if(!r||r!=t){var a="white"==t?"rotate-right":"rotate-left";$("#board1").addClass(a),e(function(){$("#board1").removeClass(a),r?n.board.cboard.orientation(r):(n.board.cboard.flip(),r=n.board.cboard.orientation()),n.board.bottom_color="white"==r?"w":"b",$("#board1 .spare-pieces-7492f img").css("height",0),$("#board1 .spare-pieces-7492f img").css("width",0),C(!0),n.rebuildCapturedPieces()},350)}},n.board.get_sq_location=function(e){var r=e.charCodeAt(0)-"a".charCodeAt(0),o=e.charCodeAt(1)-"1".charCodeAt(0);"black"==n.board.cboard.orientation()&&(r=7-r,o=7-o);var t=$("#board1").width()/8;return{top:o*t,left:r*t,dim:t}},n.board.setTurn=function(e){"flip"==e?(e="w"==n.whose_turn?"b":"w",["assisted","restricted","play"].includes(n.currTab.play_mode.mode)&&function(e){if(!n.currentUser||"admin"!==n.currentUser.level)return;if(e.game.curr_move&&"nullmv"===e.game.curr_move.kind)e.game.flatNext(1)||n.onDelFromHere();else{var r={kind:"nullmv",piece:null,from:null,to:null,fen:n.curr_fen};n.play_move(e.play_mode,r,!0)}}(n.currTab)):e=e[0];var r=n.curr_fen.split(" ");r[1]=e;var t=r.join(" ");t=o.fix_fen(t),n.board.setFen(t),n.currTab.setjp("p",t,"",null,s.job_name_setup,"")};var x,P,q,A={sq2xy:function(e,r){var o,t="origin"==r?0:.5,a=$("#board1 .square-a1").width();if("white"==n.board.cboard.orientation())var i=(T(e[0])+t)*a,s=(8-Number(e[1])+t)*a;else i=(o=e[0],(7-T(o)+t)*a),s=(Number(e[1])-8+t)*a;return[i,s]},sq_origin:function(e){return this.sq2xy(e,"origin")},sq_center:function(e){return this.sq2xy(e,"center")},hypot:function(e,r){return Math.sqrt(e*e+r*r)},vsub:function(e,r){return[e[0]-r[0],e[1]-r[1]]},vadd:function(e,r){return[e[0]+r[0],e[1]+r[1]]},vlen:function(e){return this.hypot(e[0],e[1])},vmul:function(e,r){return[e[0]*r,e[1]*r]},vchopped:function(e,r){return this.vmul(e,r/this.vlen(e))},round01:function(e){return Math.round(10*e)/10},round01pt:function(e){return[this.round01(e[0]),this.round01(e[1])]},make_curve_str:function(e,r){for(var o,n=[[0,0]],t=1;t<e.length;t++)o=t==e.length-1?q:P,n.push(this.vadd(e[t],this.vchopped(this.vsub(e[t-1],e[t]),o)));var a=[];for(t=0;t<e.length-1;t++)o=0==t?x:P,a.push(this.vadd(e[t],this.vchopped(this.vsub(e[t+1],e[t]),o)));var i=$(".square-a1").width();for(t=1;t<n.length;t++)n[t]=this.vadd(n[t],this.vmul(r[t-1],.18*i));for(t=0;t<a.length;t++)a[t]=this.vadd(a[t],this.vmul(r[t],.18*i));var s="";s="M"+this.round01pt(a[0]);var c=.72*i;for(t=1;t<e.length-1;t++){var d=this.round01pt(this.vadd(n[t],this.vchopped(this.vsub(n[t],a[t-1]),c))),u=this.round01pt(this.vadd(a[t],this.vchopped(this.vsub(a[t],n[t+1]),c)));s+=" L"+this.round01pt(n[t])+" C"+d+" "+u+" "+this.round01pt(a[t])}return s+=" L"+this.round01pt(n[t])}};function M(e,r){var o=[];return r.forEach(function(r){e!=r.from&&e!=r.to||o.push(r)}),o}function S(e){if(e.length<2)return!1;for(var r=1;r<e.length;r++)if(e[r].to!=e[0].to||e[r].from!=e[0].from)return!1;return j(e[0].to),!0}function j(e){if(!n.currTab.play_mode)return null;var r=$("#chessboard-cont .promotion-menu");n.currTab.play_mode.promoting=!0,r.removeClass("white black top bottom");var o=n.board.cboard.orientation(),t="8"==e[1]?"white":"black";r.addClass(t).addClass(o==t?"top":"bottom");var a=100*(e.charCodeAt(0)-"a".charCodeAt(0))/8;return"black"==o&&(a=100-a-12.5),r.css("left","calc("+a+"% * 0.86 + 20px)"),r.show(),null}n.board.deleteAllArrows=function(){$("#board1 .arrow").remove(),$("#board1 .square-55d63.lastmove").removeClass("lastmove"),$("#board1 .threatened").removeClass("threatened").removeAttr("data-c")},n.board.addArrowEvents=function(){var e=$("#board1 svg.arrow > *");"function"==typeof PointerEvent?e.on("pointerdown",function(e){e.stopPropagation()}).on("pointermove",function(e){e.stopPropagation()}).on("click pointerup",function(e){e.stopPropagation(),n.showArrowInfo(this)}):e.mousedown(function(e){e.stopPropagation()}).mousemove(function(e){e.stopPropagation()}).on("touchstart",function(e){e.stopPropagation()}).on("click touchend",function(e){e.stopPropagation(),n.showArrowInfo(this)})},n.enterSetUpMode=function(){n.setUp.show(),n.board.clearLight(),n.board.deleteAllArrows(),n.currTab.play_mode.switch_mode("free",null,"*")},n.exitSetUpMode=function(e){if(e||(e=n.currTab),n.setUp&&n.setUp.shown){var r=n.setUp.hide();if(C(!0),n.rebuildCapturedPieces(),r){if(e.is_pristine){e.is_pristine=!1;var o=new Game(n.curr_fen);e.set_game(o)}e.setjp("p",n.curr_fen,"",null,s.job_name_setup,"")}e.play_mode.switch_mode("assisted",n.curr_fen,"*")}},n.disambiguate_move=M,n.$on("Esc",function(e,r){var o=n.currTab.play_mode;o&&(o.promoting=!1,o.pending_moves=[])}),n.cond_pop_promotion_menu=function(e,r){return!!("wP"==r.piece&&r.to&&"8"==r.to[1]||"bP"==r.piece&&r.to&&"1"==r.to[1])&&(e.pending_moves=[],["q","r","n","b"].forEach(function(o){e.pending_moves.push({from:r.from,to:r.to,piece:r.piece,promotion:o})}),j(r.to),!0)};var R=null;function U(e,r){var o=e.currentUser&&e.currentUser.prefs&&void 0!==e.currentUser.prefs.sound?e.currentUser.prefs.sound:"click";if(o){var n=o+(r.user_color==r.turn?"_them.mp3":"_us.mp3"),t=new Audio("/static001767/assets/snd/"+n);try{t.play()}catch(e){console.error("cannot play sound: "+e)}}}n.play_move=function(e,r,o){var t=e.tab,a=e.game;if(a){if(0==a.moves.length){var i=n.curr_fen,s=t.jparam.name;a.initFromFen(i),a.origin!=Game.OR_NONE&&a.origin!=Game.OR_SETUP||a.set_origin("play"==e.mode?Game.OR_PLAY:Game.OR_REPLAY),t.setjp("p",i,"",-1,s,"")}t.add_move(r,o)&&(U(n,e),t.is_pristine=!1)}},d.$on("move-played",(e,r)=>{r.added_move?(r.skip_anim&&n.board.setFen(r.added_move.fen,"no-anim"),n.selectMove(n.currTab,r.added_move,!0,!0)):n.board.setFen(r.attempted_move.fen,r.skip_anim?"no-anim":null)}),d.$on("computer-move-played",(e,r)=>{n.play_move(r.pm,r.move),R&&(F(R.from,R.to,R.piece,R.new_pos),R=null)}),n.$on("Esc",function(){i.hide_options(n.currTab.play_mode)}),n.$on("dismiss-popups",function(e,r){if(n.currTab){var o=n.currTab.play_mode;o&&(o.end_popup_msg&&Date.now()>o.end_popup_msg_t0+700&&(o.end_popup_msg=""),n.moreBtnsMenuShown=!1,"hard"!=r.why&&"Esc"!=r.why||(i.hide_options(o),o.promoting||(o.pending_moves=[])))}}),n.onUserResign=function(){n.currTab.play_mode.endGame("user-resign"),n.ga("play-resign","","")},n.play_mode_on_click=function(e){var r=n.currTab,o=r.play_mode;if("free"==o.mode)return!1;if("play"!=o.mode||o.paused){var t=r.currJob;if(t&&"complete"==t.state&&"position"==t.jparam.type&&e.length>1)return!1}if(o.options_shown)return!1;var a=!0;i.sync_p_chess(o,n.curr_fen)||(a=o.p_chess.load(n.curr_fen));var s=a?function(e,r){if(e.promoting=!1,e.last_click_sq&&r==e.last_click_sq&&e.pending_moves.length)return e.last_click_sq=null,e.pending_moves=[],null;var o=e.last_click_sq;if(e.last_click_sq=r,"q"==r||"r"==r||"n"==r||"b"==r){if(e.pending_moves.length<1)return null;var t=e.pending_moves[0];return t.promotion=r,e.pending_moves=[],t}var a=!n.currentUser.prefs||"off"!=n.currentUser.prefs.automove;return e.pending_moves.length<=0?(e.pending_moves=e.p_chess.moves({verbose:!0}),e.pending_moves=M(r,e.pending_moves),1==e.pending_moves.length&&a?e.pending_moves.pop():(!e.pending_moves.length&&!R&&e.user_color!==e.turn&&o&&r&&(R={from:o,to:r,piece:e.p_chess.get(o)}),S(e.pending_moves),null)):(e.pending_moves=M(r,e.pending_moves),1==e.pending_moves.length?e.pending_moves.pop():S(e.pending_moves)?null:(e.pending_moves=e.p_chess.moves({verbose:!0}),e.pending_moves=M(r,e.pending_moves),1==e.pending_moves.length&&a?e.pending_moves.pop():(S(e.pending_moves),null)))}(o,e):null;return s?(Game.enrich_move(s,o.p_chess.fen()),n.play_move(o,s),o.last_click_sq=null):R&&(o.last_click_sq=null),!0},$(".promotion-menu IMG").on("click",function(e){var r=$(this);n.play_mode_on_click(r.attr("data-piece"))&&n.$apply()}),n.$watch("currentUser.prefs.automove",function(e){n.currTab&&n.currTab.play_mode&&(n.currTab.play_mode.single_click_moves="off"!=e)}),n.$watch("currTab.play_mode.single_click_moves",function(e){if(void 0!==e){var r=e?"on":"off";void 0===n.currentUser.prefs.automove&&"on"===r||r!=(n.currentUser.prefs.automove||"on")&&l.setUserPrefs({automove:r})}});$("#board1").on("click",".square-55d63.threatened[data-c]",function(e){var r=$(this);e.stopPropagation(),n.setUp.shown||(n.showArrowInfo(this),a.select_arrows_by_eids(r.attr("data-c").split(" ")))});var E=$("#board1").parent();function B(e,r){var n=e.split(" ");return n[0]=ChessBoard.objToFen(r),e=n.join(" "),o.fix_fen(e)}function F(e,r,o,t,a,i){var c=n.currTab,d=c.play_mode;if(d.pending_moves=[],(e="spare"===e?null:e)!=(r="offboard"===r?null:r)){if(b.manual_change=!0,n.setUp.shown||(c.is_pristine=!1),"free"==d.mode)return p=B(n.curr_fen,t),c.setjp("p",p,"",null,s.job_name_setup,""),n.board.setFen(p,"no-anim"),void n.rebuildCapturedPieces();b.source=e,b.target=r;var u=new Chess,l=null;if(s.job_name_setup,e&&r&&u.load(n.curr_fen)&&(l=u.move({from:e,to:r})))Game.enrich_move(l,n.curr_fen),"tutor"===d.mode?(U(n,d),c.tutor.on_user_guess(c.game,l)):n.play_move(d,l,"skip-anim");else{if(l={from:e,to:r,piece:o},n.cond_pop_promotion_menu(d,l))return d.pending_moves=[l],"snapback";if("play"===d.mode)return d.user_color!==d.turn&&((R=l).new_pos=t),"snapback";if("strict"===d.mode||"tutor"===d.mode)return"snapback";var p=B(n.curr_fen,t);c.setjp("p",p,"",null,s.job_name_setup,""),n.board.setFen(p,"no-anim")}n.rebuildCapturedPieces()}}function G(e){return function(){var r=this,o=arguments;return n.$apply(function(){return e.apply(r,o)})}}$(window).resize(function(){O(),n.$apply()}),n.$on("size-changed",function(){O()}),n.$watchGroup(["mobile","mobile_l"],function(){O()}),d.$watch("currentUser.prefs.pieces",function(e,r){e!==r&&n.board.cboard.redraw()}),n.$watch("currTab.play_mode.pending_moves",function(e){$(".pendmove").removeClass("pendmove is_from is_to"),e&&e.forEach(function(e){$("#board1 .square-"+e.from).addClass("pendmove is_from"),$("#board1 .square-"+e.to).addClass("pendmove is_to")})}),n.$watch("currTab.board_orientation",function(e){e&&n.board.rotate(e)}),n.$watch("key_focus",function(e){if(n.currTab){var r=n.currTab.play_mode;r&&"play"==r.mode&&"game"!=e&&!r.paused&&(r.paused=!0,r.paused_at_move=r.game.curr_move)}}),n.rebuildCapturedPieces=function(){n.mobile||e(function(){$("#board1 .spare-pieces-7492f",E).empty();var e=$(".spare-pieces-top-4028b",E),r=$(".spare-pieces-bottom-ae20f",E),o={wK:0,bK:0,wQ:9,bQ:-9,wR:5,bR:-5,wB:3,bB:-3,wN:3,bN:-3,wP:1,bP:-1},a={wK:1,bK:1,wQ:1,bQ:1,wR:2,bR:2,wB:2,bB:2,wN:2,bN:2,wP:8,bP:8},i=0,s=n.board.cboard.position();_.each(s,function(e){a[e]--,i+=o[e]}),n.balance=i?i>0?"+"+i:i:"";var c=function(o){for(var i={w:"b",b:"w"},s=["wK","wQ","wR","wB","wN","wP","bK","bQ","bR","bB","bN","bP"],c=0;c<s.length;c++){var d=s[c],u=a[d];if(u>0){d[0];for(var l="white"==(n.currTab?n.currTab.board_orientation:"white")?d.startsWith("b"):d.startsWith("w"),p=a[i[d.slice(0,1)]+d.slice(1)],f=0;f<u;f++)if(o&&f<p||!o&&f>=p){var _=f<p?"balanced":"unbalanced",m=t.url_of_piece(d),h=$('<img src="'+m+'" class="piece-417db temp '+_+'" data-piece="'+d+'" />');l?r.prepend(h):e.prepend(h)}}}};c(!0),c(!1)},10)};var N={pieceTheme:t.url_of_piece,position:"start",draggable:!0,dropOffBoard:"trash",sparePieces:!0,sparePiecesBuilder:function(){n.board_initialized&&(C(!0),n.rebuildCapturedPieces())},onClick:G(function(e,r,o,t){if(t&&t.stopPropagation(),"spare"!=r){if(n.setUp.shown)return function(e,r){var o=n.board.cboard,t=o.position();r?t[e]=r:t[e]&&delete t[e],o.position(t,!1)}(r,n.setUp.onBoardClick(r,o)),n.setUp.setFen(n.curr_fen),void n.rebuildCapturedPieces();var a=n.currTab,i=a.play_mode,s=a.currJob;"play"==i.mode&&!i.paused||!s||"position"!=s.jparam.type||"summary"!=s.topic&&"functionality"!=s.topic?n.play_mode_on_click(r):n.click_on_square&&n.click_on_square(e,r)}}),onDragStart:G(function(e,r,t,a){return function(e,r){if(e.pending_moves=[],"spare"==r)return!1;var t=new Chess;e.tab.fen=o.fix_fen(n.curr_fen),n.curr_fen=e.tab.fen,t.load(n.curr_fen)&&(e.pending_moves=n.disambiguate_move(r,t.moves({verbose:!0})))}(n.currTab.play_mode,e),!0}),onDrop:G(F),onChange:function(r,t){var a=n.curr_fen.split(" ");6!=a.length&&(a=["","w","-","-","0","1"]),a[0]=ChessBoard.objToFen(t),a[3]=o.fix_ep(a[3],t,a[1]),a[2]=o.fix_castling(t,a[2]),n.currTab.fen=a.join(" "),n.curr_fen=a.join(" "),n.force_arrows_change++,b.manual_change&&(b.manual_change=!1,e(function(){n.$apply()},5))}};n.board.cboard=ChessBoard("board1",N);var L=400;function O(){var e,r,o,t,a=$("#chessboard-cont");if(n.mobile)n.mobile_p?r=e=document.documentElement.clientWidth:(r=Math.min(document.documentElement.clientHeight-40,430),e=document.documentElement.clientHeight-40),t=(o=Math.max(Math.min(r,e),200))-4,$(".right-side,.left-side").css("width","");else{r=a.width(),e=a.height();$("#chessboard-cont .board-white-bg");var i=$("#chessboard-cont .below-board-controls").height(),s=r-$("#chessboard-cont .left-margin-btns").width()-($("#chessboard-cont .turn-indicator-cont").width()+$("#chessboard-cont .prisoner-camps-bg").width()),c=e-0-i;t=89.07*(o=Math.max(Math.min(s,c),200))/100}a[0].style.setProperty("--board-bg-dim",o+"px");var d=t/L;$(".board-white-bg > .scaler").css("transform","scale("+d+")"),$("BODY")[0].style.setProperty("--board-scale","scale("+d+")"),n.board.cboard.setScale(d),n.board_scale=d,n.mobile||n.resizeTabsCont()}n.onMoreBtn=function(e){var r=n.moreBtnsMenuShown;e&&e.stopPropagation(),r||n.dismiss_popups("soft"),n.moreBtnsMenuShown=!r},n.onCopyFEN=function(e){e&&e.stopPropagation();var r=()=>{n.popupMsg.showText(n.i18n.fen_copied,!1,10,$(e.target)),n.moreBtnsMenuShown=!1};if(navigator.clipboard)navigator.clipboard.writeText(n.curr_fen).then(r);else{var o=document.getElementsByClassName("fen")[0],t=document.createRange();t.selectNode(o),window.getSelection().removeAllRanges(),window.getSelection().addRange(t),document.execCommand("copy"),window.getSelection().removeAllRanges(),r()}n.ga("copy-fen","","")},n.onPMMessageClick=function(e){e&&e.stopPropagation(),n.mobile&&n.currTab&&n.currTab.play_mode&&n.currTab.play_mode.paused&&n.playOptions.onResumeGame(e)},n.$on("dismiss-popups",function(e,r){r&&"soft"!=r.why&&n.exitSetUpMode(),n.moreBtnsMenuShown=!1}),n.board_initialized=!0}]}}]);
