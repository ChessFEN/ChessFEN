"use strict";angular.module("chessStories").directive("appIntro",["$timeout","i18nService","jobService","arrowsService",function(e,t,r,n){var s=t.phrases;return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/intro/introView.html",controllerAs:"intro",link:function(t,r,s){e(function(){$(".intro-cont").addClass("fader")},10);var i=function(e,r){var n=$(e).first();if(n&&n.length){var s=t.topic_of(n);if(!s)return;t.currTab.currJob&&(t.currTab.currJob.topic=s),t.setActiveElement(n),n.hasClass(".is-hdr")&&(n=n.parent()),t.scrollIntoView(null,n,!1,function(){if(r){var e=$(r,n);e.length&&e.addClass("blinkshort")}})}};t.nav_to_selector=function(e,t){i(e,t)},t.add_intro_event_handlers=function(e){if(!e.hasClass("has_intro_evh")){e.addClass("has_intro_evh"),e.on("click","[data-ref]",function(e){e.ctrlKey||e.shiftKey||e.altKey||r(this)});var r=function(e){s();var t=$(e).attr("data-ref"),r=$(e).attr("data-blink");i(t,r)},s=function(){$(".blink").removeClass("blink"),$(".blinkshort").removeClass("blinkshort"),d3.selectAll(".blink").classed("blink",!1),d3.selectAll(".blinkshort").classed("blinkshort",!1)},o=null,l=function(){o&&(clearTimeout(o),o=null)};e.on("mouseleave","[data-blink]",function(e){l(),s()}),e.on("mouseenter","[data-blink]",function(e){l();var s=$(this);n.hide_all(!1);var i=s.attr("data-topic"),a=t.currTab.currJob.topic;i&&i!=a&&(t.currTab.currJob.topic=i,t.$apply());var c=s.attr("data-blink"),_=d3.selectAll(c);if(_&&_.length>0&&_[0].length>0){$(_[0]);s.attr("data-ref")?_.classed("blinkshort",!0):_.classed("blink",!0),t.scrollIntoView(null,_[0]),s.attr("data-ref")&&function(e){l(),o=setTimeout(function(){r(e)},1500)}(s)}})}}},controller:["$scope","$timeout",function(e,t){var i=this;i.KL_FEN="2rq1rk1/R2n1ppp/4p3/2pb4/5B2/6P1/1Q2PPBP/3R2K1 w - - 0 21",i.KL_MOVE_NAME="bxc5",i.GAME_NAME="Kramnik Leko 2001",i.KL_BEST_MOVE_NAME="Qa1",i.KL_UM_NAME="e4",i.KL_UM_UCI="e2e4",i.KL_loaded=!1,i.show_explanation=!1,i.show_explanation_demo=!1,i.curr_step=0,i.n_steps=6;var o=function(r){if("close"==r)i.curr_step&&(e.ga("welcome","close in bubble "+i.curr_step,""),i.step(0));else{var n,s="next"==r?i.curr_step+1:r;if("next"==r)n="next";else{var o=" dot "+i.curr_step+" to "+r;n=r==i.curr_step+1?"next"+o:r<i.curr_step+1?"back"+o:"skip"+o}e.ga("welcome","bubble-"+i.curr_step,n),t(function(){s>i.n_steps&&(s=0),(s||i.curr_step)&&i.step(s)},650)}};i.clickModalMask=function(e){e&&e.stopPropagation()},i.step=function(r,i){var l=this,a=e.mobile,c=e.mobile_l;l.n_steps=a?3:6,i&&i.stopPropagation(),-1==r&&(r=0,l.animate_fold_to_help_btn());var _=0==r&&l.curr_step;$(".results-cont").removeClass("scroll-disabled");var u=e.currTab;r&&(e.add_intro_event_handlers($(".guest-welcome")),0==l.curr_step&&(e.dismiss_popups("hard",null),e.bubble.hide("close"),e.mainMenu.mobile_shown=!1)),r>l.curr_step&&1==r&&l.load_KL(),l.curr_step=r,a||(e.force_arrows_change++,n.select_arrows_by_eids([])),l.show_explanation=r&&(r>2||a&&2===r),l.show_explanation_demo=r&&2===r&&a;var d={css_class:"intro"+(a?" guest-welcome":""),modal:a?1:2,lightbox:1,close_btn:2,next_btn:r==l.n_steps?s.Close:s.Next,steps:a?0:l.n_steps,step:l.curr_step,hide_cb:o,raised:"#XXX-menu-bar>.hdrlink,#user-menu-cont",absolute:a?1:0},p=window.innerHeight,f=window.innerWidth;if(0!=r&&(a||(u.currJob&&(u.currJob.topic="summary"),e.setFen(l.KL_FEN))),1==r){if(n.hide_all(!0),n.set_opac_override(.01),e.mobile){var h={w:c?f-(p/2+140+83):f,h:c?p-6:p-f-10,ref:"top-left",x:c?p/2+140+80:0,y:c?0:f-5,tip_ref:c?"right":"top",tip_dx:c?20:0,tip_dy:c?0:62};t(function(){if(l.curr_step&&$(".new-game-panel").width()<=0)return u.show_new_game_panel=!0,void l.step(l.curr_step);e.bubble.show($('<div class="ctitle">'+s.intro_1_1+"</div><div>"+s.intro_mob_1_1+"</div><div>"+s.intro_mob_1_2+"</div>"),h.w,h.h,h.ref,h.x,h.y,d,".new-game-panel",h.tip_ref,h.tip_dx,h.tip_dy)},50)}}else if(2==r)if(a){var b=$(".btns-row .decode-btn-cont").width();h={w:c?f-p-140:f-b-35,h:178,x:c?p+135:b+35,y:c?0:f+36+10,tip_ref:"right",tip_dx:0,tip_dy:c?5:-5};u.show_new_game_panel=!1,e.bubble.show($("<div>"+s.intro_mob_2_1+"</div>"),h.w,h.h,"top-left",h.x,h.y,d,".btns-row .decode-btn-cont",h.tip_ref,h.tip_dx,h.tip_dy)}else n.hide_all(!0),n.set_opac_override(.01);else if(3==r){a?n.hide_all(!1):n.hide_all(!0),n.set_opac_override(null);var g=".gist .dcpath";if(a)if(c)var m={width:f-p-9,height:230,ref:"top-left",refx:p+5,refy:30};else m={width:f,height:210,ref:"top-left",refx:0,refy:f+48};else if("spanish"==e.currentUser.lang)m={width:390,height:160,ref:"top-right",refx:-30,refy:-40};else if("portuguese"==e.currentUser.lang)m={width:390,height:156,ref:"top-right",refx:-30,refy:-40};else if("french"==e.currentUser.lang)m={width:416,height:168,ref:"top-right",refx:-30,refy:-40};else if("russian"==e.currentUser.lang)m={width:390,height:160,ref:"top-right",refx:-30,refy:-40};else if("dutch"==e.currentUser.lang)m={width:384,height:156,ref:"top-right",refx:-30,refy:-40};else if("italian"==e.currentUser.lang)m={width:360,height:164,ref:"top-right",refx:-30,refy:-40};else m={width:360,height:156,ref:"top-right",refx:-30,refy:-40};e.mobile?(e.set_arrows_opacity_now(),e.bubble.show($("<div>"+s.intro_mob_3_1+"</div><div>"+s.intro_mob_3_2+"</div>"),m.width,m.height,m.ref,m.refx,m.refy,d,".bubble-bubble","top")):e.scrollIntoView(null,".gist .bestcont",!1,function(){$(".results-cont").addClass("scroll-disabled"),e.bubble.show($("<div>"+s.intro_3_1+"<br>"+s.intro_3_2+"</div>"),m.width,m.height,m.ref,m.refx,m.refy,d,g,"left",-10,6,".gist .bpmf-cont","top-left",-24,40)})}else if(4==r){n.hide_all(!1),n.set_opac_override(.01);g=".summary-inner .good-because-plan";e.toggle_foldable("local_engine","closed"),e.toggle_foldable("game_info","closed"),e.setActiveElement($(".summary-inner .good-because-plan .four-title")),t(function(){e.scrollIntoView(null,g,!1,function(){$(".results-cont").addClass("scroll-disabled");var t=545,r=96,n=-130;"spanish"==e.currentUser.lang?t+=30:"french"==e.currentUser.lang?(t+=127,n-=40):"portuguese"==e.currentUser.lang?t+=24:"german"==e.currentUser.lang?t+=40:"russian"==e.currentUser.lang?r+=44:"norwegian"==e.currentUser.lang?t+=44:"dutch"==e.currentUser.lang?t+=55:"italian"==e.currentUser.lang&&(t+=67),e.bubble.show($("<div>"+s.intro_4_1+"<br>"+s.intro_4_2+' <span class="idea">'+s.Idea+'</span>, <span class="problem">'+s.Problem+"</span> "+s.or+' <span class="solution">'+s.Solution+"</span> "+s.to_see_on_board+"</div>"),t,r,"bottom",n,-20,d,g,"top-left",80,0)})},250)}else if(5==r)e.scrollIntoView(null,$(".summary-intro2 .adv2"),!1,function(){n.hide_all(!1),n.set_opac_override(.35);var t=85,r=360;"spanish"==e.currentUser.lang?t+=7:"portuguese"==e.currentUser.lang?r+=26:"french"==e.currentUser.lang?t+=20:"russian"==e.currentUser.lang?(t+=20,r-=40):"dutch"==e.currentUser.lang?t+=16:"italian"==e.currentUser.lang&&(r+=28),e.bubble.show($("<div>"+s.click_tabs_for_more+"</div>"),r,t,"right",-30,10,d,".topic-tabs","left",-14,0)});else if(6==r){g="#add-tab-btn";t(function(){n.hide_all(!1),n.set_opac_override(null),d.modal=1,d.raised+=",#add-tab-btn";var t=360;"french"==e.currentUser.lang?t+=37:"russian"==e.currentUser.lang&&(t+=62),e.bubble.show($("<div>"+s.try_decoding+"</div>"),t,100,"left",40,35,d,g,"right",12,4)},230)}_&&(n.hide_all(!1),n.set_opac_override(null),e.mobile&&l.KL_loaded&&e.getPristineTab(),e.bubble.hide("close"),e.force_arrows_change++,t(function(){l.curr_step||(e.auto_pop_signup&&e.currentUser&&"guest"==e.currentUser.level&&(e.show_website_frame=!0),e.auto_pop_signup=!1)},3e4))},i.load_KL=function(){var t=this;e.mainMenu.show_menu="";var n=!1;if(e.eachJob(function(r,s){if(r.fen==t.KL_FEN)return n=!0,e.setUp.hide(),e.selectTab(s),e.selectJob(s,r),!1}),!n){var s=new Game(t.KL_FEN);s.set_name(t.GAME_NAME),s.key="*intro*KL",s.set_origin(Game.OR_REPLAY);var i=e.getPristineTab();i.set_game(s),i.name=t.GAME_NAME;var o=new JobParams({type:"position",fen:t.KL_FEN,next_move_uci:t.KL_UM_UCI,idx:null,name:t.KL_BEST_MOVE_NAME,um_name:t.KL_UM_NAME,share_key:""}),l=new r.Job(s,o,null);i.jobs=[l],e.selectJob(i,l),i.hide_cards()}e.setFen(t.KL_FEN),e.currTab.is_pristine=!1,t.KL_loaded=!0},i.animate_fold_to_help_btn=function(){var e=$(".guest-welcome .popup").not(".ng-hide");if(0!=e.length){var r=e.offset().top,n=e.offset().left,s=$("#help-mode-btn"),i=s.offset().top,o=s.offset().left,l=".guest-welcome .popup.with-anim.ng-hide{transform:translate("+Math.floor(o-n)+"px,"+Math.floor(i-r)+"px) scale(0.06);}",a=$(".guest-welcome"),c=$(".fold-css",a);c.length?c.html(l):a.prepend($('<style class="fold-css">'+l+"</style>")),e.addClass("with-anim"),t(function(){$(".fold-css",a).remove(),e.removeClass("with-anim")},850)}},i.onDecodeOverlay=function(t){t&&t.stopPropagation(),Date.now()-e.bubble.shown_since>3e3&&e.bubble.hide("next")},e.$on("dismiss-popups",function(e,t){}),e.$watch("currentUser.lang",function(){if(i.curr_step&&!(i.curr_step<3)&&e.currentUser&&e.currentUser.lang){var r=i.curr_step;i.step(0),t(function(){i.step(r)},700)}}),$(window).on("resize",function(){e.mobile&&i.curr_step&&t(function(){i.step(i.curr_step)},50)})}]}}]);
