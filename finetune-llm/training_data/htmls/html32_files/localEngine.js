"use strict";const wasmSupported="object"==typeof WebAssembly&&WebAssembly.validate(Uint8Array.of(0,97,115,109,1,0,0,0)),wasmThreadsSupported=function(){const e=Uint8Array.of(0,97,115,109,1,0,0,0);if("object"!=typeof WebAssembly||"function"!=typeof WebAssembly.validate)return!1;if(!WebAssembly.validate(e))return!1;if("function"!=typeof SharedArrayBuffer)return!1;if("object"!=typeof Atomics)return!1;const n=new WebAssembly.Memory({shared:!0,initial:8,maximum:16});if(!(n.buffer instanceof SharedArrayBuffer))return!1;try{window.postMessage(n,"*")}catch(e){return!1}try{n.grow(8)}catch(e){return!1}return!0}();var SFMV=null,loading_SFMV=!1,queued_SFMV_starts=[],next_engine_id=1;function ChessEngine(){var e=this;e.engine_id=next_engine_id++,e.engine=null;var n=!1,t=null;e.analyze_cb=null,e.state_cb=null;var s=null,i=new Chess;function a(e,n){var t=[];i.load(e);for(var s=function(e){var n=2*(e.split(" ")[5]-1);o(e)<0&&n++;return n}(e),a=n.length,r=0;r<a&&"bmc"!=n[r];r++){var u={from:n[r].substr(0,2),to:n[r].substr(2,2)};if(5==n[r].length&&(u.promotion=n[r].substr(4,1)),!(u=i.move(u))||"k"==u.captured||"K"==u.captured){console.log("*** ucis_to_moves() illegal move",n[r],"in",i.fen());break}u.fen_after=i.fen(),u.ply=s,u.uci=n[r],t.push(u),s++}return t}function r(e){if(0==e.length)return'<span class="empty"></span>';var n=[];e[0].ply%2&&n.push(' <span class="movenum">'+(e[0].ply+1)/2+"...</span>");for(var t=0;t<e.length;t++){var s=e[t];s.ply%2==0&&n.push(' <span class="movenum">'+(s.ply/2+1)+".</span>");var i=t+1<e.length?Game.mv2uci(e[t+1]):"";n.push(' <span class="mov '+s.color+'" data-fena="'+s.fen_after+'" data-from="'+s.from+'" data-to="'+s.to+'" data-nmuci="'+i+'">'+s.san+"</span>")}return n.join("")}function o(e){return e?e.indexOf(" w ")>-1?1:-1:1}function u(n,s,a,r){if(!function(e,n,t){i.load(e);var s=i.in_draw()?0:i.in_checkmate()?"w"==i.turn()?-1e5:1e5:null;return null!==s&&(setTimeout(function(){t("result",{pvnum:1,score:s,score_cp:s,depth:n.depth||99,time:1,moves:[],html_path:""}),t("done",null)},1),!0)}(s,a,r)){t=s,e.analyze_cb=r,n.postMessage("setoption name MultiPV value "+(a.multipv?a.multipv:1)),n.postMessage("position fen "+s);var o="";_.isFinite(a.depth)&&(o+=" depth "+a.depth),_.isFinite(a.time)&&(o+=" movetime "+a.time),n.postMessage("go"+o)}}function l(e,n){var i=e.engine,l=function(e,n){var s=n.split(" ");if(s.length<2)return null;var i=s.shift();if("bestmove"==i)return{state:"done"};if("readyok"==i)return{state:"ready"};if("Stockfish"==i||"Stockfish.js"==i||"id"==i&&"name"==s[0])return{state:"ready"};if("info"==i){for(var u={state:"result",depth:null,score:null,score_cp:null,time:null,pvnum:null,moves:[],html_path:""};(i=s.shift())&&!(s.length<1);)if("depth"==i)u.depth=+s.shift();else if("score"==i){if(s.length<2)break;if("cp"==(i=s.shift())){var l=(p=(c=o(t))*s.shift())/100;u.score_cp=p,u.score=(l>0?"+":"")+l}else if("mate"==i){var c,f=(c=o(t))*(l=+s.shift())>0?"White":"Black",p=1e5-(l<0?2*-l:2*l-1);c*l<0&&(p=-p),u.score=f+" wins in "+Math.abs(l),u.score_cp=p,u.mate_in=c*l}}else if("time"==i)u.time=s.shift();else if("multipv"==i)u.pvnum=s.shift();else if("pv"==i){u.moves=a(t,s),u.html_path=r(u.moves);break}if(u.score&&u.depth&&u.pvnum)return u}return null}(0,n);l&&("result"==l.state?e.analyze_cb&&e.analyze_cb("result",l):"ready"==l.state?e.state_cb&&e.state_cb("ready",i):"done"==l.state&&(e.analyze_cb&&(e.analyze_cb("done",null),e.analyze_cb=null),t=null,s&&(u(i,s.fen,s.options,s.cb),s=null)))}function c(e,n){return new Promise(function(t,s){if(null!==document.querySelector('head > script[src="'+e+'"]'))return t();const i=document.createElement("script");n&&(i.type="module"),i.onload=t,i.onerror=s,i.async=!0,i.src=e,document.head.appendChild(i)})}function f(){return SFMV?new Promise(function(n,t){e.instantiate_sfmv(n,t)}):loading_SFMV?new Promise(function(n,t){queued_SFMV_starts.push({ctx:e,accept:n,reject:t})}):(loading_SFMV=!0,new Promise(function(n,t){new Promise(function(e,n){c("/sf13/stockfish-mv/stockfish.js").then(function(){return new Promise(function(e,n){const t=new XMLHttpRequest;t.open("GET","/sf13/stockfish-mv/stockfish.wasm",!0),t.responseType="arraybuffer",t.onerror=function(e){n(e)},t.onprogress=function(e){},t.onload=function(){e(t.response),SFMV=StockfishMv},t.send()})}).then(function(n){e()})}).then(function(){e.instantiate_sfmv(n,t);for(var s=0;s<queued_SFMV_starts.length;++s){var i=queued_SFMV_starts[s];i.ctx.instantiate_sfmv(i.accept,i.reject)}queued_SFMV_starts=[]})}))}function p(e){e.postMessage("uci"),function(){if(wasmThreadsSupported){var n=navigator.hardwareConcurrency,t=Math.min(4,Math.max(1,Math.floor(n/2)));t=Math.min(4,Math.max(1,Math.floor(n/2.1))),e.postMessage("setoption name threads value "+t)}e.postMessage("setoption name contempt value 0"),e.postMessage("setoption name Analysis Contempt value Off"),e.postMessage("setoption name UCI_AnalyseMode value true"),e.postMessage("setoption name UCI_Chess960 value false"),e.postMessage("setoption name UCI_Variant value chess")}()}function m(n){var t;e.engine||(e.state_cb=n,e.state_cb&&e.state_cb("loading",null),wasmThreadsSupported?f():wasmSupported?((t=new Worker("/sf13/stockfish-js/stockfish.wasm.js")).addEventListener("message",function(n){l(e,n.data)}),e.engine=t,p(e.engine)):function(){var n=new Worker("/sf13/stockfish-js/stockfish.js");n.addEventListener("message",function(e){l(n,e.data)}),e.engine=n,p(e.engine)}())}this.analyze=function(e,i,a){if(!function(e){var n=e.split(" ");if(6!=n.length)return!1;var t=new Chess;if(!t.validate_fen(e))return!1;n[1]="w"==n[1]?"b":"w",n[3]="-";var s=n.join(" ");return!!t.load(s)&&!t.in_check()}(e))return!1;if(t||!this.engine){var r={fen:e,options:i,cb:a};if(s){var o=s.cb;s=r,o("done")}else s=r;this.engine?this.engine.postMessage("stop"):n||(n=!0,m(function(e,n){var t=s;if("loading"===e)t.cb(e,n);else if("ready"===e){if(s=null,t)u(n,t.fen,t.options,t.cb)}}))}else u(this.engine,e,i,a);return!0},e.instantiate_sfmv=function(e,n){var t=this,s=null;SFMV().then(function(e){return s=e,e.ready}).then(function(){var n=s;n.addMessageListener(function(e){l(t,e)}),t.engine=n,p(t.engine),e()}).catch(function(e){console.log("*** start_sfmv.Stockfish returned error",e," engine-"+t.engine_id),n()})},this.stop=function(e){this.engine&&this.engine.postMessage("stop"),s=null},this.terminate=function(){e.engine&&(this.stop(),"function"==typeof e.engine.terminate&&e.engine.terminate(),e.engine=null,n=!1,t=null,this.analyze_cb=null,s=null)}}
