"use strict";chessStories.directive("appHistSearchDlg",[function(){return{restrict:"A",scope:{visible:"=dlgVisible",hideDropdowns:"=",tags:"=",players:"=",openings:"=",predicate:"=",updateSearchedList:"="},templateUrl:"/static001767/app/shared/historySearch/historySearchView.html",controllerAs:"histSearch",controller:["$scope","$timeout","$rootScope","i18nService","Kbd","themeService",function(e,t,n,r,i,a){var s=this,o=r.phrases;e.i18n=o,s.search_tags=[],s.fromDate=null,s.toDate=null,s.search_game_results=[],s.search_players=[],s.search_openings=[],s.field_text_tags="",s.field_text_game_results="",s.field_text_players="",s.field_text_openings="",s.predicate=function(e){return function(e){if(0==s.search_tags.length)return!0;if(!e.tags)return!1;var t=e.tags.split(",");return _.some(s.search_tags,function(e){return _.contains(t,e)})}(e)&&function(e){var t,n=!0;return e.headers.Date&&(t=new Date(e.headers.Date)),s.fromDate&&(n=n&&t>=s.fromDate),s.toDate&&(n=n&&t<=s.toDate),n}(e)&&function(e){return 0==s.search_game_results.length||_.contains(s.search_game_results,e.headers.Result)}(e)&&function(e){return 0==s.search_players.length||_.some(s.search_players,function(t){return e.headers.White==t||e.headers.Black==t})}(e)&&function(e){return 0==s.search_openings.length||void 0!==e.openings&&_.some(s.search_openings,function(t){return _.some(e.openings,function(e){return e[1]===t})})}(e)},s.search_active=function(){return!(0==s.search_tags.length&&0==s.search_game_results.length&&null==s.fromDate&&null==s.toDate&&0==s.search_players.length&&0==s.search_openings.length)},e.game_results=["1-0","0-1","1/2-1/2","*"],s.dropdownContent=[],s.dropdownOffset=[0,0],s.editedField=null,s.dropdownVisible=!1,s.datepickersVisible=!1,s.closeDlg=function(){e.visible=!1},e.hideDropdowns=function(){s.dropdownVisible=!1,s.datepickersVisible=!1},s.closeOnePopupLevel=function(){e.visible&&(s.dropdownVisible||s.datepickersVisible?e.hideDropdowns():s.closeDlg())},s.onBGClick=function(t){t&&t.stopPropagation(),e.hideDropdowns()},s.onInputField=function(t){var n,r,i=null;if(t&&(t.stopPropagation(),i=$(t.target),n=i.attr("data-id"),r=[i.position().left,i.position().top]),"date"===n)e.hideDropdowns(),s.datepickersVisible=!0;else{if(!["tags","players","openings","game_results"].includes(n))return;s.dropdownContent=_.map(e[n],function(e){return{name:e,selected:_.contains(s["search_"+n],e)}})}s.editedField=n,"date"!==n&&(s.datepickersVisible=!1,s.dropdownOffset=r,s.dropdownVisible=!0)},s.onInputKeydown=function(e){e.keyCode===i.ESC&&s.closeOnePopupLevel()},s.clearField=function(e,t){e&&e.stopPropagation();var n=s.editedField;s.editedField=t,s.updateSearch("clear"),s.editedField=n},s.updateSearch=function(n,r){var i=-1,a=null;"date"!=s.editedField&&(a=s["search_"+s.editedField]),r&&a&&(i=a.indexOf(r)),"add"===n?i<0&&a.push(r):"delete"===n?a.indexOf(r)>=0&&a.splice(a.indexOf(r),1):"date"===n?"from"===r?s.fromDate=new Date(e.histSearchFromDate):"to"===r&&(s.toDate=new Date(e.histSearchToDate)):"clear"===n&&(a?a.splice(0,a.length):(s.fromDate=null,s.toDate=null,e.histSearchFromDate=null,e.histSearchToDate=null)),a&&(s["field_text_"+s.editedField]=a.toString()),s.search_active()?e.predicate=s.predicate:e.predicate=null,t(e.updateSearchedList)},e.$watch("histSearchFromDate",function(e){e&&s.updateSearch("date","from")}),e.$watch("histSearchToDate",function(e){e&&s.updateSearch("date","to")}),e.$on("Esc",function(){s.closeOnePopupLevel()})}]}}]);
