chessStories.service("nudgeService",[function(){var t=function(t){return{x:t.charCodeAt(0)-"a".charCodeAt(0),y:t.charCodeAt(1)-"1".charCodeAt(0)}},n=function(n,i){var h=t(n);this.x1=h.x,this.y1=h.y,h=t(i),this.x2=h.x,this.y2=h.y,this.nudge=null,this.line=function(t,n,i,h){if(i<t||t==i&&h<n){var e=i;i=t,t=e,e=h,h=n,n=e}var a=i-t,r=h-n,s=Math.atan2(r,a),u=(t*r-n*a)/Math.sqrt(a*a+r*r),o=function(t){return Math.round(100*t)};return[o(s),o(u)]}(this.x1,this.y1,this.x2,this.y2),this.seg_len=Math.hypot(this.x2-this.x1,this.y2-this.y1),this.sq1=n,this.sq2=i};n.prototype.s=function(){return this.sq1+this.sq2};var i=function(t,n,i){var h=[Math.round(n[0]*t*100)/100,Math.round(n[1]*t*100)/100];_.each(i,function(t){t.nudge=h})},h=function(){this.lines={}};return h.prototype.add=function(t){var n=t.line;this.lines[n]?this.lines[n].push(t):this.lines[n]=[t]},h.prototype.assign_nudges=function(){_.each(this.lines,function(t,n){var h=[];if(_.each(t,function(t){t.nudge=null}),t=_.sortBy(t,function(t){return-t.seg_len}),_.each(t,function(n){var i=function(t,n){for(var i,h,e,a,r,s,u={},o=0,c=0;c<n.length;c++){var l=n[c];null!==l.nudge&&(i=t,h=l,e=void 0,a=void 0,r=void 0,s=void 0,r=Math.min(i.x1,i.x2),s=Math.max(i.x1,i.x2),r==s?(r=Math.min(i.y1,i.y2),s=Math.max(i.y1,i.y2),e=Math.min(h.y1,h.y2),a=Math.max(h.y1,h.y2)):(e=Math.min(h.x1,h.x2),a=Math.max(h.x1,h.x2)),Math.max(r,e)<Math.min(s,a))&&(u[l.nudge]||(u[l.nudge]=!0,o++))}for(c=0;c<o+2;c++)if(!u[c])return c;return console.log("*** ERROR: NO NON-OVLP GRPID FOUND!"),0}(n,t);n.nudge=i,i<h.length?h[i].push(n):h.push([n])}),h.length<2){for(var e=0;e<h.length;e++){var a=h[e];i(0,[0,0],a)}return}var r=function(t){var n=-t[0]/100+Math.PI/2;return[Math.cos(n),Math.sin(n)]}(n.split(",")),s=0;h.length%2==0&&(s=-.5);var u=h.length;var o=2-.25*(Math.min(6,Math.max(2,u))-2);for(e=0;e<h.length;e++){a=h[e];i(o*(s+=e*(e%2==0?-1:1)),r,a)}})},{Nudger:h,Segment:n}}]);
