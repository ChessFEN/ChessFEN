chessStories.service("tutorService",["$rootScope","apiService","i18nService","jobService",function(e,t,s,o){var n=s.phrases,r=function(){this.enabled=!1,this.standby-=!1,this.phrase=null,this.reveal=!1,this.best_mv=null,this.move_is_best=!1,this.user_tried=!1,this.jobSent=null,this.jobPct=0,this.all_moments_seen=!1};return r.prototype.toggle=function(e){_.isUndefined(e)?this.enabled=!this.enabled:this.enabled=e,this.enabled&&(this.standby=!1)},r.prototype.stand_by=function(){this.standby=!0},r.prototype.cond_enable=function(){this.standby&&this.toggle(!0)},r.prototype.decode_user_guess=function(t,s,n){var r=this,i=new JobParams({type:"tutor",game_key:t.key,share_key:s,game_name:t.name,fen:t.curr_move.fen,next_move_uci:Game.mv2uci(n),name:"Learn"}),a=new o.Job(t,i,null);r.jobSent=a,a.start({r:!1,d:!1},function(t){a===r.jobSent&&("failed"===t?e.$broadcast("tutor-decode-failed"):"changed"===t?r.jobPct+=15:"complete"===t&&(r.jobSent=!1,e.$broadcast("tutor-decode-complete",{job:a})))})},r.prototype.explain=function(e,t){e.tutor_reveal?this.reveal=!0:(this.reveal=!1,this.clone_dgame_into_tutor(t),this.set_best_from_dgame(e,t))},r.prototype.set_best_from_dgame=function(e,t){if(e&&t&&t.length){var s=$(".explained_mv",t).attr("data-em"),o=$(".explained_mv",t).attr("data-cp"),n=Game.ucis2moves(e.fen,[s])[0];n.score=o,Game.enrich_move(n,e.fen,n.fen),this.set_best_mv(n)}},r.prototype.set_best_mv=function(e){e.show_mv_num=!0,this.best_mv=e},r.prototype.show_why=function(){$(".tutor-cont .show-why").show(201)},r.prototype.hide_why=function(){$(".tutor-cont .show-why").hide(201)},r.prototype.reveal_move=function(e){e.tutor_reveal=!0},r.prototype.clone_dgame_into_tutor=function(e,t){var s=$(".user-move-cont",e).clone().addClass("framed").show();if(s.length)this.move_is_best=!1,this.phrase=null,$("#results .tutor-cont .dgmf-cont").empty().append(s),!1!==t&&$("#results .tutor-cont .essence-cont").empty().append($(".essence",s));else{this.move_is_best=!0,this.phrase=n.Thats_best_move;var o=$(".dgame-best-cont",e).clone().toggleClass("dgame-best-cont user-move-cont").addClass("framed").show();$("#results .tutor-cont .dgmf-cont").empty().append(o)}},r.prototype.mark_moment_seen=function(e){this.enabled&&e&&e.interesting&&(e.tutor_seen=!0)},r.prototype.check_all_moments_seen=function(e,t){var s=_.filter(e.moves,e=>e.interesting&&o(e)),o="a"===t?()=>!0:e=>e.color===t;_.every(s,e=>e.tutor.seen)&&(this.all_moments_seen=!0)},r.prototype.reset=function(){this.phrase=this.move_is_best?n.Thats_best_move:null,this.jobSent=null,this.jobPct=0,this.user_tried=!1},r.prototype.give_user_feedback=function(e,s,o){t.call("get_score_qual",{s:o.score,b:self.best_mv.score})},r.prototype.on_user_guess=function(e,t){this.user_tried=!0,Game.mv2uci(t)===$(".dgame-cont .pgn-selected .dgame-best-cont .explained_mv").attr("data-em")?(this.phrase=n.Thats_best_move,this.set_best_mv(t),this.move_is_best=!0):(this.phrase=n.Theres_better_move,this.move_is_best=!1),this.decode_user_guess(e,e.share_key,t)},{Tutor:r}}]);
