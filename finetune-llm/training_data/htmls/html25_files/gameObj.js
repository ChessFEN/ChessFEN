"use strict";var JobParams=function(e){e?this.set(e.type,e.fen,e.next_move_uci,e.idx,e.name,e.um_name||"",e.game_key,e.game_name,e.share_key,e.exp_color||"a"):this.set("p","","",null,null,"SetUp","")};JobParams.prototype.set=function(e,t,n,i,r,s,o,a,m,u){if("p"==e?e="position":"g"==e?e="game":"t"===e&&(e="tutor"),this.type=e,this.fen=t,this.next_move_uci=n,this.idx=i,this.name=r,this.um_name=s||"",this.game_key=o,this.game_name=a,this.share_key=m,this.exp_color=u,t){var _=t.split(" ");this.color="b"==_[1]?"w":"b",this.move_num=parseInt(_[5])-("b"==this.color?1:0)}else this.color=null,this.move_num=null};var guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+"-"+e()+"-"+e()+e()+e()},Pos=function(e){this.from_simple_obj(e)};Pos.prototype.to_simple_obj=function(){return{t:this.type,n:this.name,u:this.um_name,f:this.fen,m:this.next_move_uci,x:this.exp_color}},Pos.prototype.from_simple_obj=function(e){this.type=e.t||("position"==e.type?"a":"game"==e.type?"g":""),this.name=e.n||e.name,this.um_name=e.u||e.um_name||"",this.fen=e.f||e.fen||"",this.next_move_uci=e.m||e.next_move_uci||"",this.exp_color=e.x||("game"===e.type?e.exp_color:"")},Pos.prototype.same_as=function(e){return"g"==this.type&&"g"==e.type||this.name==e.name&&this.type==e.type&&this.fen==e.fen&&this.next_move_uci==e.next_move_uci},Pos.prototype.almost_same_as=function(e){return"g"!=this.type&&"g"!=e.type&&this.name==e.name&&this.fen==e.fen&&this.next_move_uci==e.next_move_uci},Pos.prototype.as_str=function(){return"Pos("+this.name+","+this.type+","+this.fen+","+this.next_move_uci+")"};var n_games=0,reset_games_count=function(){n_games=0};function Game(e){if(this.positions=[],this.dirty=!1,this.saving=!1,this.save_time=0,this.resave_params_q=[],void 0!==e)return"string"==typeof e?looks_like_fen(e)?this.from_fen(e,"SetUp"):this.parse(e):"object"==typeof e&&this.from_simple_obj(e),this.name=Game.make_game_name(this.headers),this.headers.CSGameName=this.name,this.key||(this.key=""),this.mark_decoded_moves(),this.init_selected_move(),void this.clear_answers();this.body=[Game.make_sentinel("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")],this.moves=[],this.curr_move=this.body[0],this.curr_move.active=!0,this.origin="",n_games++,this.name="Game "+n_games,this.key="",this.headers={Result:"*",CSGameName:this.name}}function looks_like_fen(e){return!(e.length>150)&&null!==(e=e.trim()).match(/^[1-8prnbqkPRNBQK/]+ +[wb] +[-KQkq]+ +(-|[a-h][36]) +[0-9]{1,4} +[0-9]{1,4}$/)}function ply_from_fen(e){var t=e.split(" ");return 2*(t[5]-1)+("b"==t[1]?1:0)}function fen_essence(e){var t=e.split(" ");return t[0]+" "+t[1]}function update_pre_variants(e,t,n){n>0&&(t[n-1].pre_variant=Game.is_variant(e)),e&&n<t.length&&(e.pre_variant=Game.is_variant(t[n+1]))}function splitPgn(e){for(var t=e.replace(/[ \t]*\r\n?[ \t]*/g,"\n").split("\n\n"),n=0;n<t.length;n++)if(n%2==0)for(;n<t.length-1&&looksLikeHeader(t[n+1]);)t[n]=(t[n]+"\n"+t[n+1]).replace(/\n\s*\n/g,"\n"),t.splice(n+1,1);else for(;n<t.length-1&&!looksLikeHeader(t[n+1]);)t[n]=(t[n]+"\n"+t[n+1]).replace(/\n\s*\n/g,"\n"),t.splice(n+1,1);if(1==t.length&&!looksLikeHeader(t[0])){var i=t[0];i.endsWith("*")||i.endsWith("1/2-1/2")||i.endsWith("1-0")||i.endsWith("0-1")||(i+=" *"),t=['[X ""]',i]}return t}function reposition_move_nums(e){var t=function(e){var n=!0;e.forEach(function(e){Game.is_move(e)?(e.show_mv_num=n||e.ply%2==0,n=!1):Game.is_sentinel(e)?n=!0:Game.is_comment(e)?e.text.length>10&&!e.hide&&(n=!0):Game.is_variant(e)&&(t(e),n=!0)})};t(e.body)}function hide_internal_comments(e){var t=function(e){if(e){e.forEach(function(e){e&&"{"==e.kind&&e.text.match(/\[%/)?e.hide=!0:Game.is_variant(e)&&t(e)})}};e&&t(e.body)}Game.prototype.set_dirty=function(){this.dirty=!0},Game.prototype.reset_dirty=function(){this.dirty=!1},Game.prototype.time_since_last_save=function(){return Date.now()-this.save_time},Game.OR_NONE="?",Game.OR_PLAY="play",Game.OR_REPLAY="replay",Game.OR_SETUP="setup",Game.OR_FEN="pasted_fen",Game.OR_PGN="pgn",Game.OR_FILE="user_file",Game.OR_EXAMPLE="example",Game.OR_IMPORT="import",Game.OR_LICHESS="Lichess",Game.OR_CHESSCOM="Chess.com",Game.prototype.ply_to_move_num=function(e){return Math.floor(e/2)+1+(e%2?"...":".")},Game.prototype.choose_rep_move=function(e){var t=this,n=null;if(t.moves.length){e&&(n=_.find(t.moves,function(t){return t.fen==e})),n||(n=_.find(t.moves,function(e){return"complete"==e.state})),n||(n=_.find(t.moves,function(e){return"sent"==e.state||"working"==e.state}));var i=t.headers.FEN;!n&&i&&(n=_.find(t.moves,function(e){return e.fen==i})),!n&&t.positions&&t.positions.length&&(n=_.find(t.moves,function(e){return _.find(t.positions,function(t){return e.fen==t.fen})})),n||(n=t.moves[t.moves.length-1])}return n||(n=t.body[0]),n},Game.prototype.set_origin=function(e){e!=this.origin&&(this.dirty=!0,this.origin=e)},Game.prototype.set_positions=function(e){this.positions=_.map(e,function(e){return new Pos(e)}),self.dirty=!0},Game.prototype.set_name=function(e){e!=this.name&&(this.dirty=!0,this.name=e)},Game.prototype.from_fen=function(e,t){return t=t||"Game "+ ++n_games,this.key="",this.id=guid(),this.name=t,this.fen=e,this.origin=Game.OR_FEN,this.headers={Event:"?",Site:"?",Date:"?",Round:"?",White:"?",Black:"?",Result:"*",SetUp:"1",FEN:e,CSGameName:t||""},this.body=[Game.make_sentinel(e)],this.moves=[],this.curr_move=this.body[0],this.curr_move.active=!0,this.positions=[],this.dirty=!1,this},Game.prototype.from_simple_obj=function(e){var t=this;if(t.headers={},e.pgn)t.parse(e.pgn);else if(e.fen)t.from_fen(e.fen,"");else{var n="4k3/8/8/8/8/8/8/4K3 w - - 0 1";t.headers={SetUp:"1",FEN:n},t.body=[Game.make_sentinel(n)]}var i=function(n,i){t[n]=e.hasOwnProperty(n)?e[n]:i};i("key",""),i("share_key",""),i("name",""),i("fen",""),i("origin","?"),i("headers",t.headers),i("body",t.body),hide_internal_comments(t),reposition_move_nums(t),t.rebuild_moves(),t.curr_move=null,i("scores",[]);for(var r=0;r<t.scores.length;r++)r<t.moves.length&&(t.moves[r].score=t.scores[r]);i("depths",[]);for(r=0;r<t.depths.length;r++)r<t.moves.length&&(t.moves[r].depth=t.depths[r]);i("losses",[]);for(r=0;r<t.losses.length;r++)r<t.moves.length&&(t.moves[r].loss=t.losses[r]);i("levels",[]);for(r=0;r<t.levels.length;r++)r<t.moves.length&&(t.moves[r].interest_r=t.levels[r]);i("aces",[]);for(r=0;r<t.aces.length;r++)r<t.moves.length&&(t.moves[r].ace=t.aces[r]);i("bests",[]);for(r=0;r<t.bests.length;r++)r<t.moves.length&&(t.moves[r].bestplay=t.bests[r]);var s=_.map(e.positions||[],function(e){return new Pos(e)});return t.positions=t.positions?t.positions.concat(s):s,t.iter_items(function(e,n,i){e||(console.log("game: from_simple_obj: dropping null in "+(n===t.body?"mainline":"a variant")+", idx:"+i),n.splice(i,1))}),e.pgn||t.iter_items(update_pre_variants),t.dirty=!1,t},Game.prototype.mark_decoded_moves=function(){var e=this;e.iter_items(function(t){if(Game.is_move(t)){var n=t.fen;_.each(e.positions,function(e){"a"!==e.type&&"d"!==e.type||e.fen!==n||(t.state="complete")})}})},Game.prototype.init_selected_move=function(){var e=this.iter_items(function(e){return e&&!!e.active});if(e)var t=e.item;else t=this.choose_rep_move();this.select_move(t)},Game.prototype.select_move=function(e){this.iter_items(function(e){(Game.is_move(e)||Game.is_sentinel(e))&&(e.active=!1)}),this.curr_move=e,e&&(e.active=!0)},Game.prototype.deselect_move=function(){this.select_move(null)},Game.prototype.clear_answers=function(){this.body[0].ex_id=null,this.body[0].err=!1,_.each(this.moves,function(e){e.ex_id=null,e.err=!1})},Game.prototype.clear_errors=function(){this.body[0].err=!1,_.each(this.moves,function(e){e.err=!1})},Game.prototype.set_errors=function(){this.body[0].err=!this.body[0].ex_id,_.each(this.moves,function(e){e.err=!e.ex_id})},Game.prototype.has_all_answers=function(){return!(!this.body[0].ex_id&&!this.body[0].job)&&!_.find(this.moves,function(e){return!e.ex_id&&!e.job})},Game.prototype.to_simple_obj=function(){var e=function(e,t){var n={};return _.map(t,function(t){e.hasOwnProperty(t)&&(n[t]=e[t])}),n};return{headers:this.headers,origin:this.origin,key:this.key,name:this.name,share_key:this.share_key||"",fen:this.fen,body:function t(n){return _.map(n,function(n){return Game.is_move(n)?e(n,["kind","state","accurate","active","color","fen","flags","from","index_number","interest_r","interesting","loss","move_number","name","next_san","piece","ply","promotion","san","score","to","y","is_first"]):Game.is_comment(n)?e(n,["kind","text"]):Game.is_variant(n)?t(n):Game.is_sentinel(n)||Game.is_nullmove(n)?e(n,["kind","active","fen","ply","score"]):void 0})}(this.body),scores:this.scores,levels:this.levels,positions:_.map(this.positions,function(e){return e&&e.to_simple_obj?e.to_simple_obj():null})}},Game.is_promotion=function(e){return e.flags.includes("p")},Game.is_capture=function(e){return e.flags.includes("c")},Game.is_castling=function(e){return e.flags.includes("k")},Game.mv2uci=function(e){return e?e.from+e.to+(e.promotion||""):""},Game.prototype.mv2uci=Game.mv2uci,Game.ucis2moves=function(e,t){if(!t||!t.length)return[];var n=new Chess(e),i=!0,r=_.map(t,function(r,s){if(!i)return null;var o={from:r.slice(0,2),to:r.slice(2,4)};5==r.length&&(o.promotion=r.slice(4,5));var a=n.fen();return(o=n.move(o))?(Game.enrich_move(o,a,n.fen()),o):(console.log("*** null move before enrich_move. fen:",e,"ucis:",t,"idx:",s),i=!1,null)});return i?r:[]},Game.prototype.ucis2moves=Game.ucis2moves,Game.is_move=function(e){return e&&(void 0===e.kind||"move"==e.kind||Game.is_nullmove(e))&&void 0===e.length},Game.is_variant=function(e){return!!e&&void 0!==e.length},Game.is_comment=function(e){return!!e&&(";"==e.kind||"{"==e.kind||"$"==e.kind)},Game.is_sentinel=function(e){return!!e&&"start"==e.kind},Game.is_nullmove=function(e){return!!e&&"nullmv"===e.kind},Game.prototype.ply_from_fen=ply_from_fen,Game.make_sentinel=function(e){return{kind:"start",fen:e,ply:ply_from_fen(e),index_number:-1}},Game.prototype.idx_from_fen=function(e){if(e==this.get_start_fen())return-1;var t=ply_from_fen(e)-this.get_start_ply()-1;return(t<0||t>=this.moves.length||e!=this.moves[t].fen)&&(t=null),t},Game.prototype.mv_from_fen=function(e,t){var n=null;return this.iter_items(function(i){if((Game.is_move(i)||Game.is_sentinel(i))&&i.fen==e&&(!t||t==i.jparam.next_move_uci))return n=i,!0}),n},Game.prototype.path_until_fen=function(e){var t=this,n=function(e,n,i){if(e===t.curr_move);},i=function(e){var t=[];e.parent&&(t=i(e.parent)).pop();for(var n=0;n<=e.idx;n++){var r=e.variant[n];Game.is_move(r)&&t.push(r)}return t},r=null,s=(n=0,fen_essence(e));return t.iter_items(function(o,a,m,u){var _=0;return(Game.is_move(o)||Game.is_sentinel(o))&&(o.fen==e?_=o===t.curr_move?3:2:fen_essence(o.fen)==s&&(_=1)),_>n&&(r=i({item:o,variant:a,idx:m,parent:u}),n=_,!0)}),r},Game.prototype.initFromFen=function(e){if(!e||e!=this.get_start_fen()){var t="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";e||(e=t),this.body=[Game.make_sentinel(e)],this.moves=[],this.curr_move&&(this.curr_move=this.body[0]),this.positions||(this.positions=[]),e==t?(delete this.headers.SetUp,delete this.headers.FEN):(this.headers.SetUp="1",this.headers.FEN=e)}},Game.prototype.parse_headers=function(e){if(!e)return{};var t=(e=e.trim()).indexOf("\n\n");return t>0&&(e=e.substring(0,t+1)),this.parse(e,null).headers},Game.E_INVALID_HDR=1,Game.E_HDR_HAS_TAIL=2,Game.E_PGN_HAS_TAIL=3,Game.E_INVALID_MOVE=4,Game.E_UNEXPECTED_CLOSE=5,Game.E_CLOSE_MISSING=6,Game.E_RESULT_MISMATCH=7,Game.E_INVALID_TEXT=8,Game.prototype.parse=function(e,t){var n=/^\s*\[\s*(\S+)\s+([^\]]*)\](.*)$/,i=/\s*(([0-9]+\.{1,3})|((O-O-O|O-O|0-0-0|0-0|[RNBQKa-h1-8x=]{2,6})[+#]?)|(;.*\n|{[^}]*}?|\$[0-9]+)|\(|\)|\S*)/g;e&&(e.length>=3&&239==e.charCodeAt(0)&&187==e.charCodeAt(1)&&191==e.charCodeAt(2)&&(e=e.slice(3)),'"'==e[0]&&(e=JSON.parse(e)),e=e.replace(/\u2026/g,"...").replace(/\u00bd/g,"1/2").replace(/\u2013/g,"-"));var r,s,o=e.split("\n"),a=0,m="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";return null===(s=function(e,n){var s=ply_from_fen(e),o=[Game.make_sentinel(e)],a=[{body:o,chess:new Chess(e),ply:s,prev_fen:e,is_empty:!0}];if(""==n)return[];var m=!1;try{n.replace(i,function(e,n,i,s,o,u){var _=e.trim();if(0==_.length)return"";if(m){if(t&&t(Game.E_PGN_HAS_TAIL,"Text after PGN end ignored",_))throw 1;return console.log("*** Text after PGN end ignored - "+_),""}var p=a[a.length-1];if(i)p.ply=function(e){var t=e.split("."),n=2*(t[0]-1);return t.length>2&&n++,n}(i);else if(s){p.prev_fen=p.chess.fen(),"0-0"==s&&(s="O-O"),"0-0-0"==s&&(s="O-O-O");var h=p.chess.move(s,{sloppy:!0});if(!h){if(t&&t(Game.E_INVALID_MOVE,"Invalid move converted to comment",_))throw 1;console.log("*** Invalid move converted to comment: "+_);var f={kind:"{",text:"{"+s+"}"};return p.body.push(f),""}h.name=_,h.ply=p.ply,h.move_number=Math.floor(h.ply/2)+1,h.fen=p.chess.fen(),p.is_empty&&(h.is_first=!0),p.body.push(h),p.is_empty=!1,p.ply++}else if(u){var l=u[0];"{"!=l&&";"!=l&&"$"!=l&&(l="!"),f={kind:l,text:_,hide:!1},"{"==l&&_.match(/\[%/)&&(f.hide=!0),p.body.push(f)}else if("("==_){var v=[Game.make_sentinel(p.prev_fen)];p.body[p.body.length-1].pre_variant=!0,p.body.push(v),a.push({body:v,chess:new Chess(p.prev_fen),ply:p.ply-1,prev_fen:p.prev_fen,is_empty:!0})}else if(")"==_)if(a.length>1)a.pop();else{if(t&&t(Game.E_UNEXPECTED_CLOSE,'Unexpected ")" ignored',_))throw 1;console.log('*** Unexpected ")" ignored.')}else if("*"==_||"1-0"==_||"0-1"==_||"1/2-1/2"==_){if(1!=a.length){if(t&&t(Game.E_CLOSE_MISSING,'Closing ")" missing in PGN',_))throw 1;console.log('*** Closing ")" missing in PGN')}for(;a.length>1;)a.pop();if(r.Result&&r.Result!=_){if(t&&t(Game.E_RESULT_MISMATCH,"Result at end does not match Result header",_))throw 1;console.log("*** Result at end does not match Result header in PGN")}r.Result=_,m=!0}else if(_.length<=2)f={kind:"!",text:_},p.body.push(f);else{if(t&&t(Game.E_INVALID_TEXT,"Invalid text",_))throw 1;console.log("*** Invalid text ignored:",_)}return""})}catch(e){return null}return o}(m=(r=function(){for(var e={};a<o.length;a++){var i=o[a].trim();if(""!=i){var r=i.match(n);if(r){var s=r[1],m=r[2].trim();if('"'==m[0]&&(m=m.slice(1)),m.length>0&&'"'==m[m.length-1]&&(m=m.slice(0,m.length-1)),e[s]=m,""!=r[3]){if(t&&t(Game.E_HDR_HAS_TAIL,"Extra text at end of header line "+a+" ignored",i))return null;console.log("*** Extra text at end of header line "+a+" ignored: "+i)}}else{if("["!=i[0])return e;if(t&&t(Game.E_INVALID_HDR,"Broken header line ignored",i))return null;console.log("*** Broken header line ignored:",i)}}}return e}()||{}).SetUp&&r.FEN||m,o.slice(a).join("\n").trim()))?null:(0==s.length&&s.push(Game.make_sentinel(m)),this.headers=r,this.body=s,this.rebuild_moves(),this.atsigns_to_positions(),reposition_move_nums(this),this)},Game.prototype.recalc_opening=function(){var e=_.findLastIndex(this.moves,function(e){return e.opcode});if(e>=0){var t=this.moves[e];this.headers.Opening=t.opcode+" "+t.opname}},Game.prototype.cond_recalc_opening=function(){this.headers.Opening||this.recalc_opening()},Game.prototype.rebuild_moves=function(){var e=0;this.moves=this.body.filter(function(t){return!!Game.is_move(t)&&(t.index_number=e++,!0)}),this.headers.PlyCount=""+this.moves.length},Game.make_game_name=function(e){if(e.CSGameName&&!e.CSGameName.startsWith("New Game")&&"?"!=e.CSGameName)return e.CSGameName;if(e.name&&!e.name.startsWith("New Game")&&"?"!=e.name)return e.name;var t=[];function n(e){return!(!e||!/[^-?.* ]/.test(e))}var i=function(e){if(!n(e))return"";var t=(e=e.replace(/\(.*\)/,"")).split(/\s*,\s*/);if(t.length>1){if(t=_.compact(t))return t[0]}else{var i=_.compact(e.split(/\s+/));if(i)return i[i.length-1]}return e};if(t.push(i(e.White)),t.push(i(e.Black)),n(e.Date)){e.Date;t.push(e.Date.replace(/\.\?\?$/,"").replace(/\.\?\?$/,""))}else n(e.Event)?(t.push(e.Event),n(e.Round)&&t.push("Round "+e.Round)):n(e.Result)&&t.push(e.Result);return(t=_.compact(t)).length||(e.SetUp&&t.push("SetUp"),n(e.Site)&&t.push(e.Site.replace(/^https?:\/\//,"").replace(/\/.*/,"")),(n(e.Event)||n(e.Round))&&t.push("("+(e.Event||"?")+" - Round "+(e.Round||"?")+")"),t=_.compact(t)),t.join(" ")},Game.prototype.orientation=function(e){if(_.isUndefined(this.headers)||_.isUndefined(this.headers.White)||_.isUndefined(this.headers.Black))return"white";for(var t=this.headers.White,n=this.headers.Black,i=0;i<e.length;i++)if(e[i]){if((r=e[i])==n)return"black";if(r==t)return"white"}t=t.toLowerCase(),n=n.toLowerCase();for(i=0;i<e.length;i++)if(e[i]){var r;if((r=e[i].toLowerCase())==n)return"black";if(r==t)return"white"}return"computer"==t||"anonymous"==t?"black":"white"},Game.enrich_move=function(e,t,n){if(e.ply=ply_from_fen(t),e.move_number=Math.floor(e.ply/2)+1,e.name=e.san,n)e.fen=n;else{var i=new Chess(t);i.move(e),e.fen=i.fen()}},Game.prototype.add_move_2=function(e){this.body;var t=this.curr_move;if(!t)return null;if(!t.fen)return null;var n=new Chess(t.fen),i=n.move(e);if(!i)return null;var r=n.fen(),s=this.find_item_parent(t);if(!s)return null;var o=this.which_next_move(s.variant,s.idx,r);if(o)i=o.variant[o.idx];else{var a=Game.find_next_move(s.variant,s.idx,1);if(a)this.add_variant(a).push(i),this.dirty=!0;else if(s.variant.push(i),this.dirty=!0,s.variant===this.body){this.headers.Result=this.resultStr(n);var m=this.moves.length;m>1&&0==(1&m)&&(this.moves[m-1].depth=null)}}return Game.enrich_move(i,t.fen,r),reposition_move_nums(this),this.rebuild_moves(),this.select_move(i),i},Game.prototype.fen_before=function(e,t){var n=e[t];if(Game.is_sentinel(n))return n.fen;for(--t;t>=0;--t)if((n=e[t]).hasOwnProperty("fen"))return n.fen;return null},Game.prototype.add_variant=function(e){if(!Game.is_move(e))return null;var t=this.find_item_parent(e);if(!t)return null;var n=t.variant,i=t.idx+1,r=this.fen_before(n,t.idx),s=[Game.make_sentinel(r)];return n.splice(i,0,s),update_pre_variants(s,n,i),reposition_move_nums(this),this.dirty=!0,n[i]},Game.prototype.in_main_line=function(e){return e=e||this.curr_move,this.body.indexOf(e)>=0},Game.prototype.promote_variant=function(e){if(!e||!Game.is_variant(e))return!1;var t=this.find_item_parent(e),n=t.variant,i=t.idx;if(!n)return!1;n.splice(i,1),update_pre_variants(null,n,i);var r=function(e,t){for(var n=t-1;n>0;n--)if(Game.is_move(e[n]))return n;return t}(n,i),s=n.splice(r,n.length);s.splice(0,0,e[0]),e.splice(0,1);var o=1+_.findIndex(e,function(e){return Game.is_move(e)});return e.splice(o,0,s),update_pre_variants(s,e,o),e.forEach(function(e){n.push(e)}),this.dirty=!0,reposition_move_nums(this),this.rebuild_moves(),!0},Game.prototype.append_move=function(e,t){if(!e||!Game.is_variant(e)||!Game.is_move(t))return null;if(!this.find_item_parent(e))return null;var n=Game.get_end_fen(e);if(!n)return null;var i=new Chess(n);return(t=i.move(t))?(Game.enrich_move(t,n,i.fen()),e.push(t),this.dirty=!0,e===this.body&&this.rebuild_moves(),reposition_move_nums(this),t):null},Game.prototype.append_comment=function(e){var t={kind:"{",text:"{"+e.replace("{","(").replace("}",")")+"}"};this.iter_items(function(e,n,i,r){if(Game.is_move(e)&&e.active){var s=n[n.length-1];return Game.is_comment(s)&&s.text==t.text||n.push(t),!0}return!1})},Game.prototype.make_curr_mv_the_tip=function(){!function e(t,n){for(var i=0;i<n.length;i++){var r=n[i];if(Game.is_move(r)&&r.active){if(Game.find_next_move(n,i)){var s=t.add_variant(r),o=Object.assign({},r);r.active=!1,s.push(o),t.promote_variant(s)}return!0}if(Game.is_variant(r)&&e(t,r))return t.promote_variant(r),!0}return!1}(this,this.body),this.rebuild_moves(),reposition_move_nums(this)},Game.prototype.clear_to_end_of_variant=function(e){if(!(e=e||this.curr_move))return!1;var t=this.find_item_parent(e);if(!t)return!1;var n=Game.find_next_move(t.variant,t.idx,-1);return n||t.variant===this.body?(t.variant.splice(Math.max(t.idx,1)),this.find_item_parent(this.curr_move)||this.select_move(n||this.body[0]),this.dirty=!0,t.variant===this.body&&this.rebuild_moves()):this.delete_variant(e),reposition_move_nums(this),!0},Game.prototype.delete_variant=function(e){var t,n;if(!(e=e||this.curr_move))return!1;if(Game.is_variant(e))n=e;else{if(!(t=this.find_item_parent(e)))return!1;n=t.variant}if(n&&Game.is_variant(n)){if(!(t=this.find_item_parent(n)))return!1;t.variant.splice(t.idx,1),update_pre_variants(null,t.variant,t.idx);var i=this.curr_move;if(!this.iter_items(e=>e===i,t.variant)){var r=Game.find_next_move(t.variant,t.idx,-1)||t.variant[0];this.select_move(r)}return reposition_move_nums(this),this.dirty=!0,!0}},Game.prototype.iter_items=function(e,t,n){t||(t=this.body),n||(n=null);for(var i=0;i<t.length;i++){var r=t[i];if(e(r,t,i,n))return{variant:t,idx:i,item:r};if(Game.is_variant(r)){var s=this.iter_items(e,r,{variant:t,idx:i,item:r,parent:n});if(s)return s}}return null},Game.prototype.iter_move_pairs=function(e){var t=[{v:null,m:null}],n=t[0];this.iter_items(function(i,r,s){if(0==s&&(n={v:r,m:null},t.push(n)),Game.is_move(i)&&e(n.m,i))return!0;if((Game.is_move(i)||Game.is_sentinel(i))&&(n.m=i),s==r.length-1){if(e(n.m,null))return!0;t.pop(),n=t[t.length-1]}})},Game.prototype.find_fen_and_mv=function(e,t){var n=null;return this.iter_move_pairs(function(i,r){return i.fen==e&&("*"==t||""!=t&&Game.mv2uci(r)==t?(n=i,!0):""==t&&!r&&(n=i,!0))}),n},Game.prototype.dfsNext=function(e,t){t||(t=function(e){return Game.is_move(e)||Game.is_sentinel(e)});var n=this.curr_move;if(-1==e){var i=null;return this.iter_items(function(e){if(e===n)return!0;t(e)&&(i=e)}),i}var r=!n,s=null;return this.iter_items(function(e){if(r&&t(e))return s=e,!0;e===n&&(r=!0)}),s},Game.prototype.flatNext=function(e,t,n){1!=e&&(e=-1),n||(n=this.curr_move),t||(t=function(e){return Game.is_move(e)||Game.is_sentinel(e)});var i=this.find_item_parent(n);if(!i)return null;for(var r=i.variant,s=i.idx+e;0<=s&&s<r.length;s+=e){var o=r[s];if(t(o))return o}return null},Game.prototype.find_item_parent=function(e){return e?this.iter_items(function(t){return t===e}):null},Game.find_next_move=function(e,t,n,i){-1!=n&&(n=1),i||(i=Game.is_move);for(var r=t+n;0<=r&&r<e.length;r+=n)if(i(e[r]))return e[r];return null},Game.get_end_fen=function(e){if(!e||!Game.is_variant(e))return null;for(var t=e.length;--t>=0;){var n=e[t];if(n.hasOwnProperty("fen"))return n.fen}return null},Game.prototype.which_next_move=function(e,t,n){for(var i=!1,r=t+1;r<e.length;r++){var s=e[r];if(Game.is_move(s)){if(i||s.fen!==n){if(i)return null;i=!0;continue}return{variant:e,idx:r,item:s}}if(Game.is_variant(s)){var o=this.which_next_move(s,0,n);if(o)return o}}return null},Game.prototype.main_line_move=function(e){for(var t,n,i=e||this.curr_move,r=i;r!==this.body;){if(!(t=this.find_item_parent(r)))return null;n=t.idx,r=t.variant}return this.body[n]===i?i:this.body[n-1]},Game.prototype.resultStr=function(e){return e.game_over()?e.in_checkmate()?"w"==e.turn()?"0-1":"1-0":"1/2-1/2":"*"},Game.prototype.add_position=function(e){"setup"==e.name.toLowerCase()&&(e.name="SetUp");var t=new Pos(e);if(_.find(this.positions,function(e){return t.same_as(e)})){if("position"==e.type){var n=_.findIndex(this.positions,function(e){return t.almost_same_as(e)});n&&(this.positions[n]=t)}}else this.positions.push(t);return this.dirty=!0,t},Game.prototype.get_start_fen=function(){return"1"==this.headers.SetUp&&this.headers.FEN?this.headers.FEN:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"},Game.prototype.get_main_line_sig=function(){return this.get_start_fen()+_.map(this.moves,function(e){return Game.mv2uci(e)}).join("")},Game.prototype.get_start_ply=function(){return ply_from_fen(this.get_start_fen())},Game.prototype.get_name=function(){return this.name||Game.make_game_name(this.headers)},Game.prototype.get_thumbnail_fen=function(){if(this.headers.FEN)return this.headers.FEN;if(this.headers.CSThumbnail)return this.headers.CSThumbnail;if(this.fen)return this.fen;for(var e=this.moves.length-1;e>=0;e--)if(this.moves[e].state)return this.moves[e].fen;return this.moves.length>0?this.moves[this.moves.length-1].fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"},Game.prototype.atsigns_to_positions=function(){var e=this,t={};e.moves.forEach(function(e){t[e.ply]=e});var n=null,i=e.get_start_fen(),r=0;e.body=e.body.filter(function(s){if(Game.is_move(s))i=(n=s).fen,r++;else if("{"==s.kind){switch(s.text){case"{@marked}":"m";break;case"{@sent}":case"{@analyzed}":"a";break;default:return!0}var o=n?t[n.ply+1]:null,a=new JobParams({type:"position",fen:i,next_move_uci:e.mv2uci(o),share_key:e.share_key,idx:r,name:n?n.san:"SetUp"});e.add_position(a);return!1}return!0})},Game.prototype.as_pgn=function(){var e=this,t=0,n="";function i(e,i,r){r&&t>40&&t+n.length+i.length>80&&(e.push("\n"),t=0),t>0&&(i=n+i),e.push(i),t+=i.length,n=" "}var r=[],s=e.headers,o=["Event","Site","Date","Round","White","Black","Result"];for(var a in o.forEach(function(e){var t=s[e]||"";r.push("["+e+' "'+t+'"]\n')}),s)s.hasOwnProperty(a)&&(o.indexOf(a)>-1||r.push("["+a+' "'+s[a]+'"]\n'));return r.push("\n"),function t(n,r){var s=!0;r.forEach(function(r){Game.is_comment(r)?_.each(r.text.replace("\n"," ").split(" "),function(e){i(n,e,!0)}):Game.is_move(r)?((s||r.ply%2==0)&&i(n,""+e.ply_to_move_num(r.ply),!0),s=!1,i(n,r.san,!1)):Game.is_variant(r)&&(i(n,"(",!0),t(n,r),i(n,")",!1),s=!0)})}(r,e.body),e.headers.Result&&r.push(" "+e.headers.Result),r.join("")},Game.prototype.as_dom=function(){var e=this,t=0,n=function(i,r){var s=!0;r.forEach(function(r){if(Game.is_move(r))(s||r.ply%2==0)&&i.append($("<span></span>").addClass("move-num").text(e.ply_to_move_num(r.ply))),s=!1,r.move_id=t,i.append($("<span></span>").addClass("move").addClass(r.color).addClass("mv-"+t++).attr("data-fen",r.fen).text(r.san));else if(Game.is_sentinel(r))i.append($("<span></span>").addClass("path-start").attr("data-fen",r.fen));else if(Game.is_comment(r))i.append($("<span></span>").addClass("comment").text(r.text));else if(Game.is_variant(r)){var o=$("<span></span>").addClass("variant");n(o,r),i.append($("<span></span>").addClass("variant-start").text("(")),i.append(o),i.append($("<span></span>").addClass("variant-end").text(")")),s=!0}})},i=$("<div></div>").addClass("game");return n(i,e.body),e.headers.Result&&i.append($("<span></span>").addClass("result").text(e.headers.Result)),i};
