"use strict";chessStories.directive("appHistDlg",[function(){var e={};return{restrict:"EA",scope:{guid:"=histGuid",tags:"=histTags",tabs:"=histTabs",popupMsg:"=histPopupMsg",mainMenu:"<histMainMenu",getPristineTab:"=histGetPristineTab",selectTab:"=histSelectTab",ga:"=histGa",histShow:"=",onCloseDialog:"&"},templateUrl:"/static001767/app/shared/history2/history2View.html",controllerAs:"history2",link:function(e,n,t){$(".hist-dlg",n).draggable({appendTo:"body",containment:"window",handle:".hist-dlg-header",scroll:!1,zIndex:99})},controller:["$scope","$timeout","$rootScope","gameService","i18nService","Kbd","themeService",function(n,t,o,a,s,l,r){var i=this,c=s.phrases;function u(){if(i.selected_row){var e,t=_.map((e=i.selected_row)?(e.tags||"").split(","):[],function(e){return e.toLowerCase()}),o=_.map(i.all_tags,function(e){return{tag:e,id:n.guid(),selected:t.includes(e.toLowerCase())}});n.tags.openDlg(o,function(e,n){if("add"==e){var t=n;i.selected_row.tags?i.selected_row.tags=i.selected_row.tags+","+t:i.selected_row.tags=t}else if("delete"==e){var o=n.toLowerCase(),s=(i.selected_row.tags||"").split(",");s=_.filter(s,function(e){return e.toLowerCase()!=o}),i.selected_row.tags=s.join(",")}else if("end"==e){var l=n,r=_.filter(l,function(e){return e.selected}),u=_.map(r,function(e){return e.tag});i.selected_row.tags=u.join(","),function(e){var n=e.tags;a.update(e.key,null,null,n,function(e,n){"ok"!=e&&n&&m(c.err_upd_tags_msg+": "+n,!1,3500)})}(i.selected_row),i.all_tags=p(i.all_data)}})}}function d(e){if(!e)return{};var n=e.split("\n\n")[0],t={};return _.each(n.split("\n"),function(e){var n=e.match(/\[([^ ]+) "?([^\]"]+)"?\]/);n&&(t[n[1]]=n[2])}),t}function g(){var e=i.editing_name_row;if(e){i.editing_name_row=null;var n=i.edited_name.trim(" ").replace(/ +/g," ");n!=e.name&&(e.name=n,a.update(e.key,!1,e.name,null,function(n,t){"ok"!=n&&t&&m(c.err_upd_game_name_msg+": "+t,!1,3500),"ok"==n&&o.$broadcast("game-name-change",{key:e.key,name:e.name})}))}}function h(e,o=null){if(g(),i.show_row_menu=!1,e){i.selected_row=e,i.sel_info_headers=d(i.selected_row.pgn);var s="b"==i.sel_info_headers.Orientation?"black":"white";a.getGame(e.key,function(e,a){a?m(c.cannot_show_game_msg+": "+a,!1,4e3):(i.selected_game=e,t(function(){n.preview_board.board.orientation(s)},1)),o&&o()})}else i.selected_row=null,i.sel_info_headers=d(null),i.selected_game=null,o&&o()}function p(e){var n={};_.each(e,function(e){_.each((e.tags||"").split(","),function(e){n[e.toLowerCase()]=e})}),delete n[""];var t=Object.values(n);return t.sort(function(e,n){return(e=e.toLowerCase())>(n=n.toLowerCase())?1:e<n?-1:0}),t}n.i18n=c,i.all_data=[],i.filter_by="",i.search_by=null,i.data=[],i.showing_n_games_msg="",i.next_key="",i.loading=!1,i.selected_row=null,i.selected_rows=[],i.editing_name_row=null,i.show_row_menu=!1,i.showSearchDlg=!1,i.hideSearchDropdowns=null,i.sel_info_headers={},i.cb=null,i.n_opened_games=0,i.openGamesInProgress=!1,i.showDeleteConfirmation=!1,i.currentlyDeleteGame=0,i.totalGamesToDelete=0,i.deleteGamesInProgress=!1,n.preview_board=e,i.options={rowHeight:30,headerHeight:32,footerHeight:!1,scrollbarV:!0,selectable:!0,multiSelect:!0,checkboxSelection:!1,emptyMessage:"",loadingMessage:"",columns:[{name_source:"",name:"",prop:"",width:33,isCheckboxColumn:!0,headerCheckbox:!0,minWidth:33},{name_source:"Name",name:c.Name,prop:"name",template:'<div class="name" ng-class="{empty:!$cell}">{{$cell}}<input class="edit-box clk ng-hide" focus-on-show ng-show="history2.editing_name_row === $row" ng-model="history2.edited_name" ng-change="history2.onEditedNameChange()" ng-blur="history2.onEditedNameBlur()"></div>',width:230},{name_source:"Tags",name:c.Tags,prop:"tags",template:'<div class="tags" ng-class="{empty:!$cell}">{{history2.spacer($cell)}}</div>',width:165},{name_source:"Updated",name:c.Updated,prop:"upd",cellDataGetter:function(e){return e?e.substring(0,16):""},width:134},{name_source:"Origin",name:c.Origin,prop:"origin",width:90,cellDataGetter:function(e){return e?["play","replay","example","history",""].includes(e)?e:["?","pasted_pgn","pasted_fen","user_file","pgn","setup"].includes(e)?{"?":"",pasted_fen:"FEN",pgn:"PGN file",user_file:"PGN file",setup:"Set Up"}[e]:e:""}},{name_source:"Game_Date",name:c.Game_Date,prop:"headers.Date",width:115},{className:"ellipsis",frozenRight:!0,width:30,minWidth:30,template:'<div class="ellipsis" ng-click="history2.onEllipsisClick($event, $row)">&#8942;</div>'}]},i.spacer=function(e){return e?e.replace(/,/g,", "):""},i.onRowClick=function(e){i.clearSelectedRows(),i.selected_rows.push(e),h(null)},i.onRowDblClick=function(e){i.clearSelectedRows(),i.selected_rows.push(e),i.openGames()},i.onBGClick=function(e){e&&e.stopPropagation(),i.show_row_menu=!1,i.hideSearchDropdowns(),i.showSearchDlg=!1},i.onKeyDown=function(e){e&&e.stopPropagation()},i.onEllipsisClick=function(e,n){e&&e.stopPropagation();var t=$(e.target).parents(".dt-row");h(n,function(){if(!(t.length<1)){var e=$(".hist-dlg .hist-table"),n=3+t.offset().top-e.offset().top;$(".hist-dlg .popup-menu-cont").css("top",n+"px"),i.show_row_menu=!0}})},i.onEditTags=function(e){i.show_row_menu=!1,t(u)},i.onRowSelect=function(e){!function(){for(var e=i.selected_rows,n=e.length-1;n>=0;--n)e[n]||e.splice(n,1)}(),t(function(){var n=e.length>0?e[0]:null;1!=e.length||e[0]||(n=null),h(n)},1)},i.onFilter=function(){i.filter()},i.onEditName=function(e){e&&e.stopPropagation(),i.show_row_menu=!1,i.selected_row&&(i.editing_name_row=i.selected_row,i.edited_name=i.selected_row.name)},i.onEditedNameBlur=function(){g()},i.onEditedNameChange=function(){},i.onSearchUpdate=function(){i.filter()},i.openDlg=function(e){_.each(i.options.columns,function(e){e.name_source&&$('[data-id="'+e.$id+'"] .dt-header-cell-label').text(c[e.name_source])}),i.cb=e,i.show=!0,i.getHistory(),h(null),t(function(){angular.element(window).resize(),i.data.push({}),t(function(){i.data.pop()},50)},50)},i.getHistory=function(e){if(e&&!i.next_key)return;i.loading=!0,i.all_data=[],i.data=i.all_data,a.getHistory(function(e,t){i.all_data=e,i.filter(),i.loading=!1,"notloggedin"!==t?(n.not_logged_in=!1,i.all_tags=p(i.all_data),function(e){var n=new Game;_.each(e,function(e){void 0===e.headers&&(e.headers=n.parse_headers(e.pgn))})}(i.all_data),i.all_players=function(e){var n={};_.each(e,function(e){n[e.headers.Black.toLowerCase()]=e.headers.Black,n[e.headers.White.toLowerCase()]=e.headers.White}),delete n[""];var t=Object.values(n);return t.sort(function(e,n){return(e=e.toLowerCase())>(n=n.toLowerCase())?1:e<n?-1:0}),t}(i.all_data),i.all_openings=function(e){var n={};_.each(e,function(e){e.openings&&_.each(e.openings,function(e){n[e[1].toLowerCase()]=e[1]})}),delete n[""];var t=Object.values(n);return t.sort(function(e,n){return(e=e.toLowerCase())>(n=n.toLowerCase())?1:e<n?-1:0}),t}(i.all_data)):n.not_logged_in=!0},function(e){i.loading=!1,n.popupMsg.showText(e,!1,4500)})},i.filter=function(){var e=i.filter_by,n=i.all_data;e||null!==i.search_by?(null!==i.search_by&&(n=_.filter(i.all_data,i.search_by)),e&&(e=e.toLowerCase(),n=_.filter(n,function(n){return n.name&&n.name.toLowerCase().includes(e)||n.tags&&n.tags.toLowerCase().includes(e)||n.pgn&&n.pgn.toLowerCase().includes(e)||n.origin&&n.origin.toLowerCase().includes(e)})),i.data=n,i.selected_row&&_.every(i.data,function(e){return e!==i.selected_row})&&h(null)):i.data=i.all_data,i.deselectInvisibleRows(i.data)},i.deselectInvisibleRows=function(e){var n=i.selected_rows.filter(function(n){var t=!1;return e&&e.length&&e.find(function(e){return e.key===n.key})&&(t=!0),t});i.clearSelectedRows(),n.map(function(e){i.selected_rows.push(e)})},i.onDelete=function(e,n=null,t=null){e&&e.stopPropagation();var o=n||i.selected_row;o&&a.update(o.key,!0,null,null,function(e,n){"ok"==e&&(h(null),i.all_data=_.filter(i.all_data,function(e){return e!==o}),i.filter()),t&&t()})};var m=function(e,t,o){n.popupMsg.showText(e,t,o)};function f(){var e=i.data||[],n=i.all_data||[],t=i.filter_by||i.search_by?c.h_showing_n_of_m_games:c.h_showing_n_games;i.showing_n_games_msg=t.replace("{num_shown}",e.length).replace("{num_total}",n.length)}i.closeDlg=function(){var e;i.show=!1,i.all_data=[],i.selected_game=null,i.clearSelectedRows(),n.popupMsg.dismiss(e),i.cb&&i.cb(),i.cb=null,n.onCloseDialog()},i.findOpenGame=function(e){return n.tabs.findIndex(function(n){return n.game.key===e.key})},i.openSelectedGame=function(e=null,t=null){var o=e||i.selected_row,s=i.findOpenGame(o);if(!o||s>=0)return s>=0&&(n.selectTab(s),a.touch_game(e)),void(t&&t());o.name,o.origin;i.show_row_menu=!1,a.getGame(o.key,function(e,o){if(o)m(c.cannot_show_game_msg+": "+o,!1,4e3);else{var a=n.getPristineTab();a.share_key=e.share_key||"",n.selectTab(a),a.set_game(e),e.moves&&0!=e.moves.length||a.setjp("p",e.headers.FEN,"",null,c.job_name_setup,""),t&&t()}})},i.openGames=function(){if(i.selected_rows.length&&!i.openGamesInProgress){var e=i.data.filter(function(e){return!!i.selected_rows.find(function(n){return n.key===e.key})});i.openGamesInProgress=!0,i.n_opened_games=0,function n(){if(i.n_opened_games++,i.n_opened_games>e.length)return i.openGamesInProgress=!1,void i.closeDlg();if(i.openGamesInProgress){var t=e[i.n_opened_games-1];i.openSelectedGame(t,function(){i.n_opened_games>1&&(i.data.unshift(),i.data.splice(i.n_opened_games,0)),n()})}}()}},i.stopGamesOpening=function(){i.openGamesInProgress=!1},i.onCancelBtn=function(){n.ga("history2-dlg","close-by-cancel",""),i.closeDlg()},i.clearSelectedRows=function(){i.selected_rows.splice(0)},i.onSearchBtn=function(e){e&&e.stopPropagation(),i.showSearchDlg=!0},i.onDeleteRowsBtn=function(){var e;i.selected_rows.length&&!i.openGamesInProgress&&(1===i.selected_rows.length?i.onDelete(null,i.selected_rows[0]):(e=c.confirmation_dialog_will_be_deleted,i.deleteConfirmationContent=e.replace("{}",i.selected_rows.length),i.showDeleteConfirmation=!0))},i.onCancelDeleteGamesDialog=function(){i.showDeleteConfirmation=!1},i.deleteGames=function(){i.onCancelDeleteGamesDialog(),i.selected_rows.length&&!i.deleteGamesInProgress&&(i.totalGamesToDelete=i.selected_rows.length,i.deleteGamesInProgress=!0,i.currentlyDeleteGame=0,function e(){i.currentlyDeleteGame++,i.currentlyDeleteGame>i.totalGamesToDelete?i.deleteGamesInProgress=!1:i.deleteGamesInProgress&&i.onDelete(null,i.selected_rows[0],e)}())},i.stopGamesDeleting=function(){i.deleteGamesInProgress=!1},n.$on("Esc",function(e,o){if(i.show){if(i.showSearchDlg)return;if(i.show_row_menu)return void(i.show_row_menu=!1)}i.show&&!n.tags.isOpen()&&(n.ga("history2-dlg","close-by-Esc",""),t(i.closeDlg,1))}),o.$watch("currentUser.prefs.pieces",function(){i.preview_board&&i.preview_board.redraw()}),n.$on("enter-mobile-mode",function(){$(".hist-dlg").css({top:"",left:""})}),n.$watchGroup(["history2.filter_by","history2.search_by","history2.data.length","history2.all_data.length"],function(){f()}),o.$watch("currentUser.lang",function(){f()});var w=o.$on("user-set",function(){a.getHistory(null,null,!0)});function y(){n.mainMenu&&"history"===n.mainMenu.skeleDlgFor.who&&(n.mainMenu.showSkeleDlg("history",null,null),n.mainMenu.hideSkeleDlg())}n.$on("$destroy",function(){w()}),n.$watch("histShow",function(e){e&&(i.openDlg(null),y())}),y(),n.$emit("lazy-loaded",{module:"history"})}]}}]);
