angular.module("chessStories").directive("pgnArea",[function(){return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/pgnArea/pgnAreaView.html",controller:["$scope","$rootScope","$timeout","i18nService","tutorService","Kbd","Fens","keyMomentsService",function(e,o,t,r,n,a,i,s){var m=r.phrases,u=e.$parent;u.move_menu&&(u.move_menu.hide(),u.move_menu.recalc_pos()),u.pgn_curr_move=function(){return u.currTab&&u.currTab.game?u.currTab.game.curr_move:null};u.pgn_on_key=function(e){if(e==a.LEFT||e==a.RIGHT||e==a.UP||e==a.DOWN||e==a.HOME||e==a.END||e==a.ENTER||e==a.ESC){u.hideMoveMenu();var o=u.currTab.game;if(e!=a.ENTER)e!=a.ESC&&(e==a.LEFT?u.onGameBack():e==a.RIGHT?u.onGameForward():e==a.DOWN?u.onGameEnterVariant():e==a.UP?u.onGameExitVariant():e==a.HOME?u.onGameStart():e==a.END&&u.onGameEnd());else{if(!o.curr_move)return;var t=$(".moves-list .selected-move").first();u.pgn_showMoveMenu(o.curr_move,null,t)}}},u.onGameStart=function(){var e=u.currTab,o=e.game;if(o&&o.moves.length){u.hideMoveMenu();var t=o.find_item_parent(o.curr_move);if(t){var r=t.variant[0];u.selectMove(e,r),u.key_focus="game"}}},u.onGameBack=function(){var e=u.currTab,o=e.game;if(o&&o.moves.length){u.hideMoveMenu();var t=o.flatNext(-1);t&&u.selectMove(e,t),u.key_focus="game"}},u.onGameForward=function(){var e=u.currTab,o=e.game;if(o&&o.moves.length){u.hideMoveMenu();var t=o.flatNext(1);t&&u.selectMove(e,t),u.key_focus="game"}},u.onGameEnd=function(){var e=u.currTab,o=e.game;if(o&&o.moves.length){u.hideMoveMenu();var t=o.find_item_parent(o.curr_move);if(t){for(var r=t.variant,n=r.length-1;n>=0;n--)if(Game.is_move(r[n])){u.selectMove(e,r[n]);break}u.key_focus="game"}}},u.onGameEnterVariant=function(){var e=u.currTab,o=e.game;if(o&&o.moves.length){u.hideMoveMenu();var t=o.dfsNext(1,Game.is_sentinel);t&&u.selectMove(e,t)}},u.onGameExitVariant=function(){var e=u.currTab,o=e.game;if(o&&o.moves.length){u.hideMoveMenu();var t=o.find_item_parent(o.curr_move);if(t){var r=o.find_item_parent(t.variant),n=null;if(r){for(var a=r.idx;0<=a&&a<r.variant.length;a--)if(Game.is_move(r.variant[a])||0==a){n=r.variant[a];break}}else n=o.body[0];n&&u.selectMove(e,n)}}},u.pgn_showMoveMenu=function(o,t,r){if(u.move_menu&&u.move_menu.shown)u.move_menu.hide();else{if(o){if(!Game.is_move(o))return}else{if(!(o=u.currTab.game.curr_move))return;r=$(".moves-list .selected-move")}var n,a;if(t&&((r=$(t.currentTarget||t.target)).hasClass("move")||(o=null),t.stopPropagation()),r&&r.length)e.mobile?e.mobile_p?r.offset().left+r.width()>=window.innerWidth/2?(n=[r.offset().left,r.offset().top],a="left"):(n=[r.offset().left+r.width(),r.offset().top],a="right"):(n=[r.offset().left,r.offset().top],a="left"):u.game_panel_pos?1===u.game_panel_pos?(n=[r.offset().left+r.width(),r.offset().top],a="right"):2===u.game_panel_pos&&(n=[r.offset().left,r.offset().top],a="left"):(n=[r.offset().left+r.width(),r.offset().top],a="right"),u.move_menu.setModel(o,n,a),u.move_menu.show(),u.key_focus="game"}};function l(e){return(Game.is_move(e)||Game.is_sentinel(e))&&(!u.mobile&&!!e.ex_id||!!e.job)}function c(e,o){e&&(e.stopPropagation(),e.preventDefault());var t=u.currTab,r=t.game,n=function(e,o){return e.dfsNext(o,l)}(r,o);if(u.mobile&&t.decode_game_job){var a=s.next_key_moment(r,t.decode_game_job,o);(n=n||a)&&a&&n!==a&&Math.sign(n.index_number-a.index_number)===Math.sign(o)&&(n=a)}n&&u.selectMove(t,n)}function v(e,o){e&&(e.stopPropagation(),e.preventDefault());var t=u.currTab,r=t.tutor,n=t.decode_game_job;if(n){var a=r.nextprev_moment(t.game,n.jparam.exp_color,o);a&&u.selectMove(t,a)}}function f(e){if(!$('#results [data-e="'+(e.ex_id||"qqq")+'"].pgn-selected').length){var o=u.currTab.tutor;if(e.show_exp&&(d(),e.ex_id)){var t=$('#results [data-e="'+e.ex_id+'"]');t.addClass("pgn-selected").show(201),o.explain(e,t)}}}function d(){return $("#results .pgn-selected").removeClass("pgn-selected").hide(201)}u.pgn_clickMove=function(e){u.currTab.play_mode.reset&&u.currTab.play_mode.reset();var o=u.currTab;u.hideMoveMenu(),u.selectMove(o,e),u.key_focus="game",o.n_selected_move_events++},u.pgn_rightClickMove=function(e,o){u.pgn_showMoveMenu(e,o)},u.selectMove=function(e,o,r,n){var a=e.game;if(a&&!(a.body.length<2)){var i=a.curr_move;if(a.deselect_move(),null!==o){var s=null;if(_.isFinite(o)){var l=o;if(s=a.body,l<-1||l>=a.moves.length)return;o=l>=0?a.moves[l]:a.body[0]}else if(!_.isObject(o))return void console.error("bug: select move param is not a move. Not even an object:",o);var c=a.find_item_parent(o);if(c){if(s=c.variant,index=c.idx,o=c.item,e.play_mode&&"play"==e.play_mode.mode&&!n&&o!==i&&e.play_mode.pause(i),a.select_move(o),o){var v=Game.find_next_move(s,index),p=v?a.mv2uci(v):"",g=o&&Game.is_move(o)?o.san:"â—";e.setjp("p",o.fen,p,s===a.body?index:null,g,v),e.set_key_moment_idx(),e.check_game_review(),e.tutor&&e.tutor.mark_moment_seen(o),e.hide_cards("dgame"),e.hide_cards("reviewed")}else e.setjp("p","","",null,m.job_name_setup,"");if(o){var b=e===u.currTab;d(),b&&u.board.setFen(o.fen),r||o.job===u.currTab.currJob||(u.save_job_display_state(),u.selectJob(u.currTab,o.job,!0)),e.currJob&&"curr_move"==e.currJob.topic&&!o.job&&(e.currJob.topic="summary"),Game.is_sentinel(o)||!o.job||e.currJob&&"curr_move"==e.currJob.topic?(u.currTab.dgame_ex_shown=!0,f(o)):u.currTab.dgame_ex_shown=!1,b&&u.rebuildCapturedPieces(),e.last_move_arrow=Game.is_move(o)?"lastmove,10,"+o.from+" "+o.to+",":null,b&&u.setEmphasizedArrow(),o.active=!0,e.game_map&&e.game_map.select(s===a.body?o:null),b&&t(function(){!function(e){var o=$('.moves-item[data-fena="'+e.fen+'"]');u.scrollIntoView(null,o)}(o)},100)}}else console.error("bug: select move param is not a move:",index)}}},u.scrollGameToSelectedMove=function(){u.currTab;var e=$(".moves-list .selected-move");e.length>0&&u.scrollIntoView(null,e)},u.gotoNextResult=function(e){u.currTab.tutor.enabled?v(e,1):c(e,1)},u.gotoPrevResult=function(e){u.currTab.tutor.enabled?v(e,-1):c(e,-1)},u.show_decode_game_explanation=f}],link:function(e,o,t){$(window).resize(function(){e.hideMoveMenu(),e.$apply()}),$(".moves-list-ol",o).scroll(function(){e.hideMoveMenu(),e.$apply()})}}}]);
