"use strict";angular.module("chessStories").directive("appAnalyzeResult",["$timeout","i18nService","websiteService","Kbd","arrowsService","keyMomentsService","preDgameService",function(t,e,a,r,s,n,o){var i=e.phrases;return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/analyzeResult/analyzeResultView.html",controllerAs:"explanation",controller:["$scope",function(t){this.onGotoFirstKeyMoment=function(e){e&&e.stopPropagation();var a,r=t.currTab;r.tutor.show_intro=!1,a=r.key_moments.length?n.first_key_moment(r.game,r.decode_game_job):r.game.moves[0],t.selectMove(r,a),t.ga("tutor-first-key-moment","","")},this.onTutorToggle=function(t){},this.onTutorShowWhy=function(e){e.stopPropagation(),t.currTab.tutor.show_why()},this.onTutorHideShowWhy=function(e){e.stopPropagation(),t.currTab.tutor.hide_why(),t.onReset()},this.onTutorExplainMove=function(e){e.stopPropagation();var a=t.currTab,r=a.game.curr_move;a.tutor.reveal_move(r),a.tutor.explain(r)},t.$on("tutor-decode-complete",function(e,a){a.job.dom=$("<div>"),t.process_short_decode(a.job.response.text,-1,a.job),t.currTab.tutor.clone_dgame_into_tutor($(a.job.dom),!1)}),t.$watch("currTab.game.curr_move",function(e,a){e!==a&&t.currTab.tutor.reset()}),t.$on("pos-reset",function(){t.currTab.tutor.reset()})}],link:function(e,n,d){e.onTopicTabClick=function(t){t.stopPropagation();var a=$(t.target).attr("data-topic");a&&("threats"==a&&(a=e.currTab.threats_status_now?"threats_before":"threats_after"),e.currTab.currJob.topic=a,u(null,"preserve"),e.ga("change-topic",a,""))};var l=$();function c(t){$(".curr-explanation").removeClass("curr-explanation"),(t=$(t).closest("[data-e]")).addClass("curr-explanation")}e.topic_of=function(t){return $(t).closest(".topic").attr("data-topic")};var p=function(){var t=$("[data-l] .curr-elem,.curr-elem[data-l]").closest("[data-l]").attr("data-l"),a=$("[data-sq] .curr-elem,.curr-elem[data-sq]").closest("[data-sq]").attr("data-sq");e.light_attrs=t?[t]:a?[a]:[]};function u(t,a){c(t=$(t));var r=!1;if(j(t))$(".active-move").removeClass("active-move"),"preserve"!=a&&(t.hasClass("opened")&&"open"!=a?(t.removeClass("opened"),r=!0):t.hasClass("opened")||"close"==a||(t.addClass("opened"),r=!0));else if(t.hasClass("move")){$(".active-move").removeClass("active-move"),t.addClass("active-move");var s=t.closest(".dcpath");s.length&&e.scrollIntoView(s,t,!0,B)}$(".curr-hdr").removeClass("curr-hdr");var n=t;for(j(n)&&n.addClass("curr-hdr");n&&n.length&&!n.hasClass("topic");)(n.hasClass("foldable")||n.attr("data-fold"))&&L(n).addClass("curr-hdr"),n=n.parent();M(t),p(),E(t);var o=t.attr("data-fena");if(o){for(var i=t.next();i.length>0&&!i.attr("data-fena");)i=i.next();var d=t.text(),l=i.length>0?i.text():"",u=i.length>0?function(t,e){var a=new Chess(t).move(e);return a?a.from+a.to+(a.promotion||""):""}(o,i.text()):"";e.currTab.setjp("p",t.attr("data-fena"),u,null,d,l),e.set_curr_move(t),R(t);var m=function(t){var e=t.attr("data-ft");if(e)return{from:(e=e.split(" "))[0],to:e[1]};for(var a=t.text(),r=t.prev();r.length;){var s=r.attr("data-fena");if(s&&s.length)return new Chess(s).move(a);r=r.prev()}return null}(t);e.currTab.last_move_arrow=m?"lastmove,10,"+m.from+" "+m.to+",":null}"attacks"==e.currTab.currJob.topic&&r&&e.force_arrows_change++,f(t),h(t)}function h(t){if(!t.closest(".bpmf-item-cont").length){var e=$(".bpmf-item-cont.bpmf-selected"),a=t.attr("data-bpmfe"),r=null,s=null;if(a)s=t,r=$('.bpmf-item-cont[data-e="'+a+'"]');else{if(0==t.closest(".path.best-play").length)return;if(t.hasClass("sentinel")){var n=$(".gist .best-play.path").children(".move:not(.sentinel)").first();a=n.attr("data-bpmfe"),s=n,r=$('.bpmf-item-cont[data-e="'+a+'"]')}}r&&e.is(r)||(e.removeClass("bpmf-selected").hide(200),$(".bpmf-owner").removeClass("bpmf-owner"),r&&(s.addClass("bpmf-owner"),r.addClass("bpmf-selected").show(200)))}}var f=function(t){if(W([]),t){var e=(t=$(t)).closest(".topic,[data-a]").attr("data-a");e?W(e.split(";"),!0):j(t)&&t.hasClass("opened")&&$("[data-a]",A(t)).each(function(t,e){W(($(e).attr("data-a")||"").split(";"),!0)})}};e.click_on_square=function(t,a){if(e.bubble.hide(),v(),t[a]){var r=e.currTab.currJob;if(r&&"position"==r.jparam.type&&"complete"==r.state){var s=$('#results .func-res .piece[data-sq="'+a+'"]');s.length<1||("summary"==r.topic?function(t){var a=t.attr("data-a");if(!a)return;var r=a.split(";");r=_.map(r,function(t){return"sum_prol "+t}),e.role_arrows=r,W(r),m=(new Date).getTime()}(s):"functionality"==r.topic&&u($(".top-hdr",s),"open"))}}};var m=0;function v(){e.role_arrows&&e.role_arrows.length&&(e.role_arrows=[],s.select_arrows_by_eids([]))}var b=!1;"results"===d.id&&e.$on("dismiss-popups",function(t,a){var r=(new Date).getTime()-m;(!a||"soft"!=a.why||r>400)&&(v(),b&&(e.bubble.hide(),b=!1))}),e.$watchGroup(["currTab","currTab.currJob","currTab.currJob.topic"],function(){v()});var g=function(t){for(t=$(t).first().next();t.length&&!t.hasClass("move");t=t.next())t.hasClass("ops")&&t.nextAll().show(200);return t},y=function(t){for(t=$(t).first().prev();t.length&&!t.hasClass("move");t=t.prev());return t},C=function(t){return $(".move[data-fena]",$(t).closest(".path")).first()},w=function(t){var e=$(t).closest(".path");return $(".ops",e).first().nextAll().show(200),$(".move[data-fena]",e).last()},k=function(t){return $(".move[data-fena],.is-hdr,.like-hdr",t).first()},x=function(t,e,a){var r=$();return t.find(a).each(function(t){var a=$(this);if(a.is(e))return!1;r=a}),r};function T(t,e,a){var r=null,s=!1;return t.find(a).each(function(t){$(this);if($(this).is(e))s=!0;else if(s)return r=$(this),!1}),r}function J(t){t=$(t).first();for(var e=["mf-hdr","ehdr","hdr","cn-kind","mv-hdr","athr","cthr","like-hdr","is-hdr"],a=0;a<e.length;a++)if(t.hasClass(e[a]))return e[a];return null}function j(t){return $(t).hasClass("is-hdr")}function P(t){return $(t).hasClass("like-hdr")}function L(t){var e,a=(t=$(t)).attr("data-fold");if(a)e=$("[data-clk="+a+"]",n);else{for(;t&&t.length&&!j(t.prev());)t=$(t.parent());e=t.prev()}return e}function A(t,e){t=$(t),e=e||n;var a,r,s=$();return t.each((t,n)=>{n=$(n),a=n.attr("data-clk"),r=a?$("[data-fold="+a+"]",e):n.next(),s=s.add(r)}),s}function I(t){e.scrollIntoView($("#results .results-cont"),t,!1)}var E=function(t){if(!t.hasClass("opened"))return j(t)&&!t.hasClass("unfoldable")&&A(t).hide(200),void I(t);var e,a=function(t){if(!t)return[];for(var e=[],a=$(t);a&&a.length&&!a.hasClass("topic");a=a.parent())e.push(a);return e.reverse(),e}(t),r=[];for(e=0;e<a.length;e++)(a[e].hasClass("foldable")||a[e].attr("data-fold"))&&r.push(a[e]);j(t)&&r.push(A(t));var s=!1;for(e=0;e<r.length;e++)r[e].is(":hidden")&&(r[e].show(200,s?null:function(){I(t)}),L(r[e]).addClass("opened"),s=!0);s||I(t)},M=function(t){t||(t=$()),l.removeClass("curr-elem"+(l.hasClass("move")?" active-move":"")),(l=$(t).first()).addClass("curr-elem"+(l.hasClass("move")?" active-move":""))};function S(){var t=l;if(t.hasClass("move")&&(t=C(t)).length)return u(t),!0}function U(){var t=l;if(t.hasClass("move")&&(t=w(t)).length)return u(t),!0}function q(){var t=l;if(!l.length&&((t=$("#results .topic:visible .top-hdr").first()).length||(t=$("#results .topic:visible .like-hdr").first()),t.length))return u(t,"open"),!0;if(!t.length)return!1;if(t.hasClass("move")){if((t=g(t)).length)return u(t),!0}else if(j(t)){if(!t.hasClass("opened"))return u(t,"open"),!0;var e=A(t),a=k(e);if(a.length)return u(a,"open"),!0}return!1}function z(){if(!l.length)return!1;var t=l;if(t.hasClass("move")){var e=y(t);if(e.length)return u(e),!0;if((t=L(t)).length)return u(t,"preserve"),!0}else if(j(t)){if(t.hasClass("opened"))return u(t,"close"),!0;var a=L(t.parent());if(a.length)return u(a,"preserve"),!0}return!1}function D(){if(!l.length)return!1;var t=l;if(t.hasClass("move")){var e=t.closest(".path"),a=L(t),r=A(a),s=x(r,e,".path");return s.length?u(s.children(".move").first()):u(a,"preserve"),!0}if(j(t)||P(t)){var n=L(t.parent()),o=null;o=n.length?A(n):t.closest(".topic,.dgmf-cont");var i=t.hasClass("top-hdr")?"top-hdr":J(t),d=x(o,t,"."+i);return!!d.length&&(u(d,"preserve"),!0)}}function F(){var t=l;if(!l.length&&((t=$("#results .topic:visible .top-hdr,#results .dgame-cont:visible .is-hdr",n).first()).length||(t=$("#results .topic:visible .like-hdr",n).first()),t.length))return u(t,"preserve"),!0;if(!t.length)return!1;if(t.hasClass("move")){var e=t.closest(".path"),a=L(t),r=T(A(a),e,".path");if(r&&0==r.closest(".hidden,.ovf-hidden").length)return u(r.children(".move").first()),!0;if((o=T(s=a.closest(".topic,.dgmf-cont"),a,"."+J(a)))&&o.is(":visible"))return u(o,"preserve"),!0}else if(j(t)||P(t)){var s;s=(s=L(t.parent())).length?A(s):t.closest(".topic,.dgmf-cont");var o,i=t.hasClass("top-hdr")?"top-hdr":J(t);if((o=T(s,t,"."+i))&&o.is(":visible"))return u(o,"preserve"),!0}return!1}function R(t){if(t.is(":visible")){var a=e.currTab;if(a){a.currJob;var r=null;s.get_arrow_roles_disp("local")&&(r=$(t).attr("data-la")),a.move_arrows=r?[r]:[],a.move_arrows_fen=$(t).attr("data-fena")}}}function W(t,e){e||s.select_arrows_by_eids([]);var a=s.select_arrows_by_eids();t.forEach(function(t){t&&t.split(",")[3].split(" ").forEach(function(t){a.push(t)})}),s.select_arrows_by_eids(a)}function G(t){var e=!t.s||"nm"==t.s.toLowerCase(),a=["move",t.c];return e&&a.push("nm"),$('<span class="'+a.join(" ")+'"'+(t.a?' data-fena="'+t.a+'"':"")+"></span>").text(e?"..":t.s)}function H(t,e,a){var r=$("<div></div>");return a&&r.append($("<div></div>").addClass("hdr").text(a+":")),r.append(function(t,e){var a=$('<span class="path nospaces"></span>');e&&a.append('<span class="move sentinel medium" data-fena="'+t+'"><span class="in-sentinel">&#9899;</span></span>');for(var r=0;r<e.length;r++){var s=e[r];"w"!=s.c&&0!=r||a.append(" ",$('<span class="movenum '+s.c+'"></span>').text(s.n+("w"==s.c?".":"..."))),a.append(G(s))}return a}(t,e)),r}function O(t,e){var a,r;(a=$("<div></div>")).append($("<div></div>").addClass("hdr").text(e+":")),a.append("<ul></ul>"),0==t.length&&a.children().last().addClass("empty").text(i.none_found);for(var s=0;s<t.length;s++){var n=t[s];r=$('<li class="mlist"></li>'),n.r&&r.attr("data-a",n.r),r.append($("<span></span>").addClass("movenum").text(n.n+("w"==n.c?".":"..."))),r.append(G(n)),a.children().last().append(r)}return a}function N(t,e,a){var r,s;return $(".section.p-bestplay",t).length||(t.append($("<div></div>").addClass("section empty p-overview")),t.append($("<div></div>").addClass("gist empty").append($("<div></div>").addClass("section empty p-bestplay"),$("<div></div>").addClass("section empty p-movefuncs"))),t.append($("<div></div>").addClass("section empty p-goodmoves")),t.append($("<div></div>").addClass("section empty p-threats")),t.append($("<div></div>").addClass("section empty p-attacks"))),a.o&&$(".p-overview.empty",t).length&&(s=$(".section.p-overview",t),Y(r=$(a.o)),s.empty().append(r.children()).removeClass("empty")),a.b&&$(".p-bestplay.empty",t).length&&(s=$(".section.p-bestplay",t),Y(r=H(e,a.b,i.best_play_hdr)),s.empty().append(r.children()).removeClass("empty"),$(".gist",t).removeClass("empty")),a.f&&$(".p-movefuncs.empty",t).length&&(s=$(".section.p-movefuncs",t),r=function(t,e){var a=$("<div></div>");e&&a.append($("<div></div>").addClass("hdr").text(e+":"));var r=$(t).filter(".bpmf-cont");return $(".mf-hdr",r).addClass("clk is-hdr").next().addClass("foldable").hide(),$(".move.sentinel",r).html($("<span>&#9899;</span>").addClass("in-sentinel")),a.append(r),a}(a.f,null),$(".section.p-bestplay .hdr",t).first().text(i.explaining_best_line),Y(r),s.empty().append(r.children()).removeClass("empty"),it(s),Z($(".reasons",s)),$(".gist",t).removeClass("empty")),a.g&&$(".p-goodmoves.empty",t).length&&(s=$(".section.p-goodmoves",t),Y(r=O(a.g,i.Good_Moves)),s.empty().append(r.children()).removeClass("empty")),a.t&&$(".p-threats.empty",t).length&&(s=$(".section.p-threats",t),Y(r=O(a.t,i.Threats)),s.empty().append(r.children()).removeClass("empty")),a.a&&$(".p-attacks.empty",t).length&&(s=$(".section.p-attacks",t),Y(r=O(a.a,i.player_plans_hdr)),s.empty().append(r.children()).removeClass("empty")),t}var V=$(n);function B(){var t=$(".dcpath",V);if(!(t.length<1)){var e=0==(t=t[0]).scrollLeft,a=t.scrollLeft>=t.scrollWidth-t.offsetWidth,r=$(".bestcont-body",V);e?$(".si-left",r).hide():$(".si-left",r).show(),a?$(".si-right",r).hide():$(".si-right",r).show()}}function K(t){if(t){var e=$(".summary-res .dcpath");if(e&&e.length){var a=e[0],r=e.data("scroll_target")||a.scrollLeft;r+=Math.floor(68*t/53),r=Math.max(0,Math.min(r,a.scrollWidth-a.offsetWidth)),e.data("scroll_target",r);var s={left:r+"px",top:"+=0px"};e.stop(!0,!1).scrollTo(s,280,{onAfter:B})}}}function Y(t){$(".move[data-fena]",t).addClass("clk"),$("[data-a]",t).addClass("clk")}V.on("click",".more-items-btn",function(t){t.stopPropagation();var e=$(t.target);e.siblings(".ovf,.overflow").removeClass("ovf-hidden").show(200),e.siblings(".less-items-btn").show(200),e.hide(200)}),V.on("click",".less-items-btn",function(t){t.stopPropagation();var e=$(t.target);e.siblings(".ovf,.overflow").addClass("ovf-hidden").hide(200),e.siblings(".more-items-btn").show(200),e.hide(200)}),V.on("click",".innards",function(t){$("#topcontainer>.innards-popup").remove(),$("#topcontainer").append($("<div>").addClass("innards-popup").css({position:"absolute",zIndex:"200",border:"2px solid #f60",borderRadius:"10px",wordBreak:"break-all",top:"10px",left:"10px",width:"90%",height:"250px",whiteSpace:"pre-wrap",background:"#fff",padding:"6px"}).append($("<div>").css({height:"auto",fontFamily:"sans-serif",fontSize:"16px",whiteSpace:"pre-wrap",position:"relative",width:"100%",height:"100%",overflow:"auto",padding:"10px"}).text($(this).attr("title").replace(/ ---/g,"\n---"))).append($("<div>").addClass("close-btn").text("x").css({position:"absolute",top:"1px",right:"1px",width:"20px",height:"20px",cursor:"pointer",border:"2px solid #f86",color:"#b60",lineHeight:"14px",fontFamily:"sans-serif",textAlign:"center",borderRadius:"20px",backgroundColor:"#fff"}))),$("#topcontainer>.innards-popup .close-btn").on("click",function(t){$("#topcontainer>.innards-popup").remove()})}),V.on("click",".partial-results .move[data-fena]",function(t){e.key_focus="output";var a=$(this);t.stopPropagation(),a.attr("data-fena")&&(e.setFen(a.attr("data-fena")),e.currTab.setjp("p",e.curr_fen,"",null,a.text(),"")),u(a),$(".partial-results .move.active-move").removeClass("active-move"),a.addClass("active-move")}),V.on("click",".partial-results .gist .mf-hdr, .partial-results [data-a]",function(t){var a=$(this);e.key_focus="output",t.preventDefault(),t.stopPropagation(),e.dismiss_popups("hard",t),u(a)}),V.on("click",".results-cont .si-left",function(t,e){K(-110)}),V.on("click",".results-cont .si-right",function(t,e){K(110)}),V.on("click",".results-cont .is-hdr:not(.reasons-hdr)",function(t,a){t.preventDefault(),t.stopPropagation(),e.dismiss_popups("hard",t),e.key_focus="output";var r=$(this).parent();(r.hasClass("idea")||r.hasClass("problem")||r.hasClass("solution"))&&e.onReset(),u(this,"open"==a?"open":null),(r.hasClass("summary-attention")||r.hasClass("summary-threats")||r.hasClass("thr-in-sum")||r.hasClass("good-because-plan mid-item"))&&e.force_arrows_change++,e.$apply()}),V.on("click",".results-cont .ops",function(t){t.stopPropagation(),e.key_focus="output";var a=$(this);if(a.next().is(":visible")){if(a.nextAll().hide(200).index(l)>-1){for(;a.length&&!a.hasClass("move");)a=a.prev();a.length&&u(a,"open")}}else a.nextAll().show(200)}),V.on("click",".dgame-cont .reasons .mf-hdr",function(t){}),V.on("click",".dgame-cont .move[data-fena]",function(t){e.key_focus="output";var a=$(this);t.stopPropagation(),a.attr("data-fena")&&(e.setFen(a.attr("data-fena")),e.currTab.setjp("p",e.curr_fen,"",null,a.text(),"")),u(a),$(".dgame-cont .move.active-move").removeClass("active-move"),a.addClass("active-move")}),V.on("click",".results-cont .see-the-best, .results-cont .dgame.dcpath-intro, .dgame-cont .user-move .best-play > .title, .tutor-cont .user-move .best-play > .title",function(t){t.stopPropagation(),e.key_focus="output",$(t.target).parent().children().toggle(200),e.$apply()}),V.on("click",".results-cont .func-res .mf-hdr",function(t){t.stopPropagation(),e.key_focus="output",W([]),e.$apply()}),V.on("click",".results-cont .ehdr",function(t){t.stopPropagation(),e.key_focus="output",e.$apply()}),V.on("click",".results-cont .comment",function(t){t.stopPropagation(),e.key_focus="output";var a=y(this);a.length&&c(a)}),V.on("click",".results-cont .movenum",function(t){t.stopPropagation(),e.key_focus="output";var a=g(this);a.length&&(c(a),u(a,"open"))}),V.on("click",".results-cont .path .move",function(t){t.stopPropagation(),e.key_focus="output",u(this,"open"),e.$apply()}),V.on("click",".athr-l > li, .cthr-l > li, .uthr-l > li, .atk-l > li",function(t){t.stopPropagation(),e.key_focus="output",W([]),$("[data-a]",$(this)).each(function(t,e){W(($(e).attr("data-a")||"").split(";"),!0)}),e.$apply()}),V.on("click","UL.plan > li",function(t){e.key_focus="output",u($(this))}),V.on("click",".like-hdr",function(t){t.stopPropagation(),e.key_focus="output",u(this),e.$apply()}),V.on("click",".user-move-ex-placeholder .btn.upgrade",function(t){t.stopPropagation(),a.go("upgrade",!0)}),V.on("click",".user-move-ex-placeholder .learn_more",function(t){t.stopPropagation(),a.go("umove_learn_more",!0)}),V.on("click",".like-btn, .dislike-btn",function(t){t.stopPropagation();var a=e.currTab,r=a.currJob,s=$(t.target),n=s.hasClass("like-btn")?"like-explanation":"dislike-explanation",o=s.closest(".like-btns-cont"),i=`${o.attr("context")}:g=${a.game};fen=${r.fen}`;e.ga(n,i,""),o.hide(200)}),V.on("wheel",".dcpath",function(t){t.stopPropagation(),t.preventDefault(),K(t.originalEvent.deltaY)});var Q={fen:"",parts:""};function X(t){t.append($("<div>").addClass("btn clk more-items-btn").text(i.More___)),t.append($("<div>").addClass("btn clk less-items-btn").text(i.less).hide())}function Z(t,e,a){e||(e=2),a||(a=3),t.each(function(t,r){var s=$(r).children();if(!(s.length<=a)){var n=s.filter(function(t){return t>=e});X($(r)),n.addClass("ovf").addClass("ovf-hidden").hide()}})}function tt(t){X(t.parent()),t.addClass("ovf-hidden").hide()}function et(t,e){var a=$("<div>").addClass("like-btns-cont").append($("<div>").addClass("like-btn icon clk")).append($("<div>").addClass("dislike-btn icon clk")).attr("context",e).attr("role","button");t.append(a)}function at(t,e){t.find("[data-clk],[data-fold]").each(function(t,a){a=$(a),a.attr("data-clk")?a.attr("data-clk",a.attr("data-clk")+e):a.attr("data-fold",a.attr("data-fold")+e)})}function rt(t,e,a,r,s){$(".adv2",t).prepend('<div class="result-alg-ver"></div>'),e&&$(".result-alg-ver",t).text("v."+e),$(".summary-good-because",t).addClass("gist").removeClass("summary-good-because");var n=$(".gist",t);if(0==$(".good-because-plan",t).length){var o=$(".summary-intentions .plan",t).not(".plan .plan");o.length>0&&(o=o.clone(),$("[data-a]",o).removeAttr("data-a").removeAttr("data-e"),n.append(o))}var d=$(".four-title",t);d.closest(".gist").length||d.closest(".user-move").length||(d.addClass("top-hdr is-hdr foldable clk").prepend($("<div></div>").addClass("result-reset")),d.parent().addClass("mid-item"),$(".t3",d).addClass("top-hdr"),A(d,t).hide()),$(".summary-intro2",t).prepend(n),$(".summary-intro2",t).prepend($(".adv2",t));var l=$(".bestcont",t);0==n.closest(".bestcont").length&&n.prepend(l),et(n,"best line");var c=function(t,e){var a=t.clone();a.addClass("framed").find("LI[data-e]").each(function(t,e){var a=$(".threat-func",e).length,r=$(".threat-func > .path",e),s=$(".undermine",e);a>s.length+r.length&&(r.closest(".threat-func").remove(),s.closest(".threat-func").remove())}),a.find("LI[data-e]").addClass("thr-in-sum"),a.find("LI[data-e]").children(".mf-hdr").addClass("cnw"),$(".mf-hdr[data-w]",a).addClass("cnw");var r={};return $(".summary-threats.mid-item > .summary-t > LI.asum[data-a]",e).each(function(t,e){var a=$(e).attr("data-a").split(",")[2];if(!(a.length<6)){var s=a.substr(0,5);r[s]||(r[s]=[]),_.contains(r[s],a)||r[s].push(a)}}),$(".thr-in-sum > .athr[data-a]",a).each(function(t,e){var a=$(e).attr("data-a").split(","),s=r[a[2]];if(s){var n=_.map(_.first(s,2),function(t){return a[2]=t,a.join(",")});$(e).attr("data-a",n.join(";"))}}),at(a,"-summthr19"),a.attr("data-topic",""),a.removeClass("threatsb-res").removeClass("topic").addClass("threats").prepend($("<div></div>").text(i.Major_threats_hdr).addClass("title")),et(a,"threats"),a}(a,t);c&&n.after(c),s.addClass("framed"),n.after(s),et(s,"deep user move"),$(".summary-bestcont > .mf-hdr,.bestcont-hdr",t).removeClass("mf-hdr").addClass("like-hdr"),A($(".mf-hdr",t).addClass("is-hdr clk foldable"),t).hide(),$(".dcpath",t).before($("<div>&#8230;</div>").addClass("si-left clk")).after($("<div>&#8230;</div>").addClass("si-right clk"));var p=function(t){var e=$("<div></div>").addClass("summary-roles");return $("[data-e]",t).each(function(t,a){var r=$(".ehdr",$(a).closest(".piece")).clone();$(".weights",r).remove();var s=(a=$(a).clone()).attr("data-e");a.removeAttr("data-e");var n=$("<div></div>").addClass("results-inner as-popup").attr("data-e",s).append(r).append(a);e.append(n)}),at(e,"-summrol73"),e.hide(),e}(r);p&&t.append(p)}function st(t){$("*",t).finish(),$(".partial-results",t).empty(),$(".summary-cont",t).empty(),$(".threats-before-cont",t).empty(),$(".threats-after-cont",t).empty(),$(".good-moves-cont",t).empty(),$(".attacks-cont",t).empty(),$(".functionality-cont",t).empty(),$(".concepts-cont",t).empty()}function nt(a,r){var s,o=$(n);if("results"!==o.attr("id"))return{type:"cancel"};if(!a)return st(o),Q.fen="",Q.parts="",{type:"no-change"};if("working"==a.state){if(!a.partial)return{type:"no-change"};Q.fen!=r.jparam.fen&&(st(o),Q.fen=r.jparam.fen,Q.parts="");var i=$(".partial-results",n);Q.fen=r.jparam.fen,Q.parts=a.parts;var d=a.partial;return d&&N(i,a.fen,d),r.partial_arrows=(s=[],$(".partial-results [data-a]").each(function(t,e){var a=$(e).attr("data-a");a&&s.push("partial "+a)}),s),{type:"partial"}}"answered"!=a.state&&"complete"!=a.state||(Q.fen="");var l=a.html;return null===l&&null!==r.dom?r.dom:l?(r.dom=function(a){var r=$("<div></div>").attr("id","temproot").css("display","none");if(r.append(a),$(".dshort-best-move",r).length>0){var s=$('<div class="summary-res topic">').append($(".dshort-best-move",r).addClass("framed")).append($(".user-move-cont",r).addClass("framed"));return $(".sentinel",s).addClass("in-sentinel"),$(".mf-paths",s).addClass("inner-ul"),A($(".mf-hdr",s).addClass("is-hdr clk foldable"),r).hide(),it(s),$(".user-move-cont",s).addClass("framed"),{type:"short",summary:s}}$("BR",r).remove(),e.currentUser&&"admin"===e.currentUser.level||$(".weights,.dbg",r).remove();$(".hdr:not(.reasons-hdr)",r).hide(),$(".op",r).hide(),$("IMG.ops.symbol",r).attr("src","/static001767/assets/img/delta.png"),$(".sentinel",r).empty().append($('<span class="in-sentinel">&#9899;</span>')),e.lang_dir=function(t){var e=$(".langdir",t).attr("data-dir");return"rtl"!=e&&(e="ltr"),e}(r);var n,o,i,d,l,c,p,u,f,m=function(t){var e=$(".algver",t),a="";return e.length?a=e.text():((a=$(".main.hdr",t).text().replace(/^.*Analysis produced by algorithm version /,"").replace(/\].*/,"")).length<=0||a.length>10)&&(a=""),a=a.replace(/^0*/,"")}(r);n=$(".summary-inner",r),u=$(".user-move-cont",r),f=r,$("ul+h3",f).remove(),i=$(".athr-l",f),d=$(".cthr-l,.uthr-l",f),r.append('<div class="attacks-res"></div>'),(c=$(".attacks-res",r)).append($(".atk-l",r)),o=$($(".effects .piecefunc",r).parent()),p=$(".cn",r),n.addClass("summary-res topic").attr("data-topic","summary"),i.addClass("threatsb-res topic").attr("data-topic","threats_before"),d.addClass("threatsa-res topic").attr("data-topic","threats_after"),0==(l=$(".goodmoves",r)).length?(l=$('<div class="good-res topic" data-topic="goodmoves"></div>')).append($(".anl",r)):l.addClass("good-res topic").attr("data-topic","goodmoves");c.addClass("attacks-res topic").attr("data-topic","attacks"),o.addClass("func-res topic").attr("data-topic","functionality"),p.addClass("concepts-res topic").attr("data-topic","concepts"),$("H3.athr",r).remove(),function(t){$(".threx",t).map(function(t,e){var a=$(e),r=$(a.children("ul")[0]);if(r.length&&!r.hasClass("inner-ul"))r.children("li").addClass("threat-func");else{var s=a.children(),n=$("<ul></ul>"),o=$('<li class="threat-func"></li>');o.append(s),a.text()&&o.prepend(a.text()),n.append(o),a.empty(),a.append(n)}}),$(".threats_before > UL > LI > .mf-hdr",t).next().hide()}(i),rt(n,m,i,o,u);var v=$($('div[data-e="i000"]',n).find(".path .move")[1]);e.currTab.currJob.analyzed_move_san=v.text();var b=v.attr("data-fena");e.currTab.currJob.fenAfterAnalyzedMove=b,e.currTab.currJob.analyzed_move_color=b&&-1==b.indexOf(" b ")?"b":"w";var g="w"==e.currTab.currJob.analyzed_move_color?"white":"black";$(".summary-threats li",n).addClass("white"==g?"bmove":"wmove"),$(".mf-hdr, .ehdr, .hdr, .cn-kind, .mv-hdr, .atk, .athr, .cthr, .uthr, .t3",r).addClass("top-hdr").addClass("is-hdr").filter(".top-hdr .top-hdr,.top-hdr + * .top-hdr").removeClass("top-hdr"),$("LI > .mf-hdr",i).each((t,e)=>{A(e,r).hide()}),$("LI > .mf-hdr",d).each((t,e)=>{A(e,r).hide()}),$("LI .mv-hdr",l).each((t,e)=>{A(e,r).hide()}),A($(".is-hdr:not(.top-hdr)",r),r).addClass("foldable").hide(),$(".t3",r).addClass("unfoldable").next().show(),t(function(){h($(".best-play.path .sentinel").first())},8),ot($(".thr-in-sum .mf-hdr",n).first(),n);var _=$(".atk",c);1==_.length&&ot(_,c);$(".is-hdr:not(.reasons-hdr)",r).addClass("clk"),$(".gist .pplan",r).removeClass("clk");var y=$("<div></div>").addClass("result-reset");$(".func-res .op.clk",r).hide(),$(".func-res .hdr",r).show(),$(".func-res .piececoncepts",r).hide(),function(t){$(".good-moves-li",t).prepend(y.clone()),$(".is-hdr",t).addClass("mf-hdr"),$(".good-moves-li > [data-e]",t).each(function(t,e){(e=$(e)).parent().attr("data-e",e.attr("data-e")),e.removeAttr("data-e")})}(l),A($(".mf-hdr",r),r).addClass("inner-ul"),$(".func-res .mf-hdr",r).prepend(y.clone()),$(".summary-res .mf-hdr:not(.athr)",r).prepend(y.clone()),$(".summary-res .mf-nohdr",r).prepend(y.clone()),$(".ops ~ SPAN",r).hide(),$(".ops",r).addClass("clk"),A($(".cn-kind",r),r).addClass("inner-ul").hide(),$(".cn-kind",r).addClass("clk").prepend(y.clone()),$(".ehdr",r).filter(function(t,e){return!$(e).closest(".as-popup").length}).addClass("clk").prepend(y.clone()),A($(".pc-cn .hdr",r),r).addClass("inner-inner-ul").hide(),$(".pc-cn .hdr",r).addClass("inner-hdr").addClass("clk"),$(".summary-roles .hdr,.summary-roles .ehdr",n).removeClass("clk").show(),$(".summary-roles .foldable",n).removeClass("foldable").show(),$(".attacks-res .atkex .t3-cont",r).map(function(t,e){$(e).prepend(y.clone())}),$(".threatsa-res .threx .t3-cont",r).map(function(t,e){$(e).prepend(y.clone())}),$(".threat-func",r).map(function(t,e){$("UL",e).length||$(e).addClass("like-hdr")}),$(".threatsb-res .threx .threat-func:not(.cnw) .is-hdr",r).prepend(y.clone()),$(".threatsb-res .threx:not(.cnw) .threat-func.like-hdr",r).prepend(y.clone()),$(".threatsa-res .threx .threat-func:not(.cnw) .is-hdr",r).prepend(y.clone()),e.mobile||it(r);var C=$(".overflow",r);C.length?tt(C):(Z($(".mf-paths,.inner-ul",n).not(".summary-attention > .inner-ul")),Z($(".reasons",n),4,6),Z($(".mf-kids",n)),Z($(".threats > UL",n),3,5),Z($(".user-move .mfuncs",n),3,5),Z($(".threx.cnw > UL",n)),Z($(".piecefuncs .piececoncepts",o),4,6),Z($(".mf-paths,.inner-ul",i)),Z($(".threx.cnw > UL",i)),Z($(".mf-paths,.inner-ul",d)),Z($(".mf-paths,.inner-ul",o)),Z($(".mf-paths,.inner-ul",p)));return{type:"full",summary:n,threats_before:i,threats_after:d,good_moves:l,attacks:c,functionality:o,concepts:p}}(l),a.html=null,r.dom):{type:"no-change"}}function ot(t,e){$(t).addClass("opened"),A(t,e).show()}function it(t){$(".mf-weight[data-w]",$(t)).each(function(t,e){e=$(e);var a=1+parseInt(e.attr("data-w"))/10;e.css("border-left-width",a+"px"),e.prev().hide()})}e.setup_pre_dgame=function(a){t(()=>a.pre_dgame=new o.PreDgame(a,e.game_stats),3e3)},e.process_short_decode=function(t,a,r){var s=r.game.moves,n=$("<div></div>").addClass("dgmf-cont").hide();if(n.attr("data-e",a),r.dom.append(n),n.append($("<div></div>").addClass("reasons")),(n=n.children().first()).append($("<div></div>")),n=n.children().first(),t){n.html(t);var o=$(".dgame-best-cont",n),d=$(".user-move",n);if(!o.length){n.prepend($("<div></div>").addClass("dgame-best-cont"));var l=$(".dgame-title",n),c=l.next();o.append(l,c)}$(".dgame.dcpath-cont > .dcpath-intro",n).addClass("clk"),$(".dgame.dcpath-cont > *",n).hide(),$(".dgame.dcpath-cont",n).prepend($("<div></div>").addClass("see-the-best clk").text(i.See_the_best_play)),$(".user-move-cont .best-play > .title",n).addClass("clk"),$(".user-move-cont .best-play > *",n).hide(),$(".user-move-cont .best-play",n).prepend($("<div></div>").addClass("see-the-best clk").text(i.See_the_best_cont));var p=$(".user-move-ex-placeholder",n);p.append($("<div></div>").addClass("col").append($("<div></div>").addClass("user-move-is-premium").text(i.user_move_is_premium)).append($('<div role="button"></div>').addClass("btn big upgrade").text(i.Upgrade)).append($('<div role="button"></div>').addClass("learn_more clk").text(i.Learn_more)));var u=s.findIndex(function(t){return t.ex_id===a});$(".with-next-move",n).remove(),e.mobile?$(".mf-weight",n).before($("<div>").addClass("result-reset")):it(n),$(".mf-nohdr",n).addClass("is-hdr");var h=$(".mf-hdr",n);h.addClass("clk is-hdr"),h.next("UL").hide(),$(".sentinel",n).empty().append($("<span>&#9899;</span>").addClass("in-sentinel")),function(t,e){var a=e.game.moves,r="-",s="";t.each(function(t,e){var n=(e=$(e)).attr("data-fena");if(n!=r){r=n;var o=_.findIndex(a,function(t){return t.fen==r});if(-1==o)return;s=a[o].from+" "+a[o].to}e.attr("data-ft",s)})}($(".sentinel",n),r);var f=$(".overflow",n);if(f.length?tt(f):Z($(".user-move .mfuncs",n),3,5),function(t,e,a,r,s){if(r<0&&t.game.body[0].ex_id!=e&&(r=null),null!==r){var n=$(".played-move",s);if(n.empty(),a[r+1]){var o=a[r+1].from+" "+a[r+1].to;n.attr("data-ft",o).append(a[r+1].san)}}}(r,a,s,u,n),function(t){$(".dcpath-intro:not(.dgame)",t).addClass("is-hdr unfoldable")}(n),function(t,e,a){var r=$(".user-move",a).attr("data-q"),s=$(".dgame-best-cont .explained_mv",a).attr("data-em"),n=t[e+1];n&&(n.exp_qual=r,n.exp_best=s)}(s,u,n),!p.length){var m=$(".dgame-best-cont + .user-move-cont",n);m.length&&o.insertAfter(m)}et(d,"user move"),et(o,"best move")}else n.append($("<div></div>"))},e.dgame_add_ex_elements=function(t,a){a.dom||(a.dom=$("<div></div>")),_.each(t,function(t,r){e.process_short_decode(t,r,a)})},e.onOutputClick=function(){e.key_focus="output"},e.$watch("currTab.currJob",function(){B(),M(null)}),e.$watch("currTab.decode_game_job.dom",function(t){var a=$("#results .dgame-cont");$("*",a).finish(),a.empty(),t&&a.append(t),e.show_decode_game_explanation&&e.currTab&&e.currTab.game&&e.show_decode_game_explanation(e.currTab.game.curr_move)}),e.$watchGroup(["currTab.currJob.result","currTab.currJob.result.fen","currTab.currJob.result.parts","currTab.currJob.result.partial"],function(t,e,a){if(a.currTab){var r=t[0],s=a.currTab.currJob,o=$(n);if(s&&"working"!=s.state&&st(o),s&&s.jparam&&("position"==s.jparam.type||"move"==s.jparam.type)){r&&(r.state=s.state,s.result_is_new=!1);var i=nt(r,s);"full"!=i.type&&"short"!=i.type||(s.dom=i,"full"==i.type?function(t,e){var a=$(".forewords"),r=$(".foreword-threats-before",a),s=$(".foreword-threats-after",a),n=$(".foreword-good-moves",a),o=$(".foreword-attacks",a),i=$(".foreword-functionality",a),d=$(".foreword-concepts",a);st(t),$(".summary-cont",t).append(e.summary),e.what_about&&$(".summary-cont",t).append(e.what_about),$(".threats-before-cont",t).append(r.clone(),e.threats_before),$(".threats-after-cont",t).append(s.clone(),e.threats_after),$(".good-moves-cont",t).append(n.clone(),e.good_moves),$(".attacks-cont",t).append(o.clone(),e.attacks),$(".functionality-cont",t).append(i.clone(),e.functionality),$(".concepts-cont",t).append(d.clone(),e.concepts),B()}(o,i):function(t,e){st(t),$(".summary-cont",t).append(e.summary),B()}(o,i),$(".results-cont").scrollTop(s.display_state.scroll),s.topic||(s.topic="summary"))}}}),e.$watch("currTab.tutor.enabled",function(t){if(void 0!==t&&!e.mobile){var a=e.currTab;!0===t?(a.play_mode.switch_mode("tutor",e.curr_fen),a.tutor.hide_why()):e.currTab.play_mode.switch_mode("assisted",e.curr_fen),e.force_arrows_change++}}),e.output_area_on_key=function(t){var a=e.currTab.currJob;if(!a||!a.result&&"game"!=a.jparam.type)return!1;var s={},n=e.lang_dir&&"rtl"==e.lang_dir;s[r.LEFT]=n?q:z,s[r.RIGHT]=n?z:q,s[r.UP]=D,s[r.DOWN]=F,s[r.HOME]=S,s[r.END]=U;var o=s[t.keyCode];return!(!o||!o())&&(t.preventDefault(),!0)};var dt=function(t,e){var a=$(".curr-explanation",t);if(a&&a.length){var r=null;a[0].classList.forEach(function(t){t.startsWith("ref-")&&(r=t)}),r&&setTimeout(function(){$("."+r,e).children().first().trigger("click",["open"])},10)}};e.selectTopic=function(t){var a=e.currTab;M(null),a.currJob&&"threats_after"!=t&&e.setFen(a.currJob.fen),"threats_before"==t?(a.threats_status_now=!0,dt($(".threatsa-res"),$(".threatsb-res"))):"threats_after"==t?(a.threats_status_now=!1,e.setFen(a.currJob.fenAfterAnalyzedMove),dt($(".threatsb-res"),$(".threatsa-res"))):"curr_move"==t&&a.game.curr_move.ex_id&&e.show_decode_game_explanation&&e.show_decode_game_explanation(a.game.curr_move),W([])},e.$watch("currTab.currJob.topic",function(t,a){t&&t!==a&&e.selectTopic(t)}),e.$watch("curr_fen",function(t,e){if(t!==e){var a=l;a.hasClass("move")&&(a.attr("data-fena")===t?a.addClass("active-move"):(a.removeClass("active-move"),function(t,e){var a=null;(e=e||l).hasClass("move")&&$(".move[data-fena]",$(e).closest(".path")).each(function(e){if($(this).attr("data-fena")==t)return u(this),a=this,!1})}(t)))}}),e.$watch("currTab.threats_status_now",function(t){if(e.currTab){var a=e.currTab.currJob;a&&(t&&"threats_after"==a.topic?a.topic="threats_before":t||"threats_before"!=a.topic||(a.topic="threats_after"))}}),"results"===d.id&&(e.$on("pos-reset",function(){e.currTab&&e.currTab.currJob&&"position"===e.currTab.currJob.jparam.type&&(h($("#results .dcpath .move.sentinel")),"summary"===e.currTab.currJob.topic&&M(null))}),e.$on("Esc",function(t,e){W([])}));var lt=0;function ct(t){var a;if(e.mobile_p){var r=window.innerWidth-4,s=window.innerHeight-(r+35+5+4);a={w:r,h:s,bref:"top-left",dx:0,dy:window.innerHeight-s,tip_dx:0,tip_dy:10}}else{var n=e.board.get_sq_location(t);a={tip_dx:n.dim/8,tip_dy:n.top/7-n.dim/2,dx:7*n.dim-n.left+25,dy:(n.top-3.5*n.dim)/2.5}}return a}var pt={close_btn:2,css_class:"responsive thin",hide_cb:function(t){"close"==t&&(b=!1),d3.select("path.arrow-blip.blip").classed("blip",!1)},on_click:function(t){var a=$(t.target).closest(".move").attr("data-fena");a&&e.setFen(a)}};function ut(){return Object.assign(ct(),{opts:Object.assign({},pt,{absolute:1}),tipsel:".right-side .decode-btn-cont:not(.clone)",tipref:"left"})}e.showArrowInfo=function(a){if("results"===n.attr("id")){var r=$(a).attr("data-c")||$(a).parent().attr("data-c"),o=$(a).closest(".square-55d63").attr("data-square");if(r){var i=r.split(" ");s.select_arrows_by_eids(i),t.cancel(lt),lt=t(function(){var t=e.currTab.currJob?e.currTab.currJob.topic:"nosuch";i.forEach(function(r){if(r){var s=$('#results [data-topic="'+t+'"] [data-e~="'+r+'"]');if(e.mobile_p){d3.select("path.arrow-blip.blip").classed("blip",!1),d3.select(a.parentElement).select("path.arrow-blip").classed("blip",!0);var n=ut();if(s.hasClass("as-popup")){var i=ct();return void e.bubble.show(s.clone(),i.w,i.h,i.bref,i.dx,i.dy,n.opts,n.tipsel,n.tipref,i.tip_dx,i.tip_dy)}$(".explanation-bubble").trigger("bubble-transclude",[n,t=>{$(".summary-cont",t).addClass("summary-res").empty().append(s.clone())}])}else if(s.hasClass("as-popup")){s=s.clone();i=ct(o);return b=!0,void e.bubble.show(s.clone(),510,160,"left",i.dx,i.dy,pt,"#board1 .square-"+o,"right",i.tip_dx,i.tip_dy)}e.currTab&&e.currTab.currJob&&"threats-before"==e.currTab.currJob.topic&&(s=s.last());var d=s.find(".is-hdr,.like-hdr").first();if(d.length)d.trigger("click",["open"]);else{var l=L(s);l.length?l.trigger("click",["open"]):s.trigger("click",["open"])}}})},50)}else if(e.mobile_p&&$(a).closest("svg").attr("class").match(/\b(dg-played|dg-best)\b/)){var d=$("#results .results-inner").clone();return void $(".explanation-bubble").trigger("bubble-transclude",[ut(),t=>{$(".dgame-cont",t).empty().append(d.clone())}])}var l=$(a).attr("data-aa")||$(a).parent().attr("data-aa");if(l){var c=_.map(l.split(" "),function(t){var e=t.split("-"),a=e[0].toUpperCase();return{variant:"transient",piece:(a!=e[0]?"b":"w")+a,source:e[1],destination:e[2]}}),p=c[0];c.unshift({variant:"blink",piece:p.piece,source:p.source,destination:p.source}),e.board.startGhostAnims(c)}}};function ht(){var t=e.currTab;if(t){var a=t.currJob;if(!a)return t.topic_arrows=[],void p();a.fen==e.curr_fen&&a.partial_arrows;var r=a.baseFen();if(e.curr_fen!=r||e.uprefs.hide_arrows)t.topic_arrows=[];else if("game"!=a.jparam.type){var n=[];switch(a.topic){case"summary":n=function(){var t=[],a=$("#results .summary-res [data-a]");if(a=a.not("#results .gist .good-because-plan[data-a]"),1!=e.intro.curr_step&&2!=e.intro.curr_step){var r=!0;s.get_arrow_roles_disp("base")||(a=a.not("#results .summary-res .bestcont"),r=!1);var n=s.get_arrow_roles_disp("attention")||$("#results .summary-attention > .mf-hdr.opened").length>0;n||(a=a.not(".summary-attention [data-a]"));var o=$("#results .summary-threats > .mf-hdr.opened").length>0;o||(a=a.not(".summary-threats [data-a]")),s.get_arrow_roles_disp("threat")||(a=a.not("#results .summary-res .threats-before [data-a]"+(r?":gt(0)":"")+":not(.opened)"));var i=s.get_arrow_roles_disp("findbest")||$("#results .good-because-plan.mid-item .top-hdr.opened").length>0;i||(a=a.not("#results .good-because-plan.mid-item [data-a]"))}return a.each(function(e,a){var r=$(a).attr("data-a");r&&(r="summary "+r.replace(/;/g,";summary "),t.push(r))}),t}();break;case"concepts":break;case"threats_before":$("#results .threatsb-res .athr[data-a]").each(function(t,e){var a=$(e).attr("data-a");a&&n.push("threat "+a)});break;case"threats_after":$("#results .threatsa-res [data-a]").each(function(t,e){var a=$(e).attr("data-a");a&&n.push("cthreat "+a)}),$("#results .threatsa-res .uthr[data-a]").each(function(t,e){var a=$(e).attr("data-a");a&&n.push("uthreat "+a)});break;case"functionality":$("#results .func-res UL.piecefuncs>LI").each(function(t,e){var a;$(e).hasClass("player")&&(a="player"),$(e).hasClass("oppo")&&(a="oppo");var r=$(e).attr("data-a");r=(r=(r=r.split(";")).map(function(t){return a+" "+t})).join(";"),n.push(r)});break;case"goodmoves":$("#results .good-res .gmv[data-a],#results .good-res .gmvnew[data-a]").each(function(t,e){var a=$(e).attr("data-a");a&&(a=(a=(a=a.split(";")).map(function(t){return"gmov "+t})).join(";"),n.push(a))});break;case"attacks":0,$("#results .attacks-res .atk[data-a]").each(function(t,e){var a=(e=$(e)).attr("data-a");0==a.split(",")[0].length&&(a="attack"+a);var r=a.split(","),s=e.hasClass("opened"),o=$("[data-a]",A(e));0==o.length?n.push(a):o.each(function(t,e){$(e).attr("data-a").split(";").forEach(function(t){var e=t.split(",");e[0].match(/plan/)?(r[2]=e[2],r[3]=r[3]+" "+e[3],t=r.join(","),n.push(t)):s&&n.push(t)})})})}t.topic_arrows=n,p()}else t.topic_arrows=function(t,e){var a=[],r=$("#results .dgame-cont .pgn-selected .bad-pmove[data-ft],#results .dgame-cont .pgn-selected .user-move-cont [data-ft]").first();return r.each(function(t,e){var r=(e=$(e)).attr("data-ft");if(r){var s="dg-played";_.each(["blunder","mistake","inaccuracy","good-move"],function(t){e.hasClass(t)&&(s+=" "+t)}),a.push(s+",35,"+r+",,")}}),(r=$("#results .dgame-cont .pgn-selected .pmove-ne-emove [data-ft],#results .dgame-cont .pgn-selected .good-pmove[data-ft]"+(!1===e?"":",#results .dgame-cont .pgn-selected .dgame-best-cont [data-ft]")).first()).each(function(t,e){var r=$(e).attr("data-ft");r&&a.push("dg-best,45,"+r+",,")}),a}(0,!t.tutor.enabled||t.tutor.move_is_best)}}e.$watchGroup(["uprefs.hide_arrows","currTab.currJob.topic","curr_fen","currTab.currJob.result"],ht),e.$watch("force_arrows_change",()=>{ht();var t=$("#results .summary-res .active-move");t.length&&R(t)}),e.setActiveElement=function(t){u(t,"open")},t(function(){$(".threats-status-btn-cont",n).removeClass("right")},1e3),e.output_area_initialized=!0}}}]);
