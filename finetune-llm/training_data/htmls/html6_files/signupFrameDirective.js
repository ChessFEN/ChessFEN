chessStories.directive("appSignupFrame",[function(){return{restrict:"EA",scope:{shown:"=",popup:"="},templateUrl:"/static001767/app/shared/signupFrame/signupFrameView.html",controllerAs:"signupFrame",controller:["$scope","$element","$timeout","$interval","Config","Kbd","i18nService","websiteService","authService",function(e,s,n,r,t,a,o,i,l){var u=this;e.shown=!1,e.step=0,e.nSteps=4,e.signingUp=!1,e.i18n=o.phrases,e.app="web"!==t.platform,e.showPassword=!1,e.showPassword2=!1,e.err={fullname:null,email:null,password:null,passwordConfirm:null,tos:null,general:null},e.tosHref=i.get_url_for("tos"),e.userDetails={fullname:"",email:"",password:"",contactConsent:!0},e.passwordConfirm="",e.tosAgreed=!1;var p=$(".carousel-item"),d=$(),m=null;function w(e){n(function(){e.focus()},370)}u.show_next=function(e){d.removeClass("current"),(d=d.next(".carousel-item")).length||(d=p.first()),d.addClass("current"),!0===e&&m&&(r.cancel(m),m=null)},u.show_prev=function(e){d.removeClass("current"),(d=d.prev(".carousel-item")).length||(d=p.last()),d.addClass("current"),!0===e&&m&&(r.cancel(m),m=null)},e.$watch("shown",function(e){!0===e&&w($(".form-step:first-child INPUT"))}),e.hide=function(s){s&&s.stopPropagation(),e.step=0,e.shown=!1},e.onShowPswdMousedown=function(s){s&&s.stopPropagation(),2===e.step?e.showPassword=!0:3===e.step&&(e.showPassword2=!0)},e.onShowPswdMouseup=function(s){s&&s.stopPropagation(),e.showPassword=e.showPassword2=!1},e.onSignUpBtn=function(n){n&&n.stopPropagation();var r=e.step;if(0===r)e.userDetails.fullname.length?(e.err.fullname=null,e.step++,w($("INPUT.email",s))):e.err.fullname=e.i18n.must_name;else if(1===r)e.userDetails.email&&e.userDetails.email.length<=80&&/[\w.%-]+@\w+\..+/.test(e.userDetails.email)?(e.err.email=null,e.step++,w($("INPUT.password",s))):e.err.email=e.i18n.email_invalid;else if(2===r)e.userDetails.password.length>=8?(e.err.password=null,e.step++,w($("INPUT.password2",s))):e.err.password=e.i18n.must_password;else if(3===r)if(e.passwordConfirm.length&&e.userDetails.password===e.passwordConfirm)if(e.tosAgreed){if(u.signing_up)return;e.signingUp=!0,_.mapObject(e.err,e=>null),l.signup(e.userDetails).then(function(s){var n=s.data;"usertaken"===n.status||"emailtaken"===n.status?(e.step=1,e.err.email=e.i18n.email_taken):"userinvalid"===n.status||"emailinvalid"===n.status?(e.step=1,e.err.email=e.i18n.email_invalid):"error"===n.status||"flood"===n.status?e.err.general=e.i18n.Signup_failed:"ok"===n.status&&(e.hide(),e.popup.showText(e.i18n.Thanks_joining,!1,2050)),e.signingUp=!1})}else e.err.passwordConfirm=null,e.err.tos=e.i18n.Pls_agree_tos;else e.err.passwordConfirm=e.i18n.password_doesnt_match},e.onKeydown=function(s){s.keyCode!==a.ENTER&&s.keyCode!==a.TAB||(s.stopPropagation(),s.preventDefault(),e.onSignUpBtn(s))}}],link:function(e,s){var n=$(".signup-form .tos LABEL"),r=e.i18n.agree_tos.match(/({.*})/);n.text(r.input.replaceAll(r[0],"")),n.append($('<a href="'+e.tosHref+'">'+r[0].replaceAll(/[{}]/g,"")+"</a>"))}}}]);
