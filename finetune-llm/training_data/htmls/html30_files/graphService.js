chessStories.service("graphService",["recommendService","i18nService",function(e,t){var n=t.phrases,i=null;var r=function(e,t){this.tab=e,this.interest_nest=0,this.curr_idx=null,this.working_on_mv=null};function o(e){return 0==e?0:(e<0?-1:1)*((e=.01*Math.abs(e))+Math.sqrt(e+1)-1)/2}r.prototype.condRender=function(){if(s){var e=this.tab,t=e.game,n=t.body,r=[n[0]];r=r.concat(e.game.moves);var a=_.filter(n,e=>Game.is_variant(e)),c=-.01,u=.01;_.each(r,function(e){_.isFinite(e.score)&&!_.isFinite(e.y)&&(e.y=o(e.score)),_.isFinite(e.y)&&(c=Math.min(c,e.y),u=Math.max(u,e.y))});var d,h=_.filter(r,function(e){return e.job&&"complete"==e.job.state||"complete"==e.state}),f=_.filter(a,function(e){return!!t.iter_items(function(e){return e.job&&"complete"==e.job.state||"new"==e.state},e)}),m=_.filter(r,function(e){return e.job&&("working"==e.job.state||"new"==e.job.state)}),b=_.filter(a,function(e){return!!t.iter_items(function(e){return e.job&&("working"==e.job.state||"new"==e.job.state)},e)}),p=[],v=l(c),x=l(u),g=this.working_on_mv,y=_.map(r,function(t,n){var i;return e.key_moments.indexOf(t)>=0&&p.push(n),g===t?(i={enabled:!0,symbol:"circle",color:"#99ccff",radius:6},t.active&&(i.lineWidth=1,i.lineColor="#665544")):i=t.active?{enabled:!0,symbol:"circle",color:"white",lineColor:"#665544",lineWidth:2}:{enabled:!1},{name:t.name,fen:t.fen,score:t.score,y:.98*Math.max(v,Math.min(x,t.y)),color:i.color,marker:i}});d="#6ecef7";var k=_.map(p,function(e,t){return{value:e,color:d,width:1,zIndex:3,id:"a-"+t}});d="#eedc00",k=(k=k.concat(_.map(m,function(e,t){return{value:e.index_number+1,color:d,width:1,zIndex:4,id:"a-"+(100+t)}}))).concat(_.map(b,function(e,n){return{value:t.main_line_move(e[0]).index_number+1,color:d,width:1,dashStyle:"longdash",zIndex:4,id:"a-"+(100+n)}})),d="#ff9900",k=(k=k.concat(_.map(h,function(e,t){return{value:e.index_number+1,color:d,width:1,zIndex:5,id:"a-"+(200+t)}}))).concat(_.map(f,function(e,n){return{value:t.main_line_move(e[0]).index_number+1,color:d,width:1,dashStyle:"longdash",zIndex:5,id:"a-"+(200+n)}})),d="#b0b0b0",t.in_main_line()||k.push({value:t.main_line_move().index_number+1,color:d,width:1,dashStyle:"longdash",zIndex:6,id:"cml"});var w=$("BODY").hasClass("darkmode")?"#999999":"#eeeeee";i=this,s.update({series:[{data:y}],yAxis:{startOnTick:!1,endOnTick:!1,min:v,max:x},xAxis:{plotLines:k},chart:{backgroundColor:w}})}};var a=[o(180),o(216),o(260),o(310),o(370)];function l(e){for(var t=e<0?-1:1,n=Math.abs(e),i=0;i<a.length;i++)if(n<=a[i])return t*a[i];return t*o(450)}var s,c=!1,u=!1,d=null;return r.prototype.select=function(e){_.isObject(e)&&(e=e.index_number-1);var t=s.series[0].data;null!==e&&e>=0&&e<t.length?this.curr_idx=e:t.length>0&&(this.curr_idx=null),this.condRender()},r.prototype.get_openings=function(t,n,i){if(t){var r=_.findIndex(i,function(e){return!("opcode"in e)});if(!(r<0)){var o=r?i[r-1].fen:n,a=_.rest(i,r);e.opnames(t,o,a,function(e,t){t&&_.each(a,function(e,n){n++,e.opcode=t.codes[n],e.opname=t.names[n]})})}}},{Graph:r,score2y:o,reflow:function(){s&&s.reflow()},initGraph:function(e){s=Highcharts.chart("graph",{title:null,legend:{enabled:!1},tooltip:{backgroundColor:"#ffffff",borderRadius:9,borderColor:"#7cb5ec",style:{fontSize:12},split:!0,formatter:function(){var e=[i.tab.game.body[0]];e=e.concat(i.tab.game.moves);var t=Math.max(e.length,8);if(this.x>2*t/3?u=!0:this.x<1*t/3&&(u=!1),this.x<0||this.x>=e.length)return"";var r,o=e[this.x],a=Math.floor((this.x-1)/2)+1+((this.x-1)%2?"...":".");if(o.name&&o.name.endsWith("#"))r=n.checkmate;else if(Math.abs(o.disp_score)>9e4)r=o.score_str||n.mate_in+" "+Math.floor((1e5-Math.abs(o.disp_score))/2);else{var l=o.disp_score/100;r=(l>0?"+":"")+l}var s="";o.disp_depth&&(s="<br>(depth "+o.disp_depth+")");var c=null;o.job&&"complete"==o.job.state||"complete"==o.state?c=n.Decoded:i.tab.key_moments.indexOf(o)>=0&&(c=n.Insight);var h=c?"<br><b>"+c+"</b>":"";return d=this.x,(this.x?a+o.name:"âš«")+" <b>"+r+"</b>"+s+h},positioner:function(e,t,n){var i=$("#game-map").height(),r=2*(i-25)/5,o=3*(i-25)/5,a=u?Math.max(n.plotX-e-20,-8):n.plotX+20;return!c&&n.plotY<r?c=!0:c&&n.plotY>o&&(c=!1),{x:a,y:c?i-16-t:8}}},chart:{spacing:[8,3,1,4],backgroundColor:"#eeeeee",events:{click:function(t){null!==d&&e(d-1)}},height:null},credits:{enabled:!1},yAxis:{title:null,opposite:!0,gridLineWidth:0,labels:{style:{fontSize:11},formatter:function(){var e=function(e){if(0==e)return 0;var t=e<0?-1:1;return e=Math.abs(e),t*Math.round(50*(4*e+3-Math.sqrt(8*e+9)))}(this.value);return(e>0?"+":"")+e/100},x:2}},xAxis:[{title:null,lineWidth:0,tickColor:"#00000000",allowDecimals:!1,softMax:30,labels:{style:{fontSize:11},formatter:function(){return Math.floor(this.value/2)+1},reserveSpace:!1,y:6}}],series:[{type:"area",animation:!1,allowPointSelect:!0,color:"#7cb5ec",cursor:"pointer",marker:{enabled:!1},lineWidth:2,fillColor:"#ffffff",negativeFillColor:"#666666",point:{events:{click:function(){e(this.x-1)}}},data:[]}]})}}}]);
