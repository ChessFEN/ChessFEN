"use strict";chessStories.directive("appOpenDlg",["themeService",function(e){var n={};return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/openDlg/openDlgView.html",controllerAs:"open",link:function(e,n,t){$("#open-dlg",n).draggable({appendTo:"body",containment:"window",cancel:"#open-dlg .open-dlg-body",scroll:!1,zIndex:99})},controller:["$scope","$rootScope","$element","$timeout","gameService","pgnSplitterService","importGameService","i18nService","Kbd","acctService",function(e,t,a,s,o,i,l,r,m,g){var p=this,c=r.phrases;e.preview=n,window.File&&window.FileReader&&window.FileList&&window.Blob?e.can_read_files=!0:e.can_read_files=!1,p.loading=!1,p.game_origin=null,p.pgn_sections=null,p.show_games_list=!1,p.user_paste="",p.pasted_fen=null,p.show_may_take_a_while=!1,p.show_details=!1,p.next_key="",p.example_games=[],p.examples_read_at=0;var u,d,f,h=e.currentUser.prefs;function v(n,t,a){e.popupMsg.showText(n,t,a)}function w(n,t){e.$broadcast("preview-set",[n,t])}function x(){p.ginfos_from_pgn.length>0?p.chooseGame(p.ginfos_from_pgn[0]):w(null,-1),s(function(){$("#open-dlg .games-list-cont-cont").focus()},10)}function G(e,n,t){p.loading=!0,i.splitMultiGamePgn(e,function(e,a,s){p.loading=!1,e?t&&t(e):(p.pgn_sections=a,p.ginfos_from_pgn=s,p.show_games_list=!0,x(),n&&n())})}p.lichess_username=h.lichess_user||"",p.chesscom_username=h.chesscom_user||"",p.username=null,p.selected_ginfo=null,p.selected_game=null,p.name_edited_game=null,p.orig_game_name=null,p.showOnDrag=!0,p.expectingDrop=!1,p.openImportDlg=function(){p.nav_state="import"},window.onOpenFileChange=function(){var e=$('.file-cont INPUT[type="file"]',a)[0];p.uploadFile(e.files)},p.openExamplesDlg=function(e){p.nav_state="examples",p.showExampleGames(e)},p.get_game_orientation=function(n){var t=this.username,a=e.currentUser&&e.currentUser.login_name||"guest";return n.orientation([t,a])},u=$("[app-open-dlg] .drop-zone"),d=null,f=function(e){v(c.error_in_pgn_msg,!1,4e3),t.ga("import","parse-pgn-error","")},u.bind("dragover",function(e){e.preventDefault()}),u.bind("drop",function(n){n.preventDefault(),n.stopPropagation(),p.expectingDrop=!1;var a=n.dataTransfer,s=n.originalEvent.dataTransfer,o=a&&a.files||s&&s.files||null;if(!o||!o[0]){for(var i=s.items,l=0;l<i.length;l++)"string"==i[l].kind&&i[l].type.match("^text/plain")&&i[l].getAsString(function(e){p.user_paste=e});return!1}var r=o[0],_=new FileReader;return _.onload=function(n){e.$apply(function(){t.ga("import","drop-file",n.name),G(_.result,d,f)})},_.readAsText(r),!1}),p.onLichessUserBlur=function(e){l.parseLichessURL(p.lichess_username)||g.setUserPrefs({lichess_user:p.lichess_username})},p.onLichessImport=function(n){n.stopPropagation(),p.loading=!0,p.username=null,l.importFromLichess(p.lichess_username,function(n){p.loading=!1,null!==n?0!=n.length?(p.ginfos_from_pgn=n,p.game_origin=Game.OR_LICHESS,p.username=p.lichess_username,p.show_games_list=!0,x()):e.popupMsg.showText(c.no_lichess_games,!1,4500):e.popupMsg.showText(c.failed_to_import,!1,4500)})},p.onChesscomUserBlur=function(e){g.setUserPrefs({chesscom_user:p.chesscom_username})},p.onChessComImport=function(n){n.stopPropagation(),p.loading=!0,p.username=null,l.getChesscomRecentGames(p.chesscom_username,function(n){p.loading=!1,null!==n?0!=n.length?(p.ginfos_from_pgn=n,p.game_origin=Game.OR_CHESSCOM,p.username=p.chesscom_username,p.show_games_list=!0,x()):e.popupMsg.showText(c.no_chesscom_games,!1,4500):e.popupMsg.showText(c.failed_to_import,!1,4500)})},e.$watch("open.import_source",function(n){var t=e.currentUser.prefs;p.lichess_username=t.lichess_user||"",p.chesscom_username=t.chesscom_user||"",$(".lichess-cont,.chesscom-cont,.file-cont,.paste-cont").hide(300);var a=$("."+n+"-cont");a.show(330),$("INPUT,TEXTAREA",a).focus()}),p.onBack=function(e){e.preventDefault(),p.ginfos_from_pgn=[],p.pasted_fen=null,p.selected_ginfo=null,p.selected_game=null,p.user_paste="",p.game_origin=null,["open","import","paste"].includes(p.nav_state)?p.show_games_list=!1:p.show_games_list=!0},e.$watch("open.user_paste",function(e){p.paste_timeout&&s.cancel(p.paste_timeout),e&&(p.paste_timeout=s(function(){var n;(p.paste_timeout=null,p.pasted_fen=null,$("#user-paste").removeClass("invalid"),(n=(n=e).trim()).length<15||n.length>100||n.split("\n").length>2||(n=n.split(/[ \t\n\r]+/g)).length<4||n.length>8||!n[0].match(/^([0-9a-zA-Z]{0,10}\/){5}/))?!function(e){if((e=e.trim()).length<2)return!1;"["!=e[0]&&(e='[White "?"]\n[Black "?"]\n\n'+e);var n=new Game,t=!1;return n.parse(e,function(e,n,a){t=t||e!==Game.E_PGN_HAS_TAIL}),!t}(e)?$("#user-paste").addClass("invalid"):(t.ga("import","paste-pgn",""),G(e,function(){t.ga("import","paste PGN ok","")},function(e){$("#user-paste").addClass("invalid"),v(c.error_in_pgn_text_msg,!1,4e3),t.ga("import","paste PGN error","")})):(e=e.trim().replace(/\u2013|\u00ad|\u2010|\u2011|\u2012|\u2014|\u2214|\u2015/g,"-").replace(/[ \t\n]+/g," "),(new Chess).validate_fen(e).valid?(p.pasted_fen=e,t.ga("import","paste-fen",""),p.chooseGame(new Game(p.pasted_fen))):$("#user-paste").addClass("invalid"))},600))});var E=function(){return Math.floor(Date.now()/1e3)};function D(e){if(e.set_origin)return e;var n=e.index,t=p.pgn_sections[2*n]+"\n\n"+p.pgn_sections[2*n+1];return new Game(t)}p.getExamples=function(n){if(n){if(!(t=p.next_key))return}else{p.example_games=[];var t=""}p.example_games&&0!=p.example_games.length||(p.loading=!0,o.getExamples(t,1,function(e){p.loading=!1,p.next_key=e.next,p.example_games=e.games,p.examples_read_at=E(),p.example_games.length>0&&p.chooseGame(p.example_games[0])},function(n){p.loading=!1,e.popupMsg.showText(n,!1,4500)}))},p.uploadFile=function(n){if(e.can_read_files){var a=n[0];if(!a)return!1;var s=_.last(a.name.split("."));if("pgn"!=s&&"txt"!=s&&""!=a.type&&"text/plain"!=a.type)return e.popupMsg.showText(c.not_a_pgn_msg,!1,null),!1;var o=new FileReader;o.onload=function(){e.$apply(function(){G(o.result,function(){},function(e){v(c.error_in_pgn_msg,!1,4e3),t.ga("import","parse-pgn-error","")})})},o.readAsText(a)}else e.popupMsg.showText(c.cannot_read_files_msg,!1,null)},p.checkLast=function(){p.show_may_take_a_while=!1},p.showExampleGames=function(n){e.$broadcast("rebuild:me"),(n||E()-p.examples_read_at>46800)&&(p.example_games=[]),p.example_games.length?(p.next_key="",1==p.example_games.length&&p.chooseGame(p.example_games[0])):p.getExamples()},p.closeDlg=function(){e.show_open_dlg=!1,this.show_games_list=!1,this.game_origin=null,this.pgn_sections=null,this.ginfos_from_pgn=null,this.user_paste="",this.pasted_fen=null,this.show_may_take_a_while=!1,this.selected_ginfo=null,this.selected_game=null,this.selected_game_name="";var n,t=$('.file-cont input[type="file"]',$(a));t.length&&(t[0].value=""),e.popupMsg.dismiss(n)},p.set_origin=function(e){this.game_origin=e},p.openSelectedGame=function(n){var t=this,a=t.selected_game_name||c.Game,s=t.game_origin,i=null;if("user_file"==s)(i=D(t.selected_ginfo)).set_origin(Game.OR_FILE);else if(["import","lichess","chess.com"].includes(s))(i=D(t.selected_ginfo)).set_origin(Game.OR_IMPORT);else if(["example","history"].includes(s))i=D(t.selected_ginfo),"example"==s&&i.set_origin(Game.OR_EXAMPLE),function(n){return!!_.find(e.tabs,function(e){return e.game===n})}(i)||i.clear_answers();else if("pgn"==s||"pasted_pgn"==s)(i=D(t.selected_ginfo)).set_origin(Game.OR_PGN);else{if("pasted_fen"!=s||!t.pasted_fen)return void v(c.please_select_game_msg,!1,3100);(i=new Game(t.pasted_fen)).set_origin(Game.OR_FEN)}a&&(i.name=a,i.headers.CSGameName=a);var l=e.getPristineTab();e.selectTab(l);var r=e.ensure_unique_tab_name(a)||a;i.set_name(r),l.set_game(i),n&&l.hide_cards("decode"),l.board_orientation=t.get_game_orientation(i),i.moves&&0!=i.moves.length||l.setjp("p",i.headers.FEN,"",null,c.job_name_setup,""),o.save(i,"opened","",function(a){t.closeDlg(),n&&e.onDecode(null,"game")})},p.onCancelBtn=function(){p.closeDlg()},p.chooseGame=function(e){var t=this;if(!e)return t.selected_game=null,void(t.selected_game_name="");var a=e.name||e.CSGameName;"SetUp"===a&&(a=e.name=c.job_name_setup),a&&(t.selected_game_name=a),t.selected_ginfo=e,"examples"==t.nav_state?t.game_origin=Game.OR_EXAMPLE:"open"==t.nav_state?t.game_origin=Game.OR_FILE:"import"==t.nav_state?t.game_origin=Game.OR_IMPORT:"paste"==t.nav_state?t.game_origin=Game.OR_PGN:t.game_origin=null;var o=D(t.selected_ginfo);t.selected_game=o,s(function(){n.board.orientation(t.get_game_orientation(o))},1)},p.openDetails=function(){p.show_details=!0},p.closeDetails=function(){p.show_details=!1},p.onEditNameBtn=function(e,n){e&&e.stopPropagation();var t=p.name_edited_game;if(t&&t.$$hashKey===n.$$hashKey)return p.name_edited_game=null,void(p.orig_game_name=null);p.name_edited_game=n,p.orig_game_name=n.name||"?",s(function(){$(e.target).siblings("input").focus()},10)},$("BODY").on("dragenter",function(n){p.showOnDrag&&(e.dismiss_popups("hard",n),e.setUp&&e.setUp.hide(),e.mainMenu&&(e.mainMenu.openDlgClass="show-import"),e.show_open_dlg||(p.expectingDrop=!0,e.show_open_dlg=!0,p.openImportDlg()),p.import_source="paste",p.show_games_list=!1,w(null,-1))}),$("BODY").on("dragleave",function(n){s(function(){var t=n.originalEvent.clientX,a=n.originalEvent.clientY;(t<=0||a<=0||t>=window.innerWidth||a>=window.innerHeight)&&p.expectingDrop&&(e.show_open_dlg=!1,p.expectingDrop=!1)},50)}),$("BODY").on("dragstart",function(e){p.showOnDrag=!1}),$("BODY").on("dragend",function(e){p.showOnDrag||(p.showOnDrag=!0)}),e.$watch("mobile",function(e){e&&$("#open-dlg").css({top:"",left:""})}),p.onKey=function(n){var t=n.keyCode;return t==m.ESC?p.name_edited_game?(p.name_edited_game.name=p.orig_game_name,p.name_edited_game=null,e.ga(p.nav_state+"-dlg","stop-name-edit-by-Esc",""),!0):(e.ga(p.nav_state+"-dlg","close-by-Esc",""),p.onCancelBtn(),!0):t==m.ENTER&&(p.name_edited_game?(n.stopPropagation(),p.selected_ginfo.$$hashKey===p.name_edited_game.$$hashKey&&p.chooseGame(p.name_edited_game),p.name_edited_game=null,e.ga(p.nav_state+"-dlg","stop-name-edit-by-Enter",""),!0):(e.ga("open-game",p.nav_state,"Kbd.ENTER"),p.openSelectedGame(),!0))},e.$emit("lazy-loaded",{module:"open"})}]}}]);
