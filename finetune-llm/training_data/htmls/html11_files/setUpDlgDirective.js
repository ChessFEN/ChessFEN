"use strict";angular.module("chessStories").directive("appSetUpDlg",[function(){return{restrict:"EA",scope:!1,templateUrl:"/static001767/app/shared/setUpDlg/setUpDlgView.html",controllerAs:"setUp",controller:["$scope","Fens","Kbd","fenService",function(n,e,o,t){var s=this,u=e.START;function l(n,e){var o=n.get(e);return o?o.color+o.type.toUpperCase():""}s.shown=!1,s.simple=!0,s.fen=e.START,s.undo_fen=null,s.sel_color="w",s.sel_piece="P",s.pos=e.START.split(" ",1)[0],s.turn="w",s.castling={wk:!0,wq:!0,bk:!0,bq:!0},s.ep_square="-",s.ep_menu_shown=!1,s.is_valid_ep=!0,s.rule50_clock=0,s.move_num=1,s.desired_castling={wk:!0,wq:!0,bk:!0,bq:!0},s.onUndo=function(e){e.stopPropagation(),s.undo_fen&&(s.fen=s.undo_fen,_(),n.setFen(s.fen),s.undo_fen=null)};const r=["a3","b3","c3","d3","e3","f3","g3","h3"],i=["a6","b6","c6","d6","e6","f6","g6","h6"];function c(n){var e=new Chess(n),o=[];return"b"==e.turn()?o=r.filter(function(n){return!e.get(n)&&!e.get(n[0]+"2")&&"wP"==l(e,n[0]+"4")}):"w"==e.turn()&&(o=i.filter(function(n){return!e.get(n)&&!e.get(n[0]+"7")&&"bP"==l(e,n[0]+"5")})),o.unshift("-"),o}function a(n,e,o){return n=parseInt(n),isNaN(n)&&(n=e),Math.max(e,Math.min(o,n))}function f(){var e,o=((e=s.castling).wk?"K":"")+(e.wq?"Q":"")+(e.bk?"k":"")+(e.bq?"q":"")||"-";s.rule50_clock=a(s.rule50_clock,0,99),s.move_num=a(s.move_num,1,999),s.fen=[s.pos,s.turn,o,s.ep_square,s.rule50_clock,s.move_num].join(" "),n.setFen(s.fen)}function _(){var n=s.fen.split(" ");s.pos=n[0],s.turn=n[1],s.castling.wk=n[2].includes("K"),s.castling.wq=n[2].includes("Q"),s.castling.bk=n[2].includes("k"),s.castling.bq=n[2].includes("q"),s.possible_ep_squares=c(s.fen),s.ep_square=n[3],s.is_valid_ep=s.possible_ep_squares.includes(s.ep_square),s.rule50_clock=+n[4],s.move_num=+n[5]}function p(n){return"w"==n?"b":"w"}s.show=function(){s.shown=!0,u=n.curr_fen,s.undo_fen=null,s.fen=n.curr_fen,_(),s.last_sq=null},s.hide=function(){return s.shown=!1,n.curr_fen!=u},s.onClose=function(n){s.hide()},s.selectPiece=function(n){s.sel_piece=n},s.onKey=function(n){s.shown&&(n==o.RIGHT?s.sel_piece="RNBQKP"["PRNBQK".indexOf(s.sel_piece)]:n==o.LEFT?s.sel_piece="KPRNBQ"["PRNBQK".indexOf(s.sel_piece)]:n!=o.UP&&n!=o.DOWN||(s.sel_color=p(s.sel_color)))},s.onSelColor=function(){s.sel_color=p(s.sel_color)},s.onClear=function(o){s.fen!=e.CLEAR_WITH_KINGS&&s.fen!=e.START&&(s.undo_fen=s.fen),s.fen=e.CLEAR_WITH_KINGS,n.setFen(s.fen),_()},s.onStartPos=function(o){s.fen!=e.CLEAR_WITH_KINGS&&s.fen!=e.START&&(s.undo_fen=s.fen),s.fen=e.START,n.setFen(s.fen),_()},s.isStartPos=function(){return s.fen==e.START},s.onMvChg=function(n){f()},s.onMvWheel=function(n,e,o,t){s.move_num=Math.max(1,Math.min(255,parseInt(s.move_num)+e)),f()},s.onCastling=function(n,e){s.castling[e]=!s.castling[e],f()},s.onCastlingEL=function(n,e){var o={wk:["e1","h1"],wq:["e1","a1"],bk:["e8","h8"],bq:["e8","a8"]}[n];o&&o.forEach(function(n){"e"==e?$("#board1 .square-"+n).addClass("setup-highlight"):$("#board1 .square-"+n).removeClass("setup-highlight")})},s.showEpMenu=function(n){n&&n.stopPropagation(),s.ep_menu_shown?s.ep_menu_shown=!1:(s.possible_ep_squares=c(s.fen),s.ep_menu_shown=!0)},s.onBgClick=function(n){n.stopPropagation(),s.ep_menu_shown=!1},s.onEpEnter=function(n){$("#board1 .square-"+n).addClass("setup-highlight")},s.onEpLeave=function(n){$("#board1 .square-"+n).removeClass("setup-highlight")},s.onSelEp=function(n,e){s.ep_square=e,f(),s.ep_menu_shown=!1},s.onR50Chg=function(n){f()},s.onR50Wheel=function(n,e,o,t){s.rule50_clock=Math.max(0,Math.min(99,parseInt(s.rule50_clock)+e)),f()},s.isClearPos=function(){return s.fen==e.CLEAR_WITH_KINGS},s.onTurn=function(n){s.turn="w"==s.turn?"b":"w",f()},s.onMore=function(n,e){s.simple=e},s.onClose=function(e){s.ep_menu_shown=!1;var o=n.currTab;n.exitSetUpMode(o);var t=o.game;t.moves&&t.moves.length||(t.initFromFen(s.fen),t.set_origin(Game.OR_SETUP),o.currJob=null)},s.getFen=function(){return s.fen},s.setFen=function(n){s.fen=n,_()},s.last_sq=null,s.onBoardClick=function(n,e){var o=s.sel_color+s.sel_piece;return e==o?s.last_sq==n?(s.last_sq=null,null):(s.sel_color=p(s.sel_color),s.last_sq=n,s.sel_color+s.sel_piece):(s.last_sq=null,o)};var g=null,h=null,d=null;function m(e){if(g){if(Math.abs(e.pageX-h)+Math.abs(e.pageY-d)>4){$("BODY").unbind("mousemove",m);var o=n.board.cboard;o.abortDrag(),o.beginDraggingPiece(g,e),g=null}}else $("BODY").unbind("mousemove",m)}s.onPieceMDown=function(e){var o=$(e.target).attr("data-p");o&&(e.preventDefault(),g=s.sel_color+o,h=e.pageX,d=e.pageY,$("BODY").on("mousemove",m),setTimeout(function(){if(g){var o=n.board.cboard;o.abortDrag(),o.beginDraggingPiece(g,e),g=null}},350))},s.onPieceMUp=function(n){g=null},n.$watch("curr_fen",function(n){s.shown&&n!=s.fen&&(s.fen=n,_())}),"ontouchstart"in document.documentElement&&$(".set-up-dlg").on("touchstart",".piece",function(n){n.preventDefault(),s.onPieceMDown(n)}),n.$emit("lazy-loaded",{module:"setUp"})}],link:function(n,e,o){$(".set-up-dlg",e).draggable({containment:"document",cancel:".dlg-inner",scroll:!1})}}}]);
